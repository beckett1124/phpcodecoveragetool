<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Spike PHPCoverage Details: usercontroller.php</title> 
    <link href="../../../../..//css/spikesource.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="pageBox" >

      <table border="0" cellpadding="2" cellspacing="0" id="contentBox" width="100%">
        <tr>
          <td align="left" valign="top"><h1>Spike PHPCoverage Details: usercontroller.php</h1>
          </td>
        </tr>
        <tr>
          <td>

<table width="100%" border="0" cellpadding="2" cellspacing="0"><td width="10%"class="coverageDetailsHead" >Line #</td><td width="10%" class="coverageDetailsHead">Frequency</td><td  width="80%" class="coverageDetailsHead">Source Line</td><tr><td class="coverageDetails"><span>1</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&lt;?php</span></code></td></tr><tr><td class="coverageDetails"><span>2</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">3</span></td><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">define(&quot;PASSWORD_MIN_LENGTH&quot;,&nbsp;8);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">4</span></td><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">define(&quot;ASSET_TYPE_DOC&quot;,&nbsp;&quot;D&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">define(&quot;ASSET_TYPE_BADGE&quot;,&nbsp;&quot;B&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">6</span></td><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">define(&quot;ASSET_TYPE_KEY&quot;,&nbsp;&quot;K&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">7</span></td><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">define(&quot;BADGE_CODE_EXPIRATION&quot;,&nbsp;120);</span></code></td></tr><tr><td class="coverageDetails"><span>8</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//define(&quot;FILE_UPLOAD_DESTINATION&quot;,&nbsp;&quot;user_image/&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">9</span></td><td class="coverageDetails"><span class="codeExecuted">5</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">define(&quot;PASSWORD_MD5_ENCRYPT_LENGTH&quot;,&nbsp;32);</span></code></td></tr><tr><td class="coverageDetails"><span>10</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>11</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>class&nbsp;UserController&nbsp;extends&nbsp;FWController&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>12</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>13</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//used&nbsp;to&nbsp;check&nbsp;whether&nbsp;the&nbsp;image_type&nbsp;is&nbsp;valid</span></code></td></tr><tr><td class="coverageDetails"><span>14</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;protected&nbsp;&nbsp;static&nbsp;$s_img_type&nbsp;=&nbsp;array('profile',&nbsp;'signature',&nbsp;'initials');</span></code></td></tr><tr><td class="coverageDetails"><span>15</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>16</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//accept&nbsp;a&nbsp;POST&nbsp;request&nbsp;with&nbsp;input&nbsp;as&nbsp;{&quot;email&quot;:&quot;sanminliu@gmail.com&quot;,&nbsp;&quot;password&quot;:&nbsp;&quot;12341234&quot;,&nbsp;&quot;first_name&quot;:*,&nbsp;&quot;last_name&quot;:*,&nbsp;&quot;phone&quot;:*,&nbsp;&nbsp;...}</span></code></td></tr><tr><td class="coverageDetails"><span>17</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;create($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">18</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">19</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>20</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">21</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">22</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>23</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">24</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$fb_id&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span>25</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//sign-up&nbsp;with&nbsp;photo</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">26</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(strncasecmp($_SERVER['CONTENT_TYPE'],&nbsp;'multipart/form-data',&nbsp;strlen('multipart/form-data'))&nbsp;==&nbsp;0)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">27</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['email'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">28</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['password'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">29</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['first_name'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">30</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['last_name'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">31</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['phone'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">32</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$account_type&nbsp;&nbsp;=&nbsp;(&nbsp;$_POST['account_type']&nbsp;==&quot;confirmed&quot;&nbsp;?&nbsp;&quot;confirmed&quot;:&nbsp;&quot;provisional&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>33</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&nbsp;//sign-up&nbsp;without&nbsp;photo</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">34</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input());</span></code></td></tr><tr><td class="coverageDetails"><span>35</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;parse&nbsp;input&nbsp;fields</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">36</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">37</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;password;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">38</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;first_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">39</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;last_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">40</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;phone;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">41</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fb_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;fb_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">42</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$account_type&nbsp;=&nbsp;$input-&gt;account_type;</span></code></td></tr><tr><td class="coverageDetails"><span>43</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">44</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($email)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">45</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Email&nbsp;cannot&nbsp;be&nbsp;null!');</span></code></td></tr><tr><td class="coverageDetails"><span>46</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>47</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">48</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($email)&nbsp;&amp;&amp;&nbsp;!preg_match(&quot;/^[_A-Za-z0-9-]+(.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)+$/&quot;,&nbsp;$email))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">49</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;email&nbsp;address');</span></code></td></tr><tr><td class="coverageDetails"><span>50</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>51</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">52</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($first_name)&nbsp;||&nbsp;strlen($first_name)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">53</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('First&nbsp;name&nbsp;cannot&nbsp;be&nbsp;null!');</span></code></td></tr><tr><td class="coverageDetails"><span>54</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">55</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($last_name)&nbsp;||&nbsp;strlen($last_name)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">56</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Last&nbsp;name&nbsp;cannot&nbsp;be&nbsp;null!');</span></code></td></tr><tr><td class="coverageDetails"><span>57</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>58</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">59</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!&nbsp;Util::is_good_password($password)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">60</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadPasswordException('Not&nbsp;a&nbsp;good&nbsp;password');</span></code></td></tr><tr><td class="coverageDetails"><span>61</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>62</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>63</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/**</span></code></td></tr><tr><td class="coverageDetails"><span>64</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;(a)&nbsp;confirmed&nbsp;account:</span></code></td></tr><tr><td class="coverageDetails"><span>65</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check&nbsp;if&nbsp;the&nbsp;email/phone&nbsp;is&nbsp;new&nbsp;or&nbsp;not;</span></code></td></tr><tr><td class="coverageDetails"><span>66</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(1)&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;both&nbsp;new,&nbsp;create&nbsp;a&nbsp;new&nbsp;record&nbsp;in&nbsp;`account_email`,&nbsp;`account_phone`,&nbsp;`account`&nbsp;respectively;</span></code></td></tr><tr><td class="coverageDetails"><span>67</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2)&nbsp;&nbsp;&nbsp;&nbsp;else,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;merge&nbsp;account&nbsp;in&nbsp;`account_email`,&nbsp;`account`,&nbsp;`account_phone`&nbsp;respectively</span></code></td></tr><tr><td class="coverageDetails"><span>68</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;(b)&nbsp;provisional&nbsp;account:</span></code></td></tr><tr><td class="coverageDetails"><span>69</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check&nbsp;if&nbsp;email&nbsp;has&nbsp;been&nbsp;registered&nbsp;as&nbsp;usher&nbsp;account&nbsp;or&nbsp;not;</span></code></td></tr><tr><td class="coverageDetails"><span>70</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(1)&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;yes,&nbsp;return</span></code></td></tr><tr><td class="coverageDetails"><span>71</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2)&nbsp;&nbsp;&nbsp;&nbsp;else,&nbsp;&nbsp;&nbsp;create&nbsp;a&nbsp;new&nbsp;record&nbsp;in&nbsp;`account_email`,&nbsp;`account_phone`,&nbsp;`account`&nbsp;respectively</span></code></td></tr><tr><td class="coverageDetails"><span>72</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span>73</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>74</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//check&nbsp;if&nbsp;email&nbsp;has&nbsp;been&nbsp;tied&nbsp;to&nbsp;an&nbsp;existing&nbsp;account&nbsp;or&nbsp;not</span></code></td></tr><tr><td class="coverageDetails"><span>75</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//check&nbsp;one&nbsp;field&nbsp;in&nbsp;`account_email`:&nbsp;confirmed</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">76</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!User::check_availability_by_email($email,&nbsp;false))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">77</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerEmailExistException('This&nbsp;email&nbsp;already&nbsp;exists');</span></code></td></tr><tr><td class="coverageDetails"><span>78</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>79</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>80</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//deal&nbsp;with&nbsp;confirmed&nbsp;account</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">81</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($account_type&nbsp;==&nbsp;&quot;confirmed&quot;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>82</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//request&nbsp;can&nbsp;only&nbsp;be&nbsp;from&nbsp;internal&nbsp;IP</span></code></td></tr><tr><td class="coverageDetails"><span>83</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//deal&nbsp;with&nbsp;the&nbsp;existing&nbsp;user&nbsp;and&nbsp;new&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">84</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;internal_handle_create_user($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span>85</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>86</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//deal&nbsp;with&nbsp;provisional&nbsp;account&nbsp;,create&nbsp;a&nbsp;new&nbsp;account</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">87</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;handle_new_user($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span>88</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>89</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">90</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>91</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>92</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>93</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>94</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//just&nbsp;called&nbsp;by&nbsp;create()&nbsp;:used&nbsp;to&nbsp;deal&nbsp;with&nbsp;internal&nbsp;call</span></code></td></tr><tr><td class="coverageDetails"><span>95</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;internal_handle_create_user($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>96</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//request&nbsp;can&nbsp;only&nbsp;be&nbsp;from&nbsp;internal&nbsp;IP</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">97</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($_SERVER[&quot;REMOTE_ADDR&quot;]&nbsp;!=&nbsp;&quot;127.0.0.1&quot;&nbsp;&amp;&amp;&nbsp;!preg_match('/^10\.\d+\.\d+\.\d+$/',&nbsp;$_SERVER[&quot;REMOTE_ADDR&quot;]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">98</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;$_SERVER[&quot;REMOTE_ADDR&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">99</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">100</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerAdminPermissionDeniedException('No&nbsp;enough&nbsp;permmission&nbsp;to&nbsp;create&nbsp;a&nbsp;confirmed&nbsp;account');</span></code></td></tr><tr><td class="coverageDetails"><span>101</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">102</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_email&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">103</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_phone&nbsp;=&nbsp;User::find_by_phone($phone);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">104</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$is_new_user&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">105</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_email&nbsp;||&nbsp;$uvs_id_by_phone)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">106</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_new_user&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span>107</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>108</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">109</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">110</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>111</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">112</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$is_new_user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>113</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;old&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">114</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_email&nbsp;&amp;&amp;&nbsp;$uvs_id_by_phone)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">115</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;$this-&gt;internal_update_email_phone($uvs_id_by_email,&nbsp;$uvs_id_by_phone,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">116</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;($uvs_id_by_email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">117</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;$this-&gt;internal_update_email($uvs_id_by_email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">118</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;($uvs_id_by_phone)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">119</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;$this-&gt;internal_update_phone($uvs_id_by_phone,&nbsp;$email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span>120</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">121</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($user))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">122</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Cannot&nbsp;connect&nbsp;to&nbsp;database');</span></code></td></tr><tr><td class="coverageDetails"><span>123</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">124</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;user_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>125</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>126</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//create&nbsp;new&nbsp;user&nbsp;account</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">127</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;handle_new_user($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span>128</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">129</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>130</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>131</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>132</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//create&nbsp;a&nbsp;new&nbsp;account&nbsp;and&nbsp;add&nbsp;the&nbsp;profile&nbsp;photo</span></code></td></tr><tr><td class="coverageDetails"><span>133</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;handle_new_user($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">134</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">135</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($user))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">136</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Cannot&nbsp;connect&nbsp;to&nbsp;database');</span></code></td></tr><tr><td class="coverageDetails"><span>137</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">138</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>139</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">140</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">141</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;user_id&nbsp;=&nbsp;$uvs_id;</span></code></td></tr><tr><td class="coverageDetails"><span>142</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">143</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($_FILES['profile_photo'])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">144</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$this-&gt;add_profile_photo($uvs_id)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">145</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">146</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;error_message&nbsp;=&nbsp;&quot;Failed&nbsp;to&nbsp;upload&nbsp;your&nbsp;profile&nbsp;photo!&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>147</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>148</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">149</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>150</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>151</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>152</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//just&nbsp;for&nbsp;internal&nbsp;call&nbsp;:&nbsp;used&nbsp;to&nbsp;enable&nbsp;user's&nbsp;email&nbsp;and&nbsp;phone's&nbsp;login&nbsp;perimission</span></code></td></tr><tr><td class="coverageDetails"><span>153</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;internal_update_email_phone($uvs_id_by_email,&nbsp;$uvs_id_by_phone,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$fb_id,&nbsp;$account_type)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>154</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;`account_email`,&nbsp;`account_phone`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">155</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($password)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">156</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update_email_login_enabled($uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">157</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update_phone_login_enabled($uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span>158</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">159</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_email&nbsp;!=&nbsp;$uvs_id_by_phone)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">160</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::merge($uvs_id_by_email,&nbsp;$uvs_id_by_phone);</span></code></td></tr><tr><td class="coverageDetails"><span>161</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>162</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;user's&nbsp;info&nbsp;and&nbsp;do&nbsp;not&nbsp;insert&nbsp;new&nbsp;email&nbsp;and&nbsp;phone&nbsp;reocrd</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">163</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create(NULL,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;NULL,&nbsp;$fb_id,&nbsp;$account_type,&nbsp;$uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">164</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$user;</span></code></td></tr><tr><td class="coverageDetails"><span>165</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>166</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>167</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//just&nbsp;for&nbsp;internal&nbsp;call&nbsp;:&nbsp;used&nbsp;to&nbsp;enable&nbsp;user's&nbsp;email&nbsp;&nbsp;login&nbsp;perimission&nbsp;and&nbsp;insert&nbsp;a&nbsp;new&nbsp;phone&nbsp;reocrd</span></code></td></tr><tr><td class="coverageDetails"><span>168</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;internal_update_email($uvs_id_by_email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>169</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;`account_email`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">170</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($password)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">171</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update_email_login_enabled($uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span>172</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>173</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;user's&nbsp;info&nbsp;and&nbsp;insert&nbsp;a&nbsp;new&nbsp;phone&nbsp;reocrd</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">174</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create(NULL,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$phone,&nbsp;$fb_id,&nbsp;$account_type,&nbsp;$uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">175</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$user;</span></code></td></tr><tr><td class="coverageDetails"><span>176</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>177</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>178</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//just&nbsp;for&nbsp;internal&nbsp;call&nbsp;:&nbsp;used&nbsp;to&nbsp;enable&nbsp;user's&nbsp;phone's&nbsp;login&nbsp;perimission&nbsp;and&nbsp;insert&nbsp;a&nbsp;new&nbsp;email&nbsp;recount</span></code></td></tr><tr><td class="coverageDetails"><span>179</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;internal_update_phone($uvs_id_by_phone,&nbsp;$email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;$fb_id,&nbsp;$account_type)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>180</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;`account_phone`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">181</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($password)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">182</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update_phone_login_enabled($uvs_id_by_phone);</span></code></td></tr><tr><td class="coverageDetails"><span>183</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>184</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;user's&nbsp;info&nbsp;and&nbsp;insert&nbsp;a&nbsp;new&nbsp;email&nbsp;recount</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">185</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create($email,&nbsp;$password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;NULL,&nbsp;$fb_id,&nbsp;$account_type,&nbsp;$uvs_id_by_phone);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">186</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$user;</span></code></td></tr><tr><td class="coverageDetails"><span>187</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>188</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>189</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//update&nbsp;profile&nbsp;photo</span></code></td></tr><tr><td class="coverageDetails"><span>190</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;add_profile_photo($uvs_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>191</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;profile&nbsp;photo</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">192</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;validate_image($_FILES[&quot;profile_photo&quot;][&quot;name&quot;],&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;type&quot;],&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;tmp_name&quot;]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">193</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;name&quot;]));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">194</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$photo&nbsp;=&nbsp;file_get_contents($_FILES[&quot;profile_photo&quot;][&quot;tmp_name&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">195</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($photo)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">196</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$checksum&nbsp;=&nbsp;md5($photo);</span></code></td></tr><tr><td class="coverageDetails"><span>197</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">198</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;upload&nbsp;file');&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>199</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">200</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;=&nbsp;self::get_file_relative_path().&nbsp;$uvs_id&nbsp;.&nbsp;&quot;_&quot;&nbsp;.&nbsp;&quot;profile_&quot;&nbsp;.&nbsp;$checksum&nbsp;.&nbsp;'.'&nbsp;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">201</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;User::store_image($uvs_id,&nbsp;&quot;profile&quot;,&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;tmp_name&quot;],&nbsp;$dest);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">202</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$success;</span></code></td></tr><tr><td class="coverageDetails"><span>203</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>204</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>205</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>206</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;update($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">207</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">208</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>209</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">210</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span>211</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$uvs_id&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">212</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">213</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">214</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">215</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">216</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$app_id&nbsp;=&nbsp;$user-&gt;get_application_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">217</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">218</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>219</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;parse&nbsp;input&nbsp;fields</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">220</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strncasecmp($_SERVER['CONTENT_TYPE'],&nbsp;'multipart/form-data',&nbsp;strlen('multipart/form-data'))&nbsp;==&nbsp;0)&nbsp;{&nbsp;//change&nbsp;profile&nbsp;photo&nbsp;and&nbsp;others</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">221</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['email'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">222</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['password'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">223</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['first_name'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">224</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['last_name'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">225</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_POST['phone'];</span></code></td></tr><tr><td class="coverageDetails"><span>226</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">227</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">228</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;password;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">229</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;first_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">230</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;last_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">231</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;phone;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">232</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fb_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;fb_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">233</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fb_access_token&nbsp;=&nbsp;$input-&gt;fb_access_token;</span></code></td></tr><tr><td class="coverageDetails"><span>234</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>235</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">236</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($email)&nbsp;&amp;&amp;&nbsp;!preg_match(&quot;/^[_A-Za-z0-9-]+(.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)+$/&quot;,&nbsp;$email))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">237</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;email&nbsp;address');</span></code></td></tr><tr><td class="coverageDetails"><span>238</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">239</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($first_name)&nbsp;&amp;&amp;&nbsp;strlen($first_name)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">240</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('First&nbsp;name&nbsp;cannot&nbsp;be&nbsp;null!');</span></code></td></tr><tr><td class="coverageDetails"><span>241</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">242</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($last_name)&nbsp;&amp;&amp;&nbsp;strlen($last_name)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">243</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Last&nbsp;name&nbsp;cannot&nbsp;be&nbsp;null!');</span></code></td></tr><tr><td class="coverageDetails"><span>244</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>245</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">246</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($email);</span></code></td></tr><tr><td class="coverageDetails"><span>247</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$i_password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($password);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">248</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_first_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($first_name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">249</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_last_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($last_name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">250</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_phone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($phone);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">251</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_fb_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($fb_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">252</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_fb_access_token&nbsp;=&nbsp;$conn-&gt;escape($fb_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">253</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">254</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(User::check_availability_by_email($email,&nbsp;false)&nbsp;&amp;&amp;&nbsp;!User::find_by_email($email,&nbsp;FALSE,&nbsp;$uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>255</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;an&nbsp;un-confirmed&nbsp;email&nbsp;to&nbsp;`account_email`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">256</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;account_email(uvs_id,&nbsp;email,&nbsp;confirmed,&nbsp;login_enabled,&nbsp;creation_time)&nbsp;VALUES&nbsp;($uvs_id,&nbsp;$i_email,&nbsp;0,&nbsp;1,&nbsp;NOW())&quot;;&nbsp;//as&nbsp;long&nbsp;as&nbsp;user's&nbsp;password&nbsp;exist&nbsp;in&nbsp;`account`,&nbsp;login_enabled&nbsp;is&nbsp;1</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">257</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">258</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email_id&nbsp;=&nbsp;$conn-&gt;last_insert_id();</span></code></td></tr><tr><td class="coverageDetails"><span>259</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//ask&nbsp;Usher&nbsp;to&nbsp;send&nbsp;an&nbsp;email-confirmation&nbsp;request&nbsp;to&nbsp;that&nbsp;email&nbsp;address</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">260</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::send_email_code($email_id,&nbsp;$email,&nbsp;NULL,&nbsp;TRUE);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">261</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;email_id&nbsp;=&nbsp;$email_id;</span></code></td></tr><tr><td class="coverageDetails"><span>262</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">263</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerEmailExistException('This&nbsp;email&nbsp;already&nbsp;exists&nbsp;in&nbsp;the&nbsp;system');</span></code></td></tr><tr><td class="coverageDetails"><span>264</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>265</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">266</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($password)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">267</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!&nbsp;Util::is_good_password($password)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">268</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadPasswordException('Not&nbsp;a&nbsp;good&nbsp;password');</span></code></td></tr><tr><td class="coverageDetails"><span>269</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">270</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$user-&gt;get_pwd_exists())&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">271</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;update&nbsp;account_email&nbsp;set&nbsp;login_enabled&nbsp;=&nbsp;1&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;and&nbsp;confirmed&nbsp;=&nbsp;1&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">272</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>273</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//When&nbsp;set&nbsp;password&nbsp;first&nbsp;time,&nbsp;build&nbsp;default&nbsp;badge&nbsp;for&nbsp;him</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">274</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$default_org_id&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>275</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update/create&nbsp;default&nbsp;user&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">276</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_signed_badge&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$default_org_id,&nbsp;false);&nbsp;//It&nbsp;will&nbsp;reuse&nbsp;badgeid&nbsp;of&nbsp;`deleted`&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">277</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($old_signed_badge[0])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">278</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_badge_id&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">279</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_status&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_status();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">280</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expiration&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_expiration();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">281</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache_time&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_cache_time();</span></code></td></tr><tr><td class="coverageDetails"><span>282</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">283</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($badge_status&nbsp;!=&nbsp;'active'&nbsp;||&nbsp;$expiration&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$cache_time&nbsp;&lt;&nbsp;time())&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">284</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;build_default_user_badge($user,&nbsp;$app_id,&nbsp;$old_badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span>285</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>286</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//end&nbsp;of&nbsp;create&nbsp;default&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span>287</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>288</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//changed&nbsp;from&nbsp;MD5&nbsp;to&nbsp;crypt</span></code></td></tr><tr><td class="coverageDetails"><span>289</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;password&nbsp;=&nbsp;MD5($i_password)&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>290</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//User::update($conn,&nbsp;$query);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">291</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update_password($uvs_id,&nbsp;$password);</span></code></td></tr><tr><td class="coverageDetails"><span>292</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">293</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($first_name)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">294</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;first_name&nbsp;=&nbsp;$i_first_name&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">295</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>296</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">297</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($last_name)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">298</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;last_name&nbsp;=&nbsp;$i_last_name&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">299</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>300</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>301</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">302</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($phone)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>303</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;an&nbsp;un-confirmed&nbsp;phone&nbsp;to&nbsp;`account_phone`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">304</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;account_phone(uvs_id,&nbsp;phone,&nbsp;confirmed,&nbsp;login_enabled,&nbsp;creation_time)&nbsp;VALUES&nbsp;($uvs_id,&nbsp;$i_phone,&nbsp;0,&nbsp;1,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">305</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">306</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone_id&nbsp;=&nbsp;$conn-&gt;last_insert_id();</span></code></td></tr><tr><td class="coverageDetails"><span>307</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//ask&nbsp;Usher&nbsp;to&nbsp;send&nbsp;a&nbsp;sms-confirmation&nbsp;request&nbsp;to&nbsp;that&nbsp;phone&nbsp;number</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">308</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::send_sms_code($phone_id,&nbsp;$phone);</span></code></td></tr><tr><td class="coverageDetails"><span>309</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">310</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($fb_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">311</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;fb_id&nbsp;=&nbsp;$fb_id&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">312</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>313</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">314</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($fb_access_token)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">315</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;facebook_token&nbsp;SET&nbsp;fb_token&nbsp;=&nbsp;$i_fb_access_token&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;application_id&nbsp;=&nbsp;$app_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">316</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>317</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">318</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_FILES['profile_photo'])&nbsp;{&nbsp;//store&nbsp;profile&nbsp;image</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">319</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($_FILES['profile_photo']['error']&nbsp;&gt;&nbsp;0)</span></code></td></tr><tr><td class="coverageDetails"><span>320</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">321</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerDocCreateFailedException(&quot;receive&nbsp;photo&nbsp;failed&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>322</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">323</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;validate_image($_FILES[&quot;profile_photo&quot;][&quot;name&quot;],&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;type&quot;],&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;tmp_name&quot;]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">324</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;name&quot;]));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">325</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$photo&nbsp;=&nbsp;file_get_contents($_FILES[&quot;profile_photo&quot;][&quot;tmp_name&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">326</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($photo)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">327</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$checksum&nbsp;=&nbsp;md5($photo);</span></code></td></tr><tr><td class="coverageDetails"><span>328</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">329</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;upload&nbsp;file');&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>330</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">331</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;=&nbsp;self::get_file_relative_path().&nbsp;$user-&gt;get_uvs_id()&nbsp;.&nbsp;&quot;_&quot;&nbsp;.&nbsp;&quot;profile_&quot;&nbsp;.&nbsp;$checksum&nbsp;.&nbsp;'.'&nbsp;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">332</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!&nbsp;User::store_image($uvs_id,&nbsp;&quot;profile&quot;,&nbsp;$_FILES[&quot;profile_photo&quot;][&quot;tmp_name&quot;],&nbsp;$dest))</span></code></td></tr><tr><td class="coverageDetails"><span>333</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">334</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>335</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">336</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(substr($dest,&nbsp;0,&nbsp;4)&nbsp;!=&nbsp;'http'&nbsp;&amp;&amp;&nbsp;substr($dest,&nbsp;0,&nbsp;1)&nbsp;!=&nbsp;'/')</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">337</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;profile_photo_url&nbsp;=&nbsp;'/'.$dest;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">338</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;$response-&gt;profile_photo_url&nbsp;=&nbsp;$dest;</span></code></td></tr><tr><td class="coverageDetails"><span>339</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>340</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>341</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>342</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;default&nbsp;badge&nbsp;if&nbsp;first_name/last_name/profile_photo&nbsp;changed</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">343</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($first_name&nbsp;||&nbsp;$last_name&nbsp;||&nbsp;$_FILES['profile_photo'])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">344</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$default_org_id&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">345</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_signed_badge&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$default_org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">346</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($old_signed_badge[0])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">347</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">348</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;build_default_user_badge($user,&nbsp;$app_id,&nbsp;$old_signed_badge[0]-&gt;get_id());</span></code></td></tr><tr><td class="coverageDetails"><span>349</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>350</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>351</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">352</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">353</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>354</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">355</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>356</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>357</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>358</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>359</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//*****&nbsp;&nbsp;&nbsp;this&nbsp;function&nbsp;is&nbsp;just&nbsp;for&nbsp;INTERNAL&nbsp;USAGE!&nbsp;&nbsp;&nbsp;*****//</span></code></td></tr><tr><td class="coverageDetails"><span>360</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//*****&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADMINSTRATOR&nbsp;ONLY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*****//</span></code></td></tr><tr><td class="coverageDetails"><span>361</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;delete($args)&nbsp;{&nbsp;&nbsp;&nbsp;//delete&nbsp;a&nbsp;user,&nbsp;including&nbsp;all&nbsp;assets</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">362</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!Util::get_general_config(&quot;enable_account_management_by_qe&quot;)&nbsp;&amp;&amp;&nbsp;$_SERVER[&quot;REMOTE_ADDR&quot;]&nbsp;!=&nbsp;&quot;127.0.0.1&quot;&nbsp;&amp;&amp;&nbsp;!preg_match('/^10\.\d+\.\d+\.\d+$/',&nbsp;$_SERVER[&quot;REMOTE_ADDR&quot;]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">363</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerAdminPermissionDeniedException('No&nbsp;enough&nbsp;permmission&nbsp;to&nbsp;delete&nbsp;an&nbsp;account');</span></code></td></tr><tr><td class="coverageDetails"><span>364</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">365</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">366</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>367</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">368</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">369</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">370</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$passphrase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;passphrase;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">371</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($passphrase&nbsp;!=&nbsp;Util::get_general_config(&quot;account_management_passphrase&quot;))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">372</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;passphrase');</span></code></td></tr><tr><td class="coverageDetails"><span>373</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">374</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">375</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$uvs_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">376</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('User&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>377</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">378</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>379</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;all&nbsp;assets&nbsp;for&nbsp;this&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">380</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(User::delete($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">381</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>382</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">383</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>384</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">385</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>386</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>387</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>388</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;delete_me($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">389</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">390</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>391</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">392</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">393</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">394</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">395</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(User::delete($user-&gt;get_uvs_id()))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">396</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>397</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">398</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>399</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">400</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>401</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">402</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('User&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>403</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>404</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>405</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>406</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;send_confirmation_code($args)&nbsp;{&nbsp;&nbsp;//resend&nbsp;confirmation&nbsp;code</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">407</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">408</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>409</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">410</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">411</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">412</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">413</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>414</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">415</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">416</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">417</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;=&nbsp;User::is_emailid_belong_to_user($email_id,&nbsp;$uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">418</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">419</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidEmailIdException('Invalid&nbsp;email&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>420</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">421</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::send_email_code($email_id,&nbsp;$email,&nbsp;NULL,&nbsp;TRUE);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">422</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">423</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">424</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>425</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>426</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>427</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;reset_password($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">428</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">429</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>430</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">431</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">432</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$password_old&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;password_old;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">433</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$password_new&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;password_new;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">434</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$password_old&nbsp;||&nbsp;!$password_new)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">435</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>436</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">437</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!&nbsp;Util::is_good_password($password_new)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">438</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadPasswordException('Not&nbsp;a&nbsp;good&nbsp;password');</span></code></td></tr><tr><td class="coverageDetails"><span>439</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">440</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($password_new&nbsp;==&nbsp;$password_old){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">441</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerUpdateSamePasswordException(&quot;Please&nbsp;input&nbsp;the&nbsp;a&nbsp;new&nbsp;password&nbsp;that&nbsp;different&nbsp;from&nbsp;the&nbsp;previous&nbsp;one.&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>442</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>443</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">444</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">445</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">446</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">447</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">448</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">449</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span>450</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_password_old&nbsp;=&nbsp;$conn-&gt;escape($password_old);</span></code></td></tr><tr><td class="coverageDetails"><span>451</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/$i_password_new&nbsp;=&nbsp;$conn-&gt;escape($password_new);</span></code></td></tr><tr><td class="coverageDetails"><span>452</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;//changed&nbsp;MD5&nbsp;to&nbsp;crypt</span></code></td></tr><tr><td class="coverageDetails"><span>453</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;select&nbsp;*&nbsp;from&nbsp;account&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;password&nbsp;=&nbsp;MD5($i_password_old)&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>454</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($conn-&gt;select_first($query))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>455</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;password&nbsp;=&nbsp;MD5($i_password_new)&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>456</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>457</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>458</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>459</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>460</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException('The&nbsp;password&nbsp;you&nbsp;have&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;our&nbsp;records');</span></code></td></tr><tr><td class="coverageDetails"><span>461</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>462</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">463</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;select&nbsp;*&nbsp;from&nbsp;account&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">464</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password_hash&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">465</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">466</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($result)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">467</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strlen($result[&quot;password&quot;])&nbsp;==&nbsp;PASSWORD_MD5_ENCRYPT_LENGTH)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;//this&nbsp;is&nbsp;a&nbsp;md5&nbsp;encrypt&nbsp;password</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">468</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(md5($password_old)&nbsp;==&nbsp;$result[&quot;password&quot;])&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">469</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password_hash&nbsp;=&nbsp;$result[&quot;password&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>470</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>471</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">472</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($result[&quot;password&quot;]&nbsp;==&nbsp;crypt($password_old,&nbsp;$result[&quot;password&quot;]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">473</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password_hash&nbsp;=&nbsp;$result[&quot;password&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>474</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>475</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>476</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">477</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$password_hash)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">478</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException('The&nbsp;password&nbsp;you&nbsp;have&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;our&nbsp;records');</span></code></td></tr><tr><td class="coverageDetails"><span>479</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">480</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update_password($uvs_id,&nbsp;$password_new);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">481</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">482</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>483</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">484</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">485</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>486</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>487</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>488</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;get_mstr_token($username,&nbsp;$password,&nbsp;$connector_url,&nbsp;&nbsp;$application_id){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">489</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$data&nbsp;=&nbsp;array(</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">+490</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;username&quot;&nbsp;=&gt;&nbsp;$username,</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">+491</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;password&quot;&nbsp;&nbsp;=&gt;&nbsp;$password,</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">+492</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;submit&quot;&nbsp;=&gt;&nbsp;1</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">+493</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">494</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$login_url&nbsp;=&nbsp;$this-&gt;get_mstr_login_url($connector_url);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">495</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;ORGConnector::request_mstr_token($login_url,&nbsp;$data);</span></code></td></tr><tr><td class="coverageDetails"><span>496</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;the&nbsp;token&nbsp;json&nbsp;string</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">497</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!preg_match('/KEY_START(.*)KEY_END/',&nbsp;$result,&nbsp;$arr))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">498</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException(&quot;The&nbsp;name&nbsp;or&nbsp;password&nbsp;you&nbsp;have&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;our&nbsp;records&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>499</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>500</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">501</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$token_json&nbsp;=&nbsp;json_decode($arr[1]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">502</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$token_json;</span></code></td></tr><tr><td class="coverageDetails"><span>503</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>504</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>505</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//get&nbsp;mstr's&nbsp;login&nbsp;url</span></code></td></tr><tr><td class="coverageDetails"><span>506</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;get_mstr_login_url($connector_url)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">507</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find_by_connector($connector_url);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">508</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($org))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">509</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOrgNotFoundException('Organization&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>510</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">511</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$settings&nbsp;=&nbsp;$org-&gt;get_settings();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">512</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($settings-&gt;internal_login_url))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">513</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOrgNotFoundException('Organization&nbsp;login&nbsp;url&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>514</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">515</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$login_url&nbsp;=&nbsp;$settings-&gt;internal_login_url;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">516</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$login_url;</span></code></td></tr><tr><td class="coverageDetails"><span>517</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>518</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>519</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>520</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;save_photo($uvs_id,&nbsp;$base64_photo,&nbsp;$extension,&nbsp;$type)&nbsp;{&nbsp;//&nbsp;$type&nbsp;-&nbsp;&nbsp;'profile',&nbsp;'facebook'</span></code></td></tr><tr><td class="coverageDetails"><span>521</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;try{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">522</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$absoulte_dest&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_file_path&quot;)&nbsp;.&nbsp;$uvs_id&nbsp;.&nbsp;&quot;_&quot;&nbsp;.&nbsp;$type&nbsp;.&nbsp;&quot;.&quot;&nbsp;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">523</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$photo&nbsp;=&nbsp;base64_decode($base64_photo);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">524</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tmp_file&nbsp;=&nbsp;tempnam(&quot;/tmp&quot;,&nbsp;&quot;usher_&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">525</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$new_tmp_file&nbsp;=&nbsp;$tmp_file&nbsp;.&nbsp;&quot;.&quot;&nbsp;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">526</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($new_tmp_file,&nbsp;$photo);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">527</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rename($new_tmp_file,&nbsp;$absoulte_dest);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">528</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$relative_path&nbsp;=&nbsp;self::get_file_relative_path()&nbsp;.&nbsp;$uvs_id&nbsp;.&nbsp;&quot;_&quot;&nbsp;.&nbsp;$type.&nbsp;&quot;.&quot;&nbsp;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">529</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!&nbsp;User::store_db_image($uvs_id,&nbsp;$type,&nbsp;$relative_path)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">530</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>531</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">532</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}catch(Exception&nbsp;$e){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">533</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>534</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>535</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//There&nbsp;is&nbsp;/&nbsp;in&nbsp;front&nbsp;of&nbsp;$relative_path</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">536</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&quot;/&quot;&nbsp;.&nbsp;$relative_path;</span></code></td></tr><tr><td class="coverageDetails"><span>537</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>538</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>539</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>540</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;connector_login($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">541</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">542</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>543</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">544</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode($this-&gt;request-&gt;get_input());</span></code></td></tr><tr><td class="coverageDetails"><span>545</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode('{&quot;email&quot;:&quot;jshi&quot;,&quot;password&quot;:&quot;**&quot;,&nbsp;&quot;application_id&quot;:1}');</span></code></td></tr><tr><td class="coverageDetails"><span>546</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">547</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">548</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;=&nbsp;$input-&gt;password;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">549</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$username&nbsp;=&nbsp;$input-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">550</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$ttl&nbsp;=&nbsp;$input-&gt;ttl;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">551</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$application_id&nbsp;=&nbsp;$input-&gt;application_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">552</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_uid&nbsp;=&nbsp;$input-&gt;mac_addr;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">553</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_name&nbsp;=&nbsp;$input-&gt;device_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">554</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$connector_url&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">555</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$mstr_org_url&nbsp;=&nbsp;Util::get_general_config(&quot;MSTR_ORG_URL&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">556</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($input-&gt;connector_url)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">557</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$connector_url&nbsp;=&nbsp;$input-&gt;connector_url;</span></code></td></tr><tr><td class="coverageDetails"><span>558</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">559</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$connector_url&nbsp;=&nbsp;$mstr_org_url;</span></code></td></tr><tr><td class="coverageDetails"><span>560</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">561</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!App::find($application_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">562</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidAppException('Invalid&nbsp;app&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>563</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>564</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">565</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($password)&nbsp;&amp;&amp;&nbsp;strlen($password)&nbsp;==&nbsp;0)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">566</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Password&nbsp;cannot&nbsp;be&nbsp;empty&nbsp;string!');</span></code></td></tr><tr><td class="coverageDetails"><span>567</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>568</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//1.&nbsp;Check&nbsp;whether&nbsp;the&nbsp;credential&nbsp;is&nbsp;valid,&nbsp;get&nbsp;org_token</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">569</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$token_object&nbsp;=&nbsp;$this-&gt;get_mstr_token($username,&nbsp;$password,$connector_url&nbsp;,$application_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">570</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;$token_object-&gt;access_token;</span></code></td></tr><tr><td class="coverageDetails"><span>571</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;'7196705921612809';</span></code></td></tr><tr><td class="coverageDetails"><span>572</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">573</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">574</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($connector_url&nbsp;==&nbsp;$mstr_org_url){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">575</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;=&nbsp;$username.'@microstrategy.com';</span></code></td></tr><tr><td class="coverageDetails"><span>576</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">577</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;=&nbsp;$username;</span></code></td></tr><tr><td class="coverageDetails"><span>578</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">579</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_email&nbsp;=&nbsp;User::find_by_email($email,&nbsp;TRUE);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">580</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find_by_connector($connector_url);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">581</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$org-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">582</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($uvs_id_by_email)){</span></code></td></tr><tr><td class="coverageDetails"><span>583</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;info&nbsp;from&nbsp;connector</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">584</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bresponse_by_connector&nbsp;=&nbsp;ORGConnector::request_badges($connector_url,&nbsp;$org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">585</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($bresponse_by_connector)&nbsp;and&nbsp;$bresponse_by_connector-&gt;status&nbsp;==&nbsp;&quot;Connector&nbsp;timeout&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">586</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerConnectorTimeoutException(&quot;Could&nbsp;not&nbsp;login,&nbsp;connector&nbsp;timeout,&nbsp;please&nbsp;try&nbsp;later!&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>587</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">588</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;$bresponse_by_connector-&gt;badges;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">589</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($badges)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">590</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerConnectorInvalidResponseException(&quot;Could&nbsp;not&nbsp;login,&nbsp;invalid&nbsp;response&nbsp;from&nbsp;connector,&nbsp;please&nbsp;try&nbsp;later!&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>591</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">592</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mstr_badge&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">593</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($badges&nbsp;as&nbsp;$badge){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">594</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mstr_badge&nbsp;=&nbsp;$badge;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">595</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></code></td></tr><tr><td class="coverageDetails"><span>596</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">597</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($mstr_badge)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">598</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException(&quot;We&nbsp;can\'t&nbsp;get&nbsp;your&nbsp;badge&nbsp;info&nbsp;from&nbsp;connector,&nbsp;please&nbsp;try&nbsp;later!&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>599</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>600</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//create&nbsp;user&nbsp;in&nbsp;uvs&nbsp;server</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">601</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name&nbsp;=&nbsp;$mstr_badge-&gt;badgeinfo-&gt;name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">602</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name&nbsp;=&nbsp;str_replace('&nbsp;',&nbsp;'',&nbsp;$name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">603</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($last_name,&nbsp;$first_name)&nbsp;=&nbsp;explode(&quot;,&quot;,&nbsp;$name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">604</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$account_type&nbsp;=&nbsp;&quot;confirmed&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">605</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$usher_password&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">606</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create($email,&nbsp;$usher_password,&nbsp;$first_name,&nbsp;$last_name,&nbsp;NULL,&nbsp;&nbsp;NULL,&nbsp;$account_type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">607</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>608</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">609</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::add_update_org_token($org_id,&nbsp;$uvs_id,&nbsp;$org_access_token,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">610</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($mstr_badge-&gt;badgeinfo-&gt;photo-&gt;value))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">611</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($image,&nbsp;$photo_type)&nbsp;=&nbsp;explode('/',&nbsp;$mstr_badge-&gt;badgeinfo-&gt;photo-&gt;type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">612</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$relative&nbsp;=&nbsp;$this-&gt;save_photo($uvs_id,&nbsp;$mstr_badge-&gt;badgeinfo-&gt;photo-&gt;value,&nbsp;$photo_type,&nbsp;'profile');</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">613</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($relative)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">614</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;set_profile_photo($relative);</span></code></td></tr><tr><td class="coverageDetails"><span>615</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>616</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>617</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//move&nbsp;it&nbsp;to&nbsp;the&nbsp;end&nbsp;&nbsp;of&nbsp;the&nbsp;function</span></code></td></tr><tr><td class="coverageDetails"><span>618</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$passphrase&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>619</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$device&nbsp;=&nbsp;Device::create_and_activate($uvs_id,&nbsp;$email,&nbsp;$passphrase,&nbsp;$device_name,&nbsp;$device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">620</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id,&nbsp;$application_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">621</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_org_badge($user,&nbsp;$org,&nbsp;$org_access_token,&nbsp;false,&nbsp;$bresponse_by_connector);</span></code></td></tr><tr><td class="coverageDetails"><span>622</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">623</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id_by_email,&nbsp;$application_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">624</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_by_email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">625</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::add_update_org_token($org_id,&nbsp;$uvs_id,&nbsp;$org_access_token,&nbsp;false);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">626</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!Badge::is_existed($uvs_id,&nbsp;$org_id)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">627</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_org_badge($user,&nbsp;$org,&nbsp;$org_access_token,&nbsp;false,&nbsp;NULL);</span></code></td></tr><tr><td class="coverageDetails"><span>628</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>629</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">630</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">631</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">632</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$user-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">633</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;user_type&nbsp;=&nbsp;$user-&gt;get_user_type();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">634</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;uvs_access_token&nbsp;=&nbsp;$user-&gt;get_uvs_access_token($device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">635</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_access_token&nbsp;=&nbsp;$user-&gt;get_fb_access_token();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">636</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_token_expires&nbsp;=&nbsp;$user-&gt;get_fb_token_expires();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">637</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;public_key&nbsp;=&nbsp;User::get_public_key($uvs_id,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">638</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;merged_accounts&nbsp;=&nbsp;User::find_merged_uvs_id($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">639</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;email_accounts&nbsp;=&nbsp;$user-&gt;get_email_accounts();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">640</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;phone_numbers&nbsp;=&nbsp;$user-&gt;get_phone_numbers();</span></code></td></tr><tr><td class="coverageDetails"><span>641</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>642</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;mac_addr&nbsp;has&nbsp;to&nbsp;be&nbsp;passed&nbsp;at&nbsp;login&nbsp;now</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">643</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">644</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($device_uid){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">645</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;Device::find_by_device_uid($uvs_id,&nbsp;$device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span>646</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if&nbsp;device&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;db&nbsp;,&nbsp;create&nbsp;and&nbsp;activate&nbsp;the&nbsp;device&nbsp;automatically</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">647</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;!$device&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">648</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$passphrase&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">649</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$primary_email&nbsp;=&nbsp;$user-&gt;get_primary_email();</span></code></td></tr><tr><td class="coverageDetails"><span>650</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//latest&nbsp;requirement:&nbsp;use&nbsp;device&nbsp;uid&nbsp;as&nbsp;device&nbsp;name's&nbsp;value</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">651</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;Device::create_and_activate($uvs_id,&nbsp;$primary_email,&nbsp;$passphrase,&nbsp;$device_uid,&nbsp;$device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span>652</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>653</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;the&nbsp;device&nbsp;info</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">654</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($device)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">655</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;device_id&nbsp;=&nbsp;$device-&gt;get_device_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">656</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;device_name&nbsp;=&nbsp;$device-&gt;get_device_name();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">657</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>658</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>659</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>660</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">661</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>662</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">663</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException('The&nbsp;email&nbsp;or&nbsp;password&nbsp;you&nbsp;have&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;our&nbsp;records');</span></code></td></tr><tr><td class="coverageDetails"><span>664</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>665</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>666</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>667</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;login($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">668</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">669</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>670</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>671</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">672</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$logentry&nbsp;=&nbsp;Logentry::getInstance();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">673</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;log_main(&quot;user&quot;,&nbsp;&quot;login&quot;,&nbsp;&quot;all&nbsp;elapse&nbsp;time&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>674</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">675</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">676</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>677</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">678</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">679</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;=&nbsp;$input-&gt;password;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">680</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">681</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;$input-&gt;org_access_token;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">682</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$fb_access_token&nbsp;=&nbsp;$input-&gt;fb_access_token;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">683</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$ttl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;ttl;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">684</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$input-&gt;orgid;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">685</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$application_id&nbsp;&nbsp;=&nbsp;$input-&gt;application_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">686</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$device_uid&nbsp;&nbsp;=&nbsp;$input-&gt;mac_addr;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">687</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$device_name&nbsp;=&nbsp;$input-&gt;device_name;</span></code></td></tr><tr><td class="coverageDetails"><span>688</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">689</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!App::find($application_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">690</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidAppException('Invalid&nbsp;app&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>691</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">692</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;!isset($password)&nbsp;&amp;&amp;&nbsp;!isset($fb_access_token)&nbsp;&amp;&amp;&nbsp;!isset($org_access_token)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">693</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException(&quot;Sorry,&nbsp;we&nbsp;didn't&nbsp;get&nbsp;your&nbsp;login&nbsp;info.&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>694</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">695</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($email)&nbsp;&amp;&amp;&nbsp;!preg_match(&quot;/^[_A-Za-z0-9-]+(.[_A-Za-z0-9-]+)*@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)+$/&quot;,&nbsp;$email))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">696</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;email&nbsp;address');</span></code></td></tr><tr><td class="coverageDetails"><span>697</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">698</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($password)&nbsp;&amp;&amp;&nbsp;strlen($password)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">699</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Password&nbsp;cannot&nbsp;be&nbsp;empty&nbsp;string!');</span></code></td></tr><tr><td class="coverageDetails"><span>700</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">701</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($fb_access_token)&nbsp;&amp;&amp;&nbsp;strlen($fb_access_token)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">702</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Facebook&nbsp;token&nbsp;cannot&nbsp;be&nbsp;empty&nbsp;string!');</span></code></td></tr><tr><td class="coverageDetails"><span>703</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>704</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">705</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;login&quot;,&nbsp;&quot;get&nbsp;user&quot;,&nbsp;&quot;get&nbsp;user&nbsp;info&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">706</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($password)&nbsp;{&nbsp;//login&nbsp;with&nbsp;usher&nbsp;credential:&nbsp;(email,&nbsp;password,&nbsp;application_id)&nbsp;or&nbsp;(phone,&nbsp;password,&nbsp;application_id)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">707</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;=&nbsp;$input-&gt;phone;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">708</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;&nbsp;=&nbsp;User::find_by_credential($email,&nbsp;$phone,&nbsp;$password,&nbsp;$application_id);</span></code></td></tr><tr><td class="coverageDetails"><span>709</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&nbsp;//login&nbsp;with&nbsp;connector/facebook&nbsp;credential</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">710</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_id)&nbsp;{&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">711</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;$this-&gt;org_login($org_access_token,&nbsp;$org_id,&nbsp;$application_id,&nbsp;NULL,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span>712</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>713</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//throw&nbsp;new&nbsp;ControllerBadRequestException(&quot;Sorry,&nbsp;we&nbsp;didn't&nbsp;get&nbsp;your&nbsp;login&nbsp;info&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">714</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;$this-&gt;facebook_login($input);</span></code></td></tr><tr><td class="coverageDetails"><span>715</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>716</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">717</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span>718</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">719</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">720</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>721</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">722</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;login&quot;,&nbsp;&quot;get&nbsp;default&nbsp;badge&quot;,&nbsp;&quot;build&nbsp;user&nbsp;default&nbsp;badge&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">723</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($password)&nbsp;{&nbsp;&nbsp;//login&nbsp;with&nbsp;usher&nbsp;credential</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">724</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$default_org_id&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>725</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;update/create&nbsp;default&nbsp;user&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">726</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_signed_badge&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$default_org_id,&nbsp;false);&nbsp;//It&nbsp;will&nbsp;reuse&nbsp;badgeid&nbsp;of&nbsp;`deleted`&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">727</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($old_signed_badge[0])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">728</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_badge_id&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">729</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_status&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_status();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">730</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expiration&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_expiration();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">731</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache_time&nbsp;=&nbsp;$old_signed_badge[0]-&gt;get_cache_time();</span></code></td></tr><tr><td class="coverageDetails"><span>732</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">733</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($badge_status&nbsp;!=&nbsp;'active'&nbsp;||&nbsp;$expiration&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$cache_time&nbsp;&lt;&nbsp;time())&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">734</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;build_default_user_badge($user,&nbsp;$application_id,&nbsp;$old_badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span>735</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>736</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;`org&nbsp;token`&nbsp;with&nbsp;new&nbsp;login&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">737</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!User::find_by_org_email($email,&nbsp;$default_org_id,&nbsp;$uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">738</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;org_token&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;org_id&nbsp;=&nbsp;$default_org_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">739</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">740</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_uvs_access_token&nbsp;=&nbsp;$conn-&gt;escape(&nbsp;$user-&gt;get_uvs_access_token($device_uid)&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">741</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;=&nbsp;$conn-&gt;escape($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">742</span></td><td class="coverageDetails"><span class="codeExecuted">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;org_token(org_id,&nbsp;uvs_id,&nbsp;org_token,&nbsp;email,&nbsp;update_time)&nbsp;VALUES&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">+743</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($default_org_id,&nbsp;$uvs_id,&nbsp;$i_uvs_access_token,&nbsp;$i_email,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">744</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>745</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>746</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">747</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span>748</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">749</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$user-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">750</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;user_type&nbsp;=&nbsp;$user-&gt;get_user_type();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">751</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;uvs_access_token&nbsp;&nbsp;=&nbsp;$user-&gt;get_uvs_access_token($device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">752</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_access_token&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_fb_access_token();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">753</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_token_expires&nbsp;&nbsp;=&nbsp;$user-&gt;get_fb_token_expires();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">754</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;public_key&nbsp;=&nbsp;User::get_public_key($uvs_id,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">755</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;merged_accounts&nbsp;=&nbsp;User::find_merged_uvs_id($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">756</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;email_accounts&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_email_accounts();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">757</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;phone_numbers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_phone_numbers();</span></code></td></tr><tr><td class="coverageDetails"><span>758</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$response-&gt;is_password_set&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;User::is_password_set($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">759</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;is_password_set&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_pwd_exists();</span></code></td></tr><tr><td class="coverageDetails"><span>760</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>761</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;mac_addr&nbsp;has&nbsp;to&nbsp;be&nbsp;passed&nbsp;at&nbsp;login&nbsp;now</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">762</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">763</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($device_uid)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">764</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;login&quot;,&nbsp;&quot;active&nbsp;device&quot;,&nbsp;&quot;device&nbsp;activiation&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">765</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;Device::find_by_device_uid($uvs_id,&nbsp;$device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span>766</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;the&nbsp;device&nbsp;info</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">767</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($device)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">768</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;device_id&nbsp;=&nbsp;$device-&gt;get_device_id();</span></code></td></tr><tr><td class="coverageDetails"><span>769</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">770</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$passphrase&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">771</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$primary_email&nbsp;=&nbsp;$user-&gt;get_primary_email();</span></code></td></tr><tr><td class="coverageDetails"><span>772</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if&nbsp;it&nbsp;is&nbsp;NOT&nbsp;the&nbsp;first&nbsp;device,&nbsp;need&nbsp;to&nbsp;send&nbsp;confirmation&nbsp;code</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">773</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Device::find_all($uvs_id,&nbsp;false))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">774</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;Device::create($uvs_id,&nbsp;$device_name,&nbsp;$device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">775</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($device)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">776</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$activation_code&nbsp;=&nbsp;$device-&gt;generate_activation_code();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">777</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mail_sent&nbsp;=&nbsp;Device::generate_activation_email($primary_email,&nbsp;$activation_code);&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">778</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;device_id&nbsp;=&nbsp;-1;&nbsp;//-1&nbsp;means&nbsp;client&nbsp;need&nbsp;to&nbsp;confirm&nbsp;this&nbsp;device</span></code></td></tr><tr><td class="coverageDetails"><span>779</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>780</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">781</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device_name&nbsp;=&nbsp;$user-&gt;get_first_name()&nbsp;.&nbsp;&quot;'s&nbsp;&quot;&nbsp;.&nbsp;$device_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">782</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device&nbsp;=&nbsp;Device::create_and_activate($uvs_id,&nbsp;$primary_email,&nbsp;$passphrase,&nbsp;$device_name,&nbsp;$device_uid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">783</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;device_id&nbsp;=&nbsp;$device-&gt;get_device_id();</span></code></td></tr><tr><td class="coverageDetails"><span>784</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>785</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">786</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;device_name&nbsp;=&nbsp;$device-&gt;get_device_name();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">787</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">788</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span>789</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">790</span></td><td class="coverageDetails"><span class="codeExecuted">2</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>791</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>792</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;As&nbsp;the&nbsp;password&nbsp;verification&nbsp;is&nbsp;done&nbsp;is&nbsp;user&nbsp;model,&nbsp;there&nbsp;is&nbsp;just&nbsp;for&nbsp;account&nbsp;error.</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">793</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException('The&nbsp;account&nbsp;you&nbsp;have&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;our&nbsp;records');</span></code></td></tr><tr><td class="coverageDetails"><span>794</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>795</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>796</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>797</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;facebook_login($input){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">798</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">799</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$password&nbsp;=&nbsp;$input-&gt;password;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">800</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">801</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$fb_access_token&nbsp;=&nbsp;$input-&gt;fb_access_token;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">802</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$ttl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$input-&gt;ttl;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">803</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$application_id&nbsp;&nbsp;=&nbsp;$input-&gt;application_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">804</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_uid&nbsp;&nbsp;=&nbsp;$input-&gt;mac_addr;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">805</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_name&nbsp;=&nbsp;$input-&gt;device_name;</span></code></td></tr><tr><td class="coverageDetails"><span>806</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">807</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$facebook_user_info&nbsp;=&nbsp;FBConnector::request_userinfo($fb_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">808</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$fb_id&nbsp;=&nbsp;$facebook_user_info-&gt;id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">809</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;=&nbsp;$facebook_user_info-&gt;email;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//we&nbsp;need&nbsp;to&nbsp;have&nbsp;facebook&nbsp;&quot;email&quot;&nbsp;access&nbsp;permission</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">810</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;=&nbsp;$facebook_user_info-&gt;first_name;&nbsp;//if&nbsp;we&nbsp;get</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">811</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;=&nbsp;$facebook_user_info-&gt;last_name;&nbsp;&nbsp;//if&nbsp;we&nbsp;get</span></code></td></tr><tr><td class="coverageDetails"><span>812</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">813</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">814</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$i_fb_access_token&nbsp;=&nbsp;$conn-&gt;escape($fb_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">815</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;=&nbsp;$conn-&gt;escape($email);&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">816</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$i_first_name&nbsp;=&nbsp;$conn-&gt;escape($first_name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">817</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$i_last_name&nbsp;=&nbsp;$conn-&gt;escape($last_name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">818</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_fbid&nbsp;=&nbsp;User::find_by_fb_id($fb_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">819</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">820</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_email&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span>821</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">822</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_fbid&nbsp;&amp;&amp;&nbsp;$uvs_id_by_email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">823</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_by_fbid;</span></code></td></tr><tr><td class="coverageDetails"><span>824</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//just&nbsp;update&nbsp;fb_access_token,&nbsp;and&nbsp;merge&nbsp;account</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">825</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!User::find_by_fb_token($fb_access_token,&nbsp;$application_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">826</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;facebook_token&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id_by_fbid&nbsp;AND&nbsp;application_id&nbsp;=&nbsp;$application_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">827</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">828</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;facebook_token(application_id,&nbsp;uvs_id,&nbsp;fb_token,&nbsp;email,&nbsp;update_time)&nbsp;VALUES&nbsp;($application_id,&nbsp;$uvs_id_by_fbid,&nbsp;$i_fb_access_token,&nbsp;$i_email,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">829</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>830</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">831</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_fbid&nbsp;!=&nbsp;$uvs_id_by_email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">832</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::merge($uvs_id_by_fbid,&nbsp;$uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span>833</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">834</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if($uvs_id_by_fbid)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">835</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_by_fbid;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">836</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!User::find_by_fb_token($fb_access_token,&nbsp;$application_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">837</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;facebook_token&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id_by_fbid&nbsp;AND&nbsp;application_id&nbsp;=&nbsp;$application_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">838</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">839</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;facebook_token(application_id,&nbsp;uvs_id,&nbsp;fb_token,&nbsp;email,&nbsp;update_time)&nbsp;VALUES&nbsp;($application_id,&nbsp;$uvs_id_by_fbid,&nbsp;$i_fb_access_token,&nbsp;$i_email,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">840</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>841</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">842</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($email)&nbsp;{&nbsp;//in&nbsp;this&nbsp;case,&nbsp;we&nbsp;get&nbsp;a&nbsp;fb&nbsp;email&nbsp;which&nbsp;isn't&nbsp;in&nbsp;DB</span></code></td></tr><tr><td class="coverageDetails"><span>843</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//As&nbsp;in&nbsp;the&nbsp;previous&nbsp;Admin&nbsp;Portal,&nbsp;&nbsp;it&nbsp;will&nbsp;also&nbsp;call&nbsp;this&nbsp;login&nbsp;api&nbsp;to&nbsp;implement&nbsp;fb&nbsp;login</span></code></td></tr><tr><td class="coverageDetails"><span>844</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//But&nbsp;it&nbsp;will&nbsp;not&nbsp;pass&nbsp;the&nbsp;email&nbsp;to&nbsp;server&nbsp;side.&nbsp;So&nbsp;in&nbsp;db,&nbsp;it&nbsp;may&nbsp;have&nbsp;records&nbsp;that&nbsp;an&nbsp;account&nbsp;only&nbsp;has&nbsp;fb&nbsp;id&nbsp;but&nbsp;has&nbsp;no&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span>845</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//in&nbsp;this&nbsp;case&nbsp;,we&nbsp;should&nbsp;set&nbsp;this&nbsp;email&nbsp;as&nbsp;primary&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">846</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id_by_fbid&nbsp;AND&nbsp;is_primary&nbsp;&nbsp;=&nbsp;1&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">847</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">848</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_primary&nbsp;=&nbsp;0;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">849</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$result)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">850</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_primary&nbsp;=&nbsp;1;</span></code></td></tr><tr><td class="coverageDetails"><span>851</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">852</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;=&nbsp;$conn-&gt;escape($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">853</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;&nbsp;&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;account_email(uvs_id,&nbsp;email,&nbsp;confirmed,&nbsp;login_enabled,&nbsp;is_primary,&nbsp;creation_time)&nbsp;VALUES&nbsp;($uvs_id_by_fbid,&nbsp;$i_email,&nbsp;1,&nbsp;0,&nbsp;$is_primary,&nbsp;NOW())&quot;;&nbsp;//as&nbsp;long&nbsp;as&nbsp;user's&nbsp;password&nbsp;exist&nbsp;in&nbsp;`account`,&nbsp;login_enabled&nbsp;is&nbsp;1</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">854</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>855</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">856</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if($uvs_id_by_email)&nbsp;{&nbsp;//first-time&nbsp;login,&nbsp;but&nbsp;email&nbsp;exists&nbsp;in&nbsp;DB</span></code></td></tr><tr><td class="coverageDetails"><span>857</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//here,&nbsp;$first_name,&nbsp;$last_name&nbsp;should&nbsp;be&nbsp;provided&nbsp;from&nbsp;facebook</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">858</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_by_email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">859</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(User::is_name_exist($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">860</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;fb_id&nbsp;=&nbsp;$fb_id&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id_by_email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>861</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">862</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;first_name&nbsp;=&nbsp;$i_first_name,&nbsp;last_name&nbsp;=&nbsp;$i_last_name,&nbsp;fb_id&nbsp;=&nbsp;$fb_id&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id_by_email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>863</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">864</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">865</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;facebook_token(application_id,&nbsp;uvs_id,&nbsp;fb_token,&nbsp;email,&nbsp;update_time)&nbsp;VALUES&nbsp;($application_id,&nbsp;$uvs_id_by_email,&nbsp;$i_fb_access_token,&nbsp;$i_email,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">866</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>867</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&nbsp;//first-time&nbsp;login&nbsp;with&nbsp;new&nbsp;email,&nbsp;then&nbsp;create&nbsp;a&nbsp;new&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span>868</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//here,&nbsp;$first_name,&nbsp;$last_name&nbsp;should&nbsp;be&nbsp;provided&nbsp;from&nbsp;facebook</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">869</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create($email,&nbsp;NULL,&nbsp;$first_name,&nbsp;$last_name,&nbsp;NULL,&nbsp;$fb_id,&nbsp;&quot;confirmed&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">870</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">871</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;facebook_token(application_id,&nbsp;uvs_id,&nbsp;fb_token,&nbsp;email,&nbsp;update_time)&nbsp;VALUES&nbsp;($application_id,&nbsp;$uvs_id,&nbsp;$i_fb_access_token,&nbsp;$i_email,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">872</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>873</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>874</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">875</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id,&nbsp;$application_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">876</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$photo_object&nbsp;=&nbsp;FBConnector::request_user_photo($fb_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span>877</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>878</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//also&nbsp;set&nbsp;fb&nbsp;photo&nbsp;as&nbsp;profile&nbsp;photo&nbsp;if&nbsp;it&nbsp;is&nbsp;null</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">879</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$photo_relative_url&nbsp;=&nbsp;$user-&gt;get_profile_photo();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">880</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($photo_relative_url)&nbsp;||&nbsp;strlen($photo_relative_url)==0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">881</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$relative&nbsp;=&nbsp;$this-&gt;save_photo($uvs_id,&nbsp;$photo_object-&gt;value,&nbsp;$photo_object-&gt;type,&nbsp;'profile');</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">882</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($relative)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">883</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;set_profile_photo($relative);</span></code></td></tr><tr><td class="coverageDetails"><span>884</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>885</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>886</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//create&nbsp;FB&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span>887</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/*$facebook_user_info-&gt;facebook_photo_url&nbsp;=&nbsp;$this-&gt;save_photo($uvs_id,&nbsp;$photo_object-&gt;value,&nbsp;$photo_object-&gt;type,&nbsp;'facebook');</span></code></td></tr><tr><td class="coverageDetails"><span>888</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$facebook_user_badge&nbsp;=&nbsp;&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;Glob::$facebook_badge_settings[&quot;orgid&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span>889</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;build_facebook_user_badge($uvs_id,&nbsp;$facebook_user_info,&nbsp;$application_id,&nbsp;$facebook_user_badge&nbsp;?&nbsp;$facebook_user_badge[0]-&gt;get_id()&nbsp;:&nbsp;NULL);</span></code></td></tr><tr><td class="coverageDetails"><span>890</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">891</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$user;</span></code></td></tr><tr><td class="coverageDetails"><span>892</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>893</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>894</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//--------&nbsp;connector&nbsp;login&nbsp;for&nbsp;v1.3&nbsp;-----------------//</span></code></td></tr><tr><td class="coverageDetails"><span>895</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;org_login($org_access_token,&nbsp;$org_id,&nbsp;$application_id,&nbsp;$uvs_id_current_logged_in&nbsp;=&nbsp;NULL,&nbsp;$merge_account&nbsp;=&nbsp;false)&nbsp;{&nbsp;//if&nbsp;uvs_id_current_logged_in&nbsp;is&nbsp;not&nbsp;null,&nbsp;then&nbsp;this&nbsp;is&nbsp;from&nbsp;'add&nbsp;a&nbsp;badge'</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">896</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span>897</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;org&nbsp;info</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">898</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find($org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">899</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$org)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">900</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOrgNotFoundException('Organization&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>901</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">902</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_user_info&nbsp;=&nbsp;OrgConnector::request_userinfo($org-&gt;get_connector(),&nbsp;$org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">903</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_user_info-&gt;status&nbsp;==&nbsp;'invalid&nbsp;token')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">904</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_id&nbsp;==&nbsp;Glob::$facebook_badge_settings[&quot;orgid&quot;]){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">905</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidFBTokenException('Invaild&nbsp;Facebook&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>906</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>907</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">908</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;InvalidOrgTokenException('Invaild&nbsp;org&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>909</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>910</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">911</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_user_id&nbsp;=&nbsp;(int)$org_user_info-&gt;id;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if&nbsp;we&nbsp;get</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">912</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$org_user_info-&gt;email;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Org&nbsp;must&nbsp;provide&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">913</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;&nbsp;=&nbsp;$org_user_info-&gt;first_name;&nbsp;//if&nbsp;we&nbsp;get</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">914</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;&nbsp;=&nbsp;$org_user_info-&gt;last_name;&nbsp;&nbsp;//if&nbsp;we&nbsp;get</span></code></td></tr><tr><td class="coverageDetails"><span>915</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">916</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">917</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_org_access_token&nbsp;=&nbsp;$conn-&gt;escape($org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">918</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;=&nbsp;$conn-&gt;escape($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">919</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_first_name&nbsp;=&nbsp;$conn-&gt;escape($first_name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">920</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_last_name&nbsp;=&nbsp;$conn-&gt;escape($last_name);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">921</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_user_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">922</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_org_user_id&nbsp;=&nbsp;User::find_by_org_user_id($org_user_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span>923</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">924</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">925</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_by_email&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span>926</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">927</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$merge_account&nbsp;&amp;&amp;&nbsp;$uvs_id_by_org_user_id&nbsp;&amp;&amp;&nbsp;$uvs_id_by_org_user_id&nbsp;!=&nbsp;$uvs_id_current_logged_in)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">928</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadgeTiedToAnotherAccountException('Badge&nbsp;tied&nbsp;to&nbsp;another&nbsp;account');</span></code></td></tr><tr><td class="coverageDetails"><span>929</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">930</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$merge_account&nbsp;&amp;&amp;&nbsp;$uvs_id_by_email&nbsp;&amp;&amp;&nbsp;$uvs_id_by_email&nbsp;!=&nbsp;$uvs_id_current_logged_in)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">931</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadgeTiedToAnotherAccountException('Badge&nbsp;tied&nbsp;to&nbsp;another&nbsp;account');</span></code></td></tr><tr><td class="coverageDetails"><span>932</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>933</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">934</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_current_logged_in)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">935</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_current_logged_in;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">936</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if($uvs_id_by_email)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">937</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_by_email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">938</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if($uvs_id_by_org_user_id)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">939</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_by_org_user_id;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>940</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&nbsp;//first-time&nbsp;login&nbsp;with&nbsp;new&nbsp;email,&nbsp;then&nbsp;create&nbsp;a&nbsp;new&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">941</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::create($email,&nbsp;NULL,&nbsp;$first_name,&nbsp;$last_name,&nbsp;NULL,&nbsp;NULL,&nbsp;&quot;confirmed&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">942</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>943</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>944</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//merge&nbsp;account&nbsp;(deprecated;&nbsp;instead,&nbsp;if&nbsp;$uvs_id_by_org_user_id&nbsp;and&nbsp;$uvs_id_by_email&nbsp;both&nbsp;exist&nbsp;but&nbsp;different,&nbsp;delete&nbsp;$uvs_id_by_org_user_id)</span></code></td></tr><tr><td class="coverageDetails"><span>945</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*User::merge($uvs_id,&nbsp;$uvs_id_by_email);</span></code></td></tr><tr><td class="coverageDetails"><span>946</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_email&nbsp;!=&nbsp;$uvs_id_by_org_user_id&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>947</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::merge($uvs_id,&nbsp;$uvs_id_by_org_user_id);</span></code></td></tr><tr><td class="coverageDetails"><span>948</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">949</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_email&nbsp;&amp;&amp;&nbsp;$uvs_id_by_org_user_id&nbsp;&amp;&amp;&nbsp;$uvs_id_by_email&nbsp;!=&nbsp;$uvs_id_by_org_user_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">950</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::delete($uvs_id_by_org_user_id);</span></code></td></tr><tr><td class="coverageDetails"><span>951</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>952</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">953</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_org_primary_email_changed&nbsp;=&nbsp;User::find_by_org_email($email,&nbsp;$org_id,&nbsp;$uvs_id)&nbsp;?&nbsp;false&nbsp;:&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>954</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;org_access_token</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">955</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!User::find_by_org_token($org_access_token,&nbsp;$org_id,&nbsp;$application_id,&nbsp;$uvs_id)&nbsp;||&nbsp;$is_org_primary_email_changed)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">956</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;org_token&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;org_id&nbsp;=&nbsp;$org_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">957</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">958</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;org_token(org_id,&nbsp;uvs_id,&nbsp;org_token,&nbsp;org_user_id,&nbsp;email,&nbsp;update_time)&nbsp;VALUES&nbsp;($org_id,&nbsp;$uvs_id,&nbsp;$i_org_access_token,&nbsp;$org_user_id,&nbsp;$i_email,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">959</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>960</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>961</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;profile:&nbsp;name</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">962</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!User::is_name_exist($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">963</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;first_name&nbsp;=&nbsp;$i_first_name,&nbsp;last_name&nbsp;=&nbsp;$i_last_name&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">964</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>965</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>966</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;new&nbsp;email&nbsp;(if&nbsp;we&nbsp;get&nbsp;an&nbsp;org&nbsp;email&nbsp;which&nbsp;isn't&nbsp;in&nbsp;DB)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">967</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($email&nbsp;&amp;&amp;&nbsp;!$uvs_id_by_email&nbsp;&amp;&amp;&nbsp;($uvs_id_current_logged_in&nbsp;||&nbsp;$uvs_id_by_org_user_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">968</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_primary&nbsp;=&nbsp;User::is_primary_email_set($uvs_id)&nbsp;?&nbsp;0&nbsp;:&nbsp;1;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">969</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;=&nbsp;$conn-&gt;escape($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">970</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;&nbsp;&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;account_email(uvs_id,&nbsp;email,&nbsp;confirmed,&nbsp;login_enabled,&nbsp;is_primary,&nbsp;creation_time)&nbsp;VALUES&nbsp;($uvs_id,&nbsp;$i_email,&nbsp;1,&nbsp;0,&nbsp;$is_primary,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">971</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>972</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>973</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">974</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id,&nbsp;$application_id);</span></code></td></tr><tr><td class="coverageDetails"><span>975</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//load&nbsp;badges&nbsp;from&nbsp;connector&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;valid&nbsp;badge&nbsp;in&nbsp;uvs</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">976</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$uvs_id_current_logged_in)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">977</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_by_email&nbsp;!=&nbsp;$uvs_id_by_org_user_id&nbsp;||&nbsp;$is_org_primary_email_changed)&nbsp;{&nbsp;//&nbsp;to&nbsp;handle&nbsp;the&nbsp;change&nbsp;of&nbsp;org&nbsp;primary&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">978</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$need_load_badge_from_org&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>979</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{&nbsp;&nbsp;//check&nbsp;if&nbsp;there&nbsp;is&nbsp;valid&nbsp;badge&nbsp;in&nbsp;uvs</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">980</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signed_badges&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">981</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$need_load_badge_from_org&nbsp;=&nbsp;&nbsp;$signed_badges&nbsp;?&nbsp;false&nbsp;:&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">982</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(&nbsp;$signed_badges&nbsp;as&nbsp;$old_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">983</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expiration&nbsp;=&nbsp;$old_badge-&gt;get_expiration();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">984</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache_time&nbsp;=&nbsp;$old_badge-&gt;get_cache_time();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">985</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($expiration&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$cache_time&nbsp;&lt;&nbsp;time())&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">986</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$need_load_badge_from_org&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>987</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>988</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>989</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">990</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($need_load_badge_from_org)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">991</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;$this-&gt;load_org_badge($user,&nbsp;$org,&nbsp;$org_access_token,&nbsp;false);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">992</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>993</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($badge-&gt;id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>994</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_model&nbsp;=&nbsp;Badge::find($badge-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>995</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::save_active_log($badge_model,&nbsp;Activelog::$EVENT_TYPE_BADGE_ADDED,&nbsp;&quot;add&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>996</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>997</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//extract&nbsp;(name,&nbsp;photo)&nbsp;of&nbsp;badge&nbsp;into&nbsp;profile&nbsp;if&nbsp;it&nbsp;is&nbsp;null</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">998</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$photo_relative_url&nbsp;=&nbsp;$user-&gt;get_profile_photo();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">999</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$photo_relative_url){</span></code></td></tr><tr><td class="coverageDetails"><span>1000</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//save&nbsp;photo&nbsp;to&nbsp;user&nbsp;file</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1001</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::store_db_image($uvs_id,&nbsp;'profile',&nbsp;$badge-&gt;badgeinfo-&gt;photo-&gt;reference);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1002</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;set_profile_photo($badge-&gt;badgeinfo-&gt;photo-&gt;reference);</span></code></td></tr><tr><td class="coverageDetails"><span>1003</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1004</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*if(!User::is_name_exist($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1005</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name&nbsp;=&nbsp;$badge-&gt;badgeinfo-&gt;name;</span></code></td></tr><tr><td class="coverageDetails"><span>1006</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($last_name,&nbsp;$first_name)&nbsp;=&nbsp;explode(&quot;,&quot;,&nbsp;$name);&nbsp;//...for&nbsp;MSTR&nbsp;only,&nbsp;will&nbsp;extend&nbsp;to&nbsp;support&nbsp;other&nbsp;name&nbsp;formats&nbsp;later</span></code></td></tr><tr><td class="coverageDetails"><span>1007</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$last_name&nbsp;&nbsp;=&nbsp;trim($last_name);</span></code></td></tr><tr><td class="coverageDetails"><span>1008</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$first_name&nbsp;=&nbsp;trim($first_name);</span></code></td></tr><tr><td class="coverageDetails"><span>1009</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_first_name&nbsp;=&nbsp;$conn-&gt;escape($first_name);</span></code></td></tr><tr><td class="coverageDetails"><span>1010</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_last_name&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($last_name);</span></code></td></tr><tr><td class="coverageDetails"><span>1011</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;first_name&nbsp;=&nbsp;$i_first_name,&nbsp;last_name&nbsp;=&nbsp;$i_last_name&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1012</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1013</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user-&gt;set_name($first_name,&nbsp;$last_name);</span></code></td></tr><tr><td class="coverageDetails"><span>1014</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}*/</span></code></td></tr><tr><td class="coverageDetails"><span>1015</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1016</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1017</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1018</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$user;</span></code></td></tr><tr><td class="coverageDetails"><span>1019</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1020</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1021</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_profile($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1022</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1023</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1024</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1025</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1026</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$include_fb_token&nbsp;=&nbsp;$_GET[&quot;include_fb_token&quot;]&nbsp;?&nbsp;$_GET[&quot;include_fb_token&quot;]:&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1027</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$application_id&nbsp;&nbsp;&nbsp;=&nbsp;$_GET[&quot;application_id&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1028</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$include_accounts&nbsp;=&nbsp;$_GET[&quot;include_accounts&quot;]&nbsp;?&nbsp;$_GET[&quot;include_accounts&quot;]:&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span>1029</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1030</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token,&nbsp;$include_fb_token,&nbsp;$include_accounts);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1031</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1032</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1033</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1034</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1035</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$user-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1036</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;uvs_token_expires&nbsp;=&nbsp;$user-&gt;get_uvs_token_expires();</span></code></td></tr><tr><td class="coverageDetails"><span>1037</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$response-&gt;is_password_set&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;User::is_password_set($user-&gt;get_uvs_id());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1038</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;is_password_set&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_pwd_exists();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1039</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($include_fb_token)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1040</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_access_token&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_fb_access_token();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1041</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_token_expires&nbsp;&nbsp;=&nbsp;$user-&gt;get_fb_token_expires();</span></code></td></tr><tr><td class="coverageDetails"><span>1042</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1043</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($include_accounts)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1044</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;email_accounts&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_email_accounts();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1045</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;phone_numbers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_phone_numbers();</span></code></td></tr><tr><td class="coverageDetails"><span>1046</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1047</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1048</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1049</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1050</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;fb_access_token($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1051</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1052</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1053</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1054</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1055</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1056</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1057</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;fb_access_token&nbsp;&nbsp;=&nbsp;$user-&gt;get_fb_access_token();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1058</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1059</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1060</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1061</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;confirm_email($args)&nbsp;{&nbsp;&nbsp;//this&nbsp;call&nbsp;could&nbsp;either&nbsp;be&nbsp;`GET`&nbsp;or&nbsp;`POST`</span></code></td></tr><tr><td class="coverageDetails"><span>1062</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Now&nbsp;the&nbsp;frontend&nbsp;team&nbsp;call&nbsp;this&nbsp;api&nbsp;using&nbsp;&quot;GET&quot;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1063</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;==&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1064</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1065</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device_name&nbsp;=&nbsp;$input-&gt;device_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1066</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$passphrase&nbsp;=&nbsp;$input-&gt;passphrase;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1067</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mac_addr&nbsp;=&nbsp;$input-&gt;mac_addr;</span></code></td></tr><tr><td class="coverageDetails"><span>1068</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1069</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1070</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$confirmation_code&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1071</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($confirmation_code))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1072</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>1073</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1074</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_email_code($confirmation_code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1075</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1076</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCodeException('Invalid&nbsp;confirmation&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span>1077</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1078</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1079</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_email();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1080</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$email_id&nbsp;=&nbsp;$user-&gt;get_email_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1081</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>1082</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1083</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$i_confirmation_code&nbsp;=&nbsp;$conn-&gt;escape($confirmation_code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1084</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$conn-&gt;escape($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1085</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_to&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1086</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!User::check_availability_by_email($email,&nbsp;false))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1087</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerEmailExistException(&quot;Email&nbsp;already&nbsp;associated&nbsp;with&nbsp;another&nbsp;account&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>1088</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1089</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1090</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_reserved&nbsp;=&nbsp;User::find_by_email_reserved($email);</span></code></td></tr><tr><td class="coverageDetails"><span>1091</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;1:&nbsp;update&nbsp;`email_confirmation`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1092</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;email_confirmation&nbsp;SET&nbsp;confirmation_time&nbsp;=&nbsp;NOW()&nbsp;WHERE&nbsp;confirmation_code&nbsp;=&nbsp;$i_confirmation_code&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1093</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1094</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;2:&nbsp;update&nbsp;`account_email`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1095</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account_email&nbsp;SET&nbsp;confirmed&nbsp;=&nbsp;1&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1096</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1097</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;3:&nbsp;delete&nbsp;all&nbsp;other&nbsp;not-confirmed&nbsp;records&nbsp;in&nbsp;`account_email`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1098</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;email&nbsp;=&nbsp;$i_email&nbsp;AND&nbsp;(confirmed&nbsp;!=&nbsp;1&nbsp;OR&nbsp;confirmed&nbsp;IS&nbsp;NULL)&nbsp;AND&nbsp;(reserved&nbsp;!=&nbsp;1&nbsp;OR&nbsp;reserved&nbsp;IS&nbsp;NULL)&nbsp;AND&nbsp;uvs_id&nbsp;IS&nbsp;NOT&nbsp;NULL&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1099</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1100</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;4:&nbsp;update&nbsp;`account`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1101</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;provisional&nbsp;=&nbsp;0&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1102</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1103</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;5:&nbsp;try&nbsp;to&nbsp;merge&nbsp;account</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1104</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_to)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1105</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//already&nbsp;exist&nbsp;a&nbsp;confirmed&nbsp;email_account&nbsp;with&nbsp;the&nbsp;same&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1106</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::merge($uvs_id_to,&nbsp;$uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1107</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_to;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1108</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;($uvs_id_reserved)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1109</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//already&nbsp;exist&nbsp;a&nbsp;reserved&nbsp;email_account&nbsp;with&nbsp;the&nbsp;same&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1110</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::merge($uvs_id_reserved,&nbsp;$uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1111</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$uvs_id_reserved;</span></code></td></tr><tr><td class="coverageDetails"><span>1112</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1113</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1114</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//NOTE:&nbsp;save&nbsp;activity&nbsp;log</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1115</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;User::save_active_log($uvs_id,&nbsp;$email,&nbsp;ActiveLog::$EVENT_TYPE_EMAIL_VERIFY);</span></code></td></tr><tr><td class="coverageDetails"><span>1116</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1117</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1118</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1119</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//fix&nbsp;the&nbsp;bug</span></code></td></tr><tr><td class="coverageDetails"><span>1120</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//There&nbsp;is&nbsp;no&nbsp;need&nbsp;to&nbsp;do&nbsp;the&nbsp;device&nbsp;activation&nbsp;operation&nbsp;because&nbsp;only&nbsp;if&nbsp;the&nbsp;device&nbsp;is&nbsp;avtivate,&nbsp;this&nbsp;api&nbsp;can</span></code></td></tr><tr><td class="coverageDetails"><span>1121</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//be&nbsp;called.&nbsp;And&nbsp;the&nbsp;follwing&nbsp;codes&nbsp;will&nbsp;insert&nbsp;a&nbsp;new&nbsp;recode&nbsp;in&nbsp;user_device&nbsp;table&nbsp;which&nbsp;is&nbsp;duplicate&nbsp;with&nbsp;existing&nbsp;recored</span></code></td></tr><tr><td class="coverageDetails"><span>1122</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;activating&nbsp;device</span></code></td></tr><tr><td class="coverageDetails"><span>1123</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;$device&nbsp;=&nbsp;Device::create_and_activate($uvs_id,&nbsp;$email,&nbsp;$passphrase,&nbsp;$device_name,&nbsp;$mac_addr);</span></code></td></tr><tr><td class="coverageDetails"><span>1124</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1125</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($device)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1126</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$device-&gt;get_for_json();</span></code></td></tr><tr><td class="coverageDetails"><span>1127</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$response[&quot;status&quot;]&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1128</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1129</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1130</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1131</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1132</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;confirm_phone($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1133</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1134</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1135</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1136</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$confirmation_code&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1137</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($confirmation_code))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1138</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>1139</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1140</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_sms_code($confirmation_code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1141</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1142</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCodeException('Invalid&nbsp;confirmation&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span>1143</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1144</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1145</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_phone();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1146</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$phone_id&nbsp;=&nbsp;$user-&gt;get_phone_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1147</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>1148</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1149</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$i_confirmation_code&nbsp;=&nbsp;$conn-&gt;escape($confirmation_code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1150</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_to&nbsp;=&nbsp;User::find_by_phone($phone);</span></code></td></tr><tr><td class="coverageDetails"><span>1151</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1152</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;1:&nbsp;update&nbsp;`sms_confirmation`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1153</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;sms_confirmation&nbsp;SET&nbsp;confirmation_time&nbsp;=&nbsp;NOW()&nbsp;WHERE&nbsp;confirmation_code&nbsp;=&nbsp;$i_confirmation_code&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1154</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1155</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;2:&nbsp;update&nbsp;`account_phone`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1156</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account_phone&nbsp;SET&nbsp;confirmed&nbsp;=&nbsp;1&nbsp;WHERE&nbsp;phone_id&nbsp;=&nbsp;$phone_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1157</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1158</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;3:&nbsp;update&nbsp;`account`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1159</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;provisional&nbsp;=&nbsp;0&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1160</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1161</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;4:&nbsp;try&nbsp;to&nbsp;merge&nbsp;account</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1162</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($uvs_id_to)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1163</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//already&nbsp;exist&nbsp;a&nbsp;confirmed&nbsp;email_account&nbsp;with&nbsp;the&nbsp;same&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1164</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::merge($uvs_id_to,&nbsp;$uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1165</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1166</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1167</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1168</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1169</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1170</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1171</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_uvs_ids($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1172</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1173</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>1174</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1175</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1176</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span>1177</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1178</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach($input&nbsp;as&nbsp;$keyword)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1179</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$keyword-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1180</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$phone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$keyword-&gt;phone;</span></code></td></tr><tr><td class="coverageDetails"><span>1181</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$first_name&nbsp;=&nbsp;$keyword-&gt;first_name;</span></code></td></tr><tr><td class="coverageDetails"><span>1182</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$last_name&nbsp;&nbsp;=&nbsp;$keyword-&gt;last_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1183</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fb_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$keyword-&gt;fb_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1184</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$keyword-&gt;uvs_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1185</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($email)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1186</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1187</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if($phone)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1188</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;User::find_by_phone($phone);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1189</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if(&nbsp;/*$first_name&nbsp;&amp;&amp;&nbsp;$last_name&nbsp;&amp;&amp;*/&nbsp;$fb_id&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1190</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;User::find_by_fb_userinfo($fb_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1191</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1192</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1193</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyword-&gt;uvs_id&nbsp;=&nbsp;$uvs_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1194</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyword-&gt;first_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user&nbsp;?&nbsp;$user-&gt;get_first_name():&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1195</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyword-&gt;last_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user&nbsp;?&nbsp;$user-&gt;get_last_name()&nbsp;:&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1196</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyword-&gt;profile_photo_url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user&nbsp;?&nbsp;$user-&gt;get_profile_photo()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1197</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyword-&gt;fb_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user&nbsp;?&nbsp;$user-&gt;get_fb_id()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1198</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$keyword;</span></code></td></tr><tr><td class="coverageDetails"><span>1199</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1200</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1201</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1202</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1203</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_fb_ids($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1204</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1205</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>1206</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1207</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1208</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span>1209</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1210</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach($input&nbsp;as&nbsp;$keyword)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1211</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$keyword-&gt;uvs_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1212</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1213</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$keyword-&gt;fb_id&nbsp;=&nbsp;$user&nbsp;?&nbsp;$user-&gt;get_fb_id():&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1214</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$keyword;</span></code></td></tr><tr><td class="coverageDetails"><span>1215</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1216</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1217</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1218</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1219</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_uvsids_by_fbids($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1220</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1221</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>1222</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1223</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1224</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;User::find_by_multi_fb_ids($input);</span></code></td></tr><tr><td class="coverageDetails"><span>1225</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1226</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1227</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_fbids_by_uvsids($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1228</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1229</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>1230</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1231</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1232</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;User::find_by_multi_uvs_ids($input);</span></code></td></tr><tr><td class="coverageDetails"><span>1233</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1234</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1235</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;forgot_password()&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1236</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1237</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1238</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1239</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email&nbsp;&nbsp;=&nbsp;$_GET[&quot;email&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1240</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;User::find_by_email($email);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1241</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1242</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCredentialException('The&nbsp;email&nbsp;you&nbsp;have&nbsp;provided&nbsp;does&nbsp;not&nbsp;match&nbsp;our&nbsp;records');</span></code></td></tr><tr><td class="coverageDetails"><span>1243</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1244</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;&nbsp;&nbsp;=&nbsp;User::find_by_uvs_id($uvs_id,&nbsp;0);&nbsp;&nbsp;//application_id&nbsp;=&nbsp;0,&nbsp;means&nbsp;this&nbsp;token&nbsp;is&nbsp;used&nbsp;by&nbsp;uvs&nbsp;itself</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1245</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1246</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerFindRequestException('no&nbsp;such&nbsp;user');</span></code></td></tr><tr><td class="coverageDetails"><span>1247</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1248</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//generate&nbsp;the&nbsp;link</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1249</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($_SERVER['HTTPS']))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1250</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;&quot;https://&quot;.$_SERVER[&quot;HTTP_HOST&quot;].&quot;/ResetPassword.php?uvs_id=&quot;.$uvs_id.&quot;&amp;uvs_access_token=&quot;.$user-&gt;get_uvs_access_token();</span></code></td></tr><tr><td class="coverageDetails"><span>1251</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1252</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;&quot;http://&quot;.$_SERVER[&quot;HTTP_HOST&quot;].&quot;/ResetPassword.php?uvs_id=&quot;.$uvs_id.&quot;&amp;uvs_access_token=&quot;.$user-&gt;get_uvs_access_token();</span></code></td></tr><tr><td class="coverageDetails"><span>1253</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1254</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$url&nbsp;=&nbsp;'&lt;a&nbsp;href='&nbsp;.&nbsp;$url&nbsp;.&nbsp;'&gt;usher.com/resetpassword&lt;/a&gt;';</span></code></td></tr><tr><td class="coverageDetails"><span>1255</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//send&nbsp;the&nbsp;link&nbsp;to&nbsp;the&nbsp;email&nbsp;addrees</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1256</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$subject&nbsp;=&nbsp;'Reset&nbsp;your&nbsp;Usher&nbsp;password';</span></code></td></tr><tr><td class="coverageDetails"><span>1257</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;message</span></code></td></tr><tr><td class="coverageDetails"><span>1258</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/*$message&nbsp;=&nbsp;'</span></code></td></tr><tr><td class="coverageDetails"><span>1259</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;html&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1260</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1261</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;Reset&nbsp;your&nbsp;Usher&nbsp;password&lt;/title&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1262</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1263</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1264</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;Usher&nbsp;received&nbsp;a&nbsp;request&nbsp;to&nbsp;reset&nbsp;the&nbsp;password&nbsp;for&nbsp;your&nbsp;account.&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;reset&nbsp;your&nbsp;password,&nbsp;click&nbsp;on&nbsp;the&nbsp;link&nbsp;below&nbsp;(or&nbsp;copy&nbsp;and&nbsp;paste&nbsp;the&nbsp;URL&nbsp;into&nbsp;your&nbsp;browser):&lt;/p&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1265</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;'.$url.'&lt;/p&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1266</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1267</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/html&gt;</span></code></td></tr><tr><td class="coverageDetails"><span>1268</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';*/</span></code></td></tr><tr><td class="coverageDetails"><span>1269</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;To&nbsp;send&nbsp;HTML&nbsp;mail,&nbsp;the&nbsp;Content-type&nbsp;header&nbsp;must&nbsp;be&nbsp;set</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1270</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;&nbsp;=&nbsp;'MIME-Version:&nbsp;1.0'&nbsp;.&nbsp;&quot;\n&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1271</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;.=&nbsp;'Content-type:&nbsp;text/html;&nbsp;charset=iso-8859-1'&nbsp;.&nbsp;&quot;\n&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1272</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$headers&nbsp;.=&nbsp;'From:&nbsp;usher.com&nbsp;&lt;noreply@usher.com&gt;'&nbsp;.&nbsp;&quot;\n&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1273</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$headers&nbsp;.=&nbsp;'Bcc:&nbsp;birthdaycheck@example.com'&nbsp;.&nbsp;&quot;\r\n&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1274</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Mail&nbsp;it</span></code></td></tr><tr><td class="coverageDetails"><span>1275</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//mail($email,&nbsp;$subject,&nbsp;$message,&nbsp;$headers);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1276</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$message&nbsp;=&nbsp;'Usher&nbsp;received&nbsp;a&nbsp;request&nbsp;to&nbsp;reset&nbsp;the&nbsp;password&nbsp;for&nbsp;your&nbsp;account.&nbsp;If&nbsp;you&nbsp;want&nbsp;to&nbsp;reset&nbsp;your&nbsp;password,&nbsp;click&nbsp;on&nbsp;the&nbsp;link&nbsp;below&nbsp;(or&nbsp;copy&nbsp;and&nbsp;paste&nbsp;the&nbsp;URL&nbsp;into&nbsp;your&nbsp;browser)';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1277</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;Util::mail_code($email,&nbsp;$subject,&nbsp;$message,&nbsp;$url,&nbsp;$headers);</span></code></td></tr><tr><td class="coverageDetails"><span>1278</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1279</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1280</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1281</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1282</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1283</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1284</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1285</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//-----------------------------------above&nbsp;is&nbsp;for&nbsp;account&nbsp;service-----------------------------------------------</span></code></td></tr><tr><td class="coverageDetails"><span>1286</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//-----------------------------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-----------------------------------------------</span></code></td></tr><tr><td class="coverageDetails"><span>1287</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1288</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1289</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//get&nbsp;badges&nbsp;of&nbsp;an&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span>1290</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;badges($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1291</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry&nbsp;=&nbsp;Logentry::getInstance();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1292</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;log_main(&quot;user&quot;,&nbsp;&quot;badges&quot;,&nbsp;&quot;all&nbsp;elapse&nbsp;time&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>1293</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1294</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1295</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1296</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1297</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1298</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//search&nbsp;in&nbsp;database&nbsp;by&nbsp;org&nbsp;id</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1299</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$connector_url&nbsp;=&nbsp;urldecode($_GET[&quot;connector_url&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1300</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1301</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;&nbsp;=&nbsp;$_GET[&quot;org_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1302</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$force_refresh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_GET[&quot;force_refresh&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1303</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$changed_since&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_GET[&quot;changed_since&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1304</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$include_default_badge&nbsp;=&nbsp;$_GET[&quot;include_default_badge&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1305</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$merge_account&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$_GET[&quot;merge_account&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1306</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($include_default_badge))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1307</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$include_default_badge&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>1308</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1309</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">1310</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1311</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1312</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1313</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1314</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1315</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$app_id&nbsp;=&nbsp;$user-&gt;get_application_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1316</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span>1317</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span>1318</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1319</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span>1320</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/**</span></code></td></tr><tr><td class="coverageDetails"><span>1321</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*1st&nbsp;usecase:</span></code></td></tr><tr><td class="coverageDetails"><span>1322</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*if&nbsp;specify&nbsp;&nbsp;org_id&nbsp;or&nbsp;connector_url,&nbsp;&nbsp;get&nbsp;the&nbsp;user's&nbsp;badge&nbsp;of&nbsp;the&nbsp;specified&nbsp;org</span></code></td></tr><tr><td class="coverageDetails"><span>1323</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1324</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(count($args)&nbsp;==&nbsp;1)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1325</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span>1326</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;org&nbsp;info</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1327</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find($org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1328</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$org)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1329</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOrgNotFoundException('Organization&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>1330</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1331</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if&nbsp;($connector_url)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1332</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//no&nbsp;org_id,&nbsp;but&nbsp;specify&nbsp;connector_url,</span></code></td></tr><tr><td class="coverageDetails"><span>1333</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//lookup&nbsp;org&nbsp;info&nbsp;by&nbsp;connector_url</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1334</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find_by_connector($connector_url);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1335</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$org)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1336</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOrgNotFoundException('Organization&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>1337</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1338</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1339</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($org)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1340</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_access_token)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1341</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;user&quot;,&nbsp;&quot;badges&quot;,&nbsp;&quot;org_login,&nbsp;for&nbsp;specify&nbsp;org&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1342</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;org_login($org_access_token,&nbsp;$org-&gt;get_id(),&nbsp;$app_id,&nbsp;$uvs_id,&nbsp;$merge_account);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1343</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span>1344</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1345</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Get&nbsp;the&nbsp;user's&nbsp;badges&nbsp;of&nbsp;the&nbsp;org</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1346</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;user&quot;,&nbsp;&quot;badges&quot;,&nbsp;&quot;load&nbsp;org&nbsp;badge,&nbsp;for&nbsp;specify&nbsp;org&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1347</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;$this-&gt;load_org_badge($user,&nbsp;$org,&nbsp;$org_access_token,&nbsp;$force_refresh);</span></code></td></tr><tr><td class="coverageDetails"><span>1348</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Note:Only&nbsp;add&nbsp;active&nbsp;log&nbsp;when&nbsp;access&nbsp;with&nbsp;$org_access_token</span></code></td></tr><tr><td class="coverageDetails"><span>1349</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_access_token){</span></code></td></tr><tr><td class="coverageDetails"><span>1350</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1351</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($badge-&gt;id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1352</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_model&nbsp;=&nbsp;Badge::find($badge-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>1353</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::save_active_log($badge_model,&nbsp;Activelog::$EVENT_TYPE_BADGE_ADDED,&nbsp;&quot;add&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>1354</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1355</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1356</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1357</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span>1358</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1359</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badges;</span></code></td></tr><tr><td class="coverageDetails"><span>1360</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1361</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1362</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/**</span></code></td></tr><tr><td class="coverageDetails"><span>1363</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*2rd&nbsp;usecase:</span></code></td></tr><tr><td class="coverageDetails"><span>1364</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*if&nbsp;no&nbsp;orgid&nbsp;,&nbsp;no&nbsp;connector_url,&nbsp;but&nbsp;have&nbsp;$changed_since,&nbsp;return&nbsp;all&nbsp;the&nbsp;badges&nbsp;that&nbsp;has&nbsp;changed&nbsp;since&nbsp;timestamp</span></code></td></tr><tr><td class="coverageDetails"><span>1365</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*for&nbsp;fetching&nbsp;modified&nbsp;badge&nbsp;since&nbsp;given&nbsp;timestamp</span></code></td></tr><tr><td class="coverageDetails"><span>1366</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1367</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($changed_since&nbsp;&gt;&nbsp;0)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1368</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;user&quot;,&nbsp;&quot;badges&quot;,&nbsp;&quot;load&nbsp;badges,&nbsp;for&nbsp;changed&nbsp;since&nbsp;timestamp&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1369</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signed_badges&nbsp;=&nbsp;Badge::find_by_update_time($uvs_id,&nbsp;$changed_since);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1370</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$signed_badges)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1371</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1372</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1373</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1374</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(&nbsp;$signed_badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1375</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;Badge::merge_badge_condition_trackable($badge-&gt;get_detail());</span></code></td></tr><tr><td class="coverageDetails"><span>1376</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1377</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;sort_badges($uvs_id,&nbsp;$response);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1378</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1379</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1380</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1381</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1382</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/**</span></code></td></tr><tr><td class="coverageDetails"><span>1383</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*3th&nbsp;usecase</span></code></td></tr><tr><td class="coverageDetails"><span>1384</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*if&nbsp;no&nbsp;orgid&nbsp;,&nbsp;no&nbsp;connector_url,&nbsp;no&nbsp;changed_since&nbsp;,&nbsp;return&nbsp;cached&nbsp;badges&nbsp;of&nbsp;all&nbsp;orgs&nbsp;(update&nbsp;them&nbsp;if&nbsp;needed)</span></code></td></tr><tr><td class="coverageDetails"><span>1385</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**/</span></code></td></tr><tr><td class="coverageDetails"><span>1386</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//return&nbsp;array</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1387</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;user&quot;,&nbsp;&quot;badges&quot;,&nbsp;&quot;load&nbsp;and&nbsp;update&nbsp;all&nbsp;badges&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1388</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;get_and_update_all_badges($user,&nbsp;$uvs_id,&nbsp;$force_refresh,&nbsp;$include_default_badge,&nbsp;$app_id,&nbsp;$logentry);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1389</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1390</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(count($response)&nbsp;==&nbsp;0)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1391</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1392</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1393</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;sort_badges($uvs_id,&nbsp;$response);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1394</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1395</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1396</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1397</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//retrieve&nbsp;all&nbsp;the&nbsp;badges&nbsp;and&nbsp;refresh&nbsp;them&nbsp;if&nbsp;needed</span></code></td></tr><tr><td class="coverageDetails"><span>1398</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;get_and_update_all_badges($user,&nbsp;$uvs_id,&nbsp;$force_refresh,&nbsp;$include_default_badge,&nbsp;$app_id,&nbsp;$logentry=null)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1399</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1400</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$signed_badges&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1401</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$signed_badges)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1402</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1403</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1404</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1405</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(&nbsp;$signed_badges&nbsp;as&nbsp;$old_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1406</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$expiration&nbsp;=&nbsp;$old_badge-&gt;get_expiration();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1407</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache_time&nbsp;=&nbsp;$old_badge-&gt;get_cache_time();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1408</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$old_badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span>1409</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1410</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_id&nbsp;==&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1411</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$include_default_badge&nbsp;=&nbsp;(bool)$include_default_badge;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1412</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$include_default_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1413</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span></code></td></tr><tr><td class="coverageDetails"><span>1414</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1415</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1416</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//if&nbsp;the&nbsp;badge&nbsp;expired&nbsp;or&nbsp;is&nbsp;asked&nbsp;to&nbsp;refresh,&nbsp;refresh&nbsp;the&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1417</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_id&nbsp;!=&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;]&nbsp;&amp;&amp;&nbsp;$org_id&nbsp;!=&nbsp;Glob::$facebook_badge_settings[&quot;orgid&quot;]</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">+1418</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;(&nbsp;$expiration&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$cache_time&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$force_refresh&nbsp;)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1419</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;start_sub(&quot;user&quot;,&nbsp;&quot;get_and_update_all_badges&quot;,&nbsp;&quot;reload&nbsp;badges&nbsp;from&nbsp;connector:&quot;.$app_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1420</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;update_exist_badge($org_id,&nbsp;$uvs_id,$old_badge,&nbsp;$app_id,&nbsp;$response);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1421</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;end_sub();</span></code></td></tr><tr><td class="coverageDetails"><span>1422</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1423</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//for&nbsp;default&nbsp;user&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1424</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($org_id&nbsp;==&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;]&nbsp;&amp;&amp;&nbsp;(&nbsp;$expiration&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$cache_time&nbsp;&lt;&nbsp;time()&nbsp;||&nbsp;$force_refresh&nbsp;)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1425</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$default_user_badge&nbsp;=&nbsp;$this-&gt;build_default_user_badge($user,&nbsp;$old_badge-&gt;get_appid(),&nbsp;$old_badge-&gt;get_id());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1426</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$default_user_badge-&gt;get_detail();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1427</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span></code></td></tr><tr><td class="coverageDetails"><span>1428</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1429</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;Badge::merge_badge_condition_trackable($old_badge-&gt;get_detail());</span></code></td></tr><tr><td class="coverageDetails"><span>1430</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1431</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1432</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1433</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1434</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1435</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//connect&nbsp;to&nbsp;org&nbsp;connector&nbsp;to&nbsp;get&nbsp;lateset&nbsp;badge&nbsp;info&nbsp;and&nbsp;then&nbsp;update&nbsp;the&nbsp;existed&nbsp;badge&nbsp;in&nbsp;usher&nbsp;db</span></code></td></tr><tr><td class="coverageDetails"><span>1436</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;update_exist_badge($org_id,&nbsp;$uvs_id,&nbsp;$old_badge,&nbsp;$app_id,&nbsp;$response)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1437</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find($org_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1438</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;cached&nbsp;`org_access_token`</span></code></td></tr><tr><td class="coverageDetails"><span>1439</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;$conn</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1440</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1441</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_token_info&nbsp;&nbsp;&nbsp;=&nbsp;Badge::fetch_user_token($conn,&nbsp;$uvs_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1442</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;$org_token_info[&quot;org_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1443</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$bresponse_by_connector&nbsp;=&nbsp;ORGConnector::request_badges($org-&gt;get_connector(),&nbsp;$org_access_token,&nbsp;$uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1444</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;$bresponse_by_connector-&gt;badges;</span></code></td></tr><tr><td class="coverageDetails"><span>1445</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1446</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($bresponse_by_connector-&gt;status&nbsp;==&nbsp;&quot;Connector&nbsp;timeout&quot;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1447</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$this-&gt;fill_error_badge($old_badge,&nbsp;&quot;error&quot;,&nbsp;610,&nbsp;&quot;Connector&nbsp;timeout&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1448</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1449</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1450</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($bresponse_by_connector-&gt;status&nbsp;==&nbsp;&quot;invalid&nbsp;token&quot;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1451</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$this-&gt;fill_error_badge($old_badge,&nbsp;&quot;error&quot;,&nbsp;611,&nbsp;&quot;Access&nbsp;token&nbsp;invalid&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1452</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1453</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1454</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$badges)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1455</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Note:&nbsp;Added&nbsp;on&nbsp;2012-12-10,&nbsp;remove&nbsp;the&nbsp;old&nbsp;badge&nbsp;from&nbsp;uvs&nbsp;database&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;badge&nbsp;from&nbsp;connector,&nbsp;otherwise&nbsp;it&nbsp;will&nbsp;always&nbsp;exsit&nbsp;in&nbsp;UVS&nbsp;DB</span></code></td></tr><tr><td class="coverageDetails"><span>1456</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Another&nbsp;question,&nbsp;there&nbsp;will&nbsp;be&nbsp;something&nbsp;tricky&nbsp;if&nbsp;someone&nbsp;has&nbsp;several&nbsp;badges&nbsp;in&nbsp;one&nbsp;organization&nbsp;and&nbsp;these&nbsp;badge&nbsp;invalid&nbsp;at&nbsp;different&nbsp;time</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1457</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete($old_badge-&gt;get_id());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1458</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1459</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1460</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!Util::check_badge_format($badges))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1461</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$this-&gt;fill_error_badge($old_badge,&nbsp;&quot;error&quot;,&nbsp;612,&nbsp;&quot;Invalid&nbsp;data&nbsp;returned&nbsp;by&nbsp;connector&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1462</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1463</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1464</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1465</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Note:&nbsp;Added&nbsp;on&nbsp;2012-12-10,&nbsp;remove&nbsp;the&nbsp;old&nbsp;badge&nbsp;from&nbsp;uvs&nbsp;database&nbsp;if&nbsp;there&nbsp;are&nbsp;correct&nbsp;response&nbsp;from&nbsp;connector,&nbsp;otherwise&nbsp;it&nbsp;will&nbsp;always&nbsp;exsit&nbsp;in&nbsp;UVS&nbsp;DB</span></code></td></tr><tr><td class="coverageDetails"><span>1466</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Another&nbsp;question,&nbsp;there&nbsp;will&nbsp;be&nbsp;something&nbsp;tricky&nbsp;if&nbsp;someone&nbsp;has&nbsp;several&nbsp;badges&nbsp;in&nbsp;one&nbsp;organization&nbsp;and&nbsp;these&nbsp;badge&nbsp;invalid&nbsp;at&nbsp;different&nbsp;time</span></code></td></tr><tr><td class="coverageDetails"><span>1467</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1468</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete($old_badge-&gt;get_id());</span></code></td></tr><tr><td class="coverageDetails"><span>1469</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1470</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1471</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;existing&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1472</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;Badge::handle_new_updated_badge($badge,&nbsp;$uvs_id,&nbsp;$org_id,&nbsp;$app_id,&nbsp;$org,&nbsp;$org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span>1473</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1474</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1475</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1476</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1477</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//update&nbsp;existing&nbsp;badge,&nbsp;move&nbsp;to&nbsp;badge&nbsp;model</span></code></td></tr><tr><td class="coverageDetails"><span>1478</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;/*private&nbsp;function&nbsp;handle_new_updated_badge($badge,&nbsp;$uvs_id,&nbsp;$org_id,&nbsp;$app_id,&nbsp;$org,&nbsp;$org_access_token)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1479</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Note:&nbsp;If&nbsp;the&nbsp;group&nbsp;name&nbsp;changed,&nbsp;cannot&nbsp;remove&nbsp;the&nbsp;old&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span>1480</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;if($badge_id_same_type&nbsp;=&nbsp;Badge::find_by_same_type($uvs_id,&nbsp;$org_id,&nbsp;$badge-&gt;badgeinfo-&gt;group,&nbsp;$badge-&gt;badgeinfo-&gt;name))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1481</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete($badge_id_same_type);</span></code></td></tr><tr><td class="coverageDetails"><span>1482</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1483</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$old_signed_badge&nbsp;=&nbsp;Badge::find_by_holder($uvs_id,&nbsp;$org_id,&nbsp;$badge-&gt;badgeinfo-&gt;group,&nbsp;$badge-&gt;badgeinfo-&gt;name);&nbsp;//It&nbsp;will&nbsp;reuse&nbsp;badgeid&nbsp;of&nbsp;`deleted`&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span>1484</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;if(!$old_signed_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1485</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_new_badge&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>1486</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1487</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_new_badge&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span>1488</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1489</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>1490</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;if($is_new_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1491</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Badge::id_generator();&nbsp;//badge_id,&nbsp;need&nbsp;to&nbsp;be&nbsp;generated</span></code></td></tr><tr><td class="coverageDetails"><span>1492</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1493</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_signed_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span>1494</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1495</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;orgid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$org_id;</span></code></td></tr><tr><td class="coverageDetails"><span>1496</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;appid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$app_id;</span></code></td></tr><tr><td class="coverageDetails"><span>1497</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;badgeinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$badge-&gt;badgeinfo;</span></code></td></tr><tr><td class="coverageDetails"><span>1498</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1499</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//sign&nbsp;badgeinfo_for_sign</span></code></td></tr><tr><td class="coverageDetails"><span>1500</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$sign_doc_input&nbsp;=&nbsp;array(&nbsp;&quot;passphrase&quot;&nbsp;=&gt;&nbsp;$org-&gt;get_key_passphrase(),&nbsp;&quot;document&quot;&nbsp;=&gt;&nbsp;json_encode($badgeinfo_for_sign)&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span>1501</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$signature&nbsp;=&nbsp;KSConnector::sign_doc($org-&gt;get_key_fingerprint(),&nbsp;$sign_doc_input);</span></code></td></tr><tr><td class="coverageDetails"><span>1502</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//create(store/update)&nbsp;signed_badge</span></code></td></tr><tr><td class="coverageDetails"><span>1503</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1504</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//TODO</span></code></td></tr><tr><td class="coverageDetails"><span>1505</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$signature&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span>1506</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1507</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$badgeid_from_connector&nbsp;=&nbsp;$badge-&gt;id;</span></code></td></tr><tr><td class="coverageDetails"><span>1508</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$format&nbsp;=&nbsp;$badge-&gt;meta-&gt;format;</span></code></td></tr><tr><td class="coverageDetails"><span>1509</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$timeCondition&nbsp;=&nbsp;isset($badge-&gt;time_condition)?$badge-&gt;time_condition:null;</span></code></td></tr><tr><td class="coverageDetails"><span>1510</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$locationCondition&nbsp;=&nbsp;isset($badge-&gt;location_condition)?$badge-&gt;location_condition:null;</span></code></td></tr><tr><td class="coverageDetails"><span>1511</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1512</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$signed_badge&nbsp;=&nbsp;Badge::create($uvs_id,&nbsp;$badgeinfo_for_sign,&nbsp;$badgeid_from_connector,&nbsp;$signature,&nbsp;$org-&gt;get_key_fingerprint(),&nbsp;$format,&nbsp;$badge-&gt;badgeinfo_additional,&nbsp;$is_new_badge,&nbsp;$timeCondition,&nbsp;$locationCondition);</span></code></td></tr><tr><td class="coverageDetails"><span>1513</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1514</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;Badge::merge_badge_condition_trackable($signed_badge-&gt;get_detail());</span></code></td></tr><tr><td class="coverageDetails"><span>1515</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1516</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;keys&nbsp;related&nbsp;to&nbsp;this&nbsp;bagde</span></code></td></tr><tr><td class="coverageDetails"><span>1517</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;if(isset($badgeinfo_for_sign-&gt;id))&nbsp;Badge::load_org_resources($uvs_id,&nbsp;$org,&nbsp;$org_access_token,&nbsp;$badgeinfo_for_sign-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>1518</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1519</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$result;</span></code></td></tr><tr><td class="coverageDetails"><span>1520</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}*/</span></code></td></tr><tr><td class="coverageDetails"><span>1521</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1522</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;fill_error_badge($old_badge,&nbsp;$status,&nbsp;$error_code,&nbsp;$erro_message){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1523</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1524</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1525</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1526</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;appid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_appid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1527</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;$status;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1528</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_groupname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1529</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$old_badge-&gt;get_orgname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1530</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$error_code;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1531</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;$erro_message;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1532</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_org_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1533</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badge_format&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_badge_format();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1534</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span>1535</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1536</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1537</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;load_org_badge($user,&nbsp;$org,&nbsp;$org_access_token,&nbsp;$force_refresh,&nbsp;$bresponse_by_connector&nbsp;=&nbsp;NULL){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1538</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1539</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$app_id&nbsp;=&nbsp;$user-&gt;get_application_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1540</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1541</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span>1542</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1543</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//The&nbsp;following&nbsp;is&nbsp;for&nbsp;get&nbsp;badges&nbsp;owned&nbsp;by&nbsp;one&nbsp;connector</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1544</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$org-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1545</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($org_access_token&nbsp;||&nbsp;$force_refresh)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1546</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//If&nbsp;org_access_token&nbsp;gives,&nbsp;contact&nbsp;ORG&nbsp;Connector&nbsp;to&nbsp;retrieve&nbsp;latest&nbsp;badges(will&nbsp;change&nbsp;logic&nbsp;to&nbsp;&lt;if&nbsp;a&nbsp;'new'&nbsp;org_access_token&nbsp;gives,&nbsp;....&gt;&nbsp;in&nbsp;later&nbsp;version&nbsp;)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1547</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$org_access_token)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1548</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;cached&nbsp;`org_access_token`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1549</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_token_info&nbsp;&nbsp;&nbsp;=&nbsp;Badge::fetch_user_token($conn,&nbsp;$uvs_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1550</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;$org_token_info[&quot;org_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>1551</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1552</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($bresponse_by_connector)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1553</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bresponse_by_connector&nbsp;=&nbsp;ORGConnector::request_badges($org-&gt;get_connector(),&nbsp;$org_access_token,&nbsp;$uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1554</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1555</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;$bresponse_by_connector-&gt;badges;</span></code></td></tr><tr><td class="coverageDetails"><span>1556</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1557</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($bresponse_by_connector-&gt;status&nbsp;==&nbsp;&quot;Connector&nbsp;timeout&quot;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1558</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1559</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$org-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1560</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1561</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$org-&gt;get_name();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1562</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;610;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1563</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Connector&nbsp;timeout&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1564</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$org-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1565</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1566</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1567</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;($bresponse_by_connector-&gt;status&nbsp;==&nbsp;&quot;invalid&nbsp;token&quot;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1568</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1569</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$org-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1570</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1571</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$org-&gt;get_name();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1572</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;611;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1573</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Access&nbsp;token&nbsp;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1574</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$org-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1575</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1576</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1577</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1578</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//response&nbsp;is&nbsp;ok</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1579</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$badges)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1580</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1581</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1582</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!Util::check_badge_format($badges))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1583</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1584</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$org-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1585</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1586</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$org-&gt;get_name();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1587</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;612;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1588</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Invalid&nbsp;data&nbsp;returned&nbsp;by&nbsp;connector&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1589</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$org-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1590</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1591</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1592</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1593</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;badge&nbsp;ID,&nbsp;OrgID,&nbsp;signature,&nbsp;key_fingerprint&nbsp;to&nbsp;the&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1594</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1595</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_added&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1596</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_id_same_type&nbsp;=&nbsp;Badge::find_by_same_type($uvs_id,&nbsp;$org_id,&nbsp;$badge-&gt;badgeinfo-&gt;group,&nbsp;$badge-&gt;badgeinfo-&gt;name);&nbsp;//same&nbsp;group,&nbsp;different&nbsp;holder&nbsp;name</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1597</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($badge_id_same_type)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1598</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete($badge_id_same_type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1599</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Key2::remove_by_badge($uvs_id,&nbsp;$badge_id_same_type,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1600</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_added&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span>1601</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1602</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_signed_badge&nbsp;=&nbsp;Badge::find_by_holder($uvs_id,&nbsp;$org_id,&nbsp;$badge-&gt;badgeinfo-&gt;group,&nbsp;$badge-&gt;badgeinfo-&gt;name);&nbsp;//It&nbsp;will&nbsp;reuse&nbsp;badgeid&nbsp;of&nbsp;`deleted`&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1603</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$old_signed_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1604</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_new_badge&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>1605</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1606</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_new_badge&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1607</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($old_signed_badge-&gt;get_status()&nbsp;==&nbsp;'active')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1608</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_added&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span>1609</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1610</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1611</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1612</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($is_new_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1613</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Badge::id_generator();&nbsp;//badge_id,&nbsp;need&nbsp;to&nbsp;be&nbsp;generated</span></code></td></tr><tr><td class="coverageDetails"><span>1614</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1615</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_signed_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span>1616</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1617</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;orgid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$org_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1618</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;appid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$app_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1619</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;badgeinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$badge-&gt;badgeinfo;</span></code></td></tr><tr><td class="coverageDetails"><span>1620</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1621</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//sign&nbsp;badgeinfo_for_sign</span></code></td></tr><tr><td class="coverageDetails"><span>1622</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$sign_doc_input&nbsp;=&nbsp;array(&nbsp;&quot;passphrase&quot;&nbsp;=&gt;&nbsp;$org-&gt;get_key_passphrase(),&nbsp;&quot;document&quot;&nbsp;=&gt;&nbsp;json_encode($badgeinfo_for_sign)&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span>1623</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$signature&nbsp;=&nbsp;KSConnector::sign_doc($org-&gt;get_key_fingerprint(),&nbsp;$sign_doc_input);</span></code></td></tr><tr><td class="coverageDetails"><span>1624</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//create(store/update)&nbsp;signed_badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1625</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeid_from_connector&nbsp;=&nbsp;$badge-&gt;id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1626</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$format&nbsp;=&nbsp;$badge-&gt;meta-&gt;format;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1627</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$timeCondition&nbsp;=&nbsp;isset($badge-&gt;time_condition)?$badge-&gt;time_condition:null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1628</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$locationCondition&nbsp;=&nbsp;isset($badge-&gt;location_condition)?$badge-&gt;location_condition:null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1629</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signed_badge&nbsp;=&nbsp;Badge::create($uvs_id,&nbsp;$badgeinfo_for_sign,&nbsp;$badgeid_from_connector,&nbsp;$signature,&nbsp;$org-&gt;get_key_fingerprint(),&nbsp;$format,&nbsp;$badge-&gt;badgeinfo_additional,&nbsp;$is_new_badge,&nbsp;$timeCondition,&nbsp;$locationCondition);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1630</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_detail&nbsp;=&nbsp;$signed_badge-&gt;get_detail();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1631</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_detail-&gt;trackable&nbsp;=&nbsp;$badge-&gt;trackable;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1632</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;Badge::merge_badge_condition_trackable($badge_detail);</span></code></td></tr><tr><td class="coverageDetails"><span>1633</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;to&nbsp;'badge&nbsp;order'</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1634</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::add_into_badges_order($uvs_id,&nbsp;$badgeinfo_for_sign-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>1635</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1636</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//get&nbsp;or&nbsp;update&nbsp;keys(resources)&nbsp;from&nbsp;connector</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1637</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($badgeinfo_for_sign-&gt;id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1638</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::load_org_resources($uvs_id,&nbsp;$org,&nbsp;$org_access_token,&nbsp;$badgeinfo_for_sign-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>1639</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1640</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}//end&nbsp;of&nbsp;foreach</span></code></td></tr><tr><td class="coverageDetails"><span>1641</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//update&nbsp;org_access_token&nbsp;in&nbsp;`org_token`</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1642</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i_org_token&nbsp;=&nbsp;$conn-&gt;escape($org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1643</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_token_info&nbsp;=&nbsp;Badge::fetch_user_token($conn,&nbsp;$uvs_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1644</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_token_id&nbsp;&nbsp;&nbsp;=&nbsp;$org_token_info[&quot;token_id&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1645</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$org_token_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1646</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;INSERT&nbsp;INTO&nbsp;org_token(org_id,&nbsp;uvs_id,&nbsp;org_token,&nbsp;update_time)&nbsp;VALUES&nbsp;($org_id,&nbsp;$uvs_id,&nbsp;$i_org_token,&nbsp;NOW())&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1647</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1648</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;org_token&nbsp;SET&nbsp;org_token&nbsp;=&nbsp;$i_org_token,&nbsp;update_time&nbsp;=&nbsp;NOW()&nbsp;WHERE&nbsp;token_id&nbsp;=&nbsp;$org_token_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1649</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1650</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1651</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1652</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Note:&nbsp;Only&nbsp;when&nbsp;badge&nbsp;is&nbsp;new&nbsp;add&nbsp;such&nbsp;an&nbsp;active&nbsp;log</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1653</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($is_added){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1654</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_model&nbsp;=&nbsp;Badge::find($badgeinfo_for_sign-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1655</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::save_active_log($badge_model,&nbsp;Activelog::$EVENT_TYPE_BADGE_ADDED,&nbsp;&quot;add&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>1656</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1657</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;{&nbsp;&nbsp;//If&nbsp;NO&nbsp;org_access_token,&nbsp;find&nbsp;cached&nbsp;badges&nbsp;in&nbsp;UVS</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1658</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signed_badges&nbsp;=&nbsp;&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1659</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$signed_badges)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1660</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1661</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1662</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;(&nbsp;$signed_badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1663</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;Badge::merge_badge_condition_trackable($badge-&gt;get_detail());</span></code></td></tr><tr><td class="coverageDetails"><span>1664</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1665</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1666</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;$this-&gt;sort_badges($uvs_id,&nbsp;$response,&nbsp;TRUE);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1667</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1668</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1669</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//move&nbsp;to&nbsp;badge&nbsp;model</span></code></td></tr><tr><td class="coverageDetails"><span>1670</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;/*private&nbsp;function&nbsp;load_org_resources($uvs_id,&nbsp;$org,&nbsp;$org_access_token,&nbsp;$badge_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1671</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resources_by_org&nbsp;=&nbsp;ORGConnector::request_resources($org-&gt;get_connector(),&nbsp;$org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span>1672</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Key2::remove_by_badge($uvs_id,&nbsp;$badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1673</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($resources_by_org)&nbsp;&amp;&amp;&nbsp;isset($resources_by_org-&gt;keys)&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1674</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;is_array($resources_by_org-&gt;keys))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1675</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($resources_by_org-&gt;keys&nbsp;as&nbsp;$key)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1676</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1677</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Key2::add_user_resources($uvs_id,&nbsp;$org-&gt;get_id(),&nbsp;$badge_id,&nbsp;$key);</span></code></td></tr><tr><td class="coverageDetails"><span>1678</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch(Exception&nbsp;$e)&nbsp;{}</span></code></td></tr><tr><td class="coverageDetails"><span>1679</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1680</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1681</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}*/</span></code></td></tr><tr><td class="coverageDetails"><span>1682</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1683</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;fill_test_badge($old_badge){</span></code></td></tr><tr><td class="coverageDetails"><span>1684</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//...just&nbsp;for&nbsp;error&nbsp;handling&nbsp;Testing</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1685</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($old_badge-&gt;get_holder()&nbsp;==&nbsp;'David&nbsp;Evans')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1686</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1687</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1688</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1689</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;appid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_appid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1690</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1691</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_groupname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1692</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$old_badge-&gt;get_orgname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1693</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;610;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1694</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Connector&nbsp;timeout&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1695</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_org_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1696</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badge_format&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_badge_format();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1697</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span>1698</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1699</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($old_badge-&gt;get_holder()&nbsp;==&nbsp;'Cesar&nbsp;Martinez')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1700</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1701</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1702</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1703</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;appid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_appid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1704</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1705</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_groupname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1706</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$old_badge-&gt;get_orgname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1707</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;611;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1708</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Access&nbsp;token&nbsp;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1709</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_org_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1710</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badge_format&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_badge_format();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1711</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span>1712</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1713</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($old_badge-&gt;get_holder()&nbsp;==&nbsp;'Ben&nbsp;Abramovitz')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1714</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1715</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1716</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1717</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;appid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_appid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1718</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1719</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_groupname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1720</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$old_badge-&gt;get_orgname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1721</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;630;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1722</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Badge&nbsp;Permanently&nbsp;Deleted&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1723</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_org_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1724</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badge_format&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_badge_format();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1725</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span>1726</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1727</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($old_badge-&gt;get_holder()&nbsp;==&nbsp;'Tsehaye&nbsp;Asrat')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1728</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1729</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1730</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;orgid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1731</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;appid&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_appid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1732</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;status&nbsp;&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1733</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_groupname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1734</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badgeinfo-&gt;orgname&nbsp;=&nbsp;$old_badge-&gt;get_orgname();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1735</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_code&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;612;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1736</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;error-&gt;error_message&nbsp;&nbsp;=&nbsp;&quot;Invalid&nbsp;data&nbsp;returned&nbsp;by&nbsp;connector&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1737</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;organization&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_org_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1738</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_error-&gt;badge_format&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge-&gt;get_badge_format();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1739</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge_error;</span></code></td></tr><tr><td class="coverageDetails"><span>1740</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1741</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span>1742</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1743</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//get&nbsp;anyone's&nbsp;default&nbsp;user&nbsp;badge&nbsp;by&nbsp;providing&nbsp;uvs_id</span></code></td></tr><tr><td class="coverageDetails"><span>1744</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;default_badge($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1745</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1746</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1747</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1748</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1749</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1750</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1751</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1752</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1753</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1754</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($uvs_id)&nbsp;&amp;&amp;&nbsp;is_numeric($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1755</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!User::find_by_uvs_id($uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1756</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadgeNotFoundException('The&nbsp;user&nbsp;is&nbsp;not&nbsp;exist!');</span></code></td></tr><tr><td class="coverageDetails"><span>1757</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1758</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1759</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>1760</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1761</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$default_user_badges&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1762</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$default_user_badges[0]-&gt;get_detail();</span></code></td></tr><tr><td class="coverageDetails"><span>1763</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1764</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1765</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1766</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//get&nbsp;organizations&nbsp;of&nbsp;an&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span>1767</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;orgs($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1768</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1769</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1770</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1771</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1772</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>1773</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1774</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1775</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1776</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1777</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1778</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1779</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1780</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$orgs&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1781</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$signed_badges&nbsp;=&nbsp;Badge::find_by_uvs_id($user-&gt;get_uvs_id());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1782</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$signed_badges)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1783</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;orgs&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1784</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1785</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1786</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($signed_badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1787</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$orgid&nbsp;=&nbsp;$badge-&gt;get_orgid();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1788</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find($orgid);</span></code></td></tr><tr><td class="coverageDetails"><span>1789</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$response-&gt;orgs[$org-&gt;get_name()]&nbsp;+=&nbsp;1;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1790</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[]&nbsp;=&nbsp;array(&quot;orgname&quot;&nbsp;=&gt;&nbsp;$org-&gt;get_name(),&nbsp;&quot;orgid&quot;&nbsp;=&gt;&nbsp;$orgid,&nbsp;&quot;group&quot;&nbsp;=&gt;&nbsp;$badge-&gt;get_groupname());</span></code></td></tr><tr><td class="coverageDetails"><span>1791</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1792</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1793</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1794</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1795</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1796</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;delete_badge($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1797</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1798</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1799</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1800</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1801</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//search&nbsp;in&nbsp;database&nbsp;by&nbsp;org&nbsp;id</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1802</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1803</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1804</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$_GET[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1805</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>1806</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1807</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1808</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1809</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1810</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1811</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1812</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($org_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1813</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1814</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($badges&nbsp;as&nbsp;$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1815</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;=&nbsp;$badge-&gt;get_id();&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1816</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete($badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1817</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete_from_badges_order($uvs_id,&nbsp;$badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1818</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;the&nbsp;keys&nbsp;related&nbsp;to&nbsp;this&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1819</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Key2::remove_by_badge($uvs_id,&nbsp;$badge_id,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1820</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::save_active_log($badge,&nbsp;Activelog::$EVENT_TYPE_BADGE_REMOVED,&nbsp;&quot;remove&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>1821</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1822</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1823</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find($badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1824</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1825</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadgeNotFoundException('Badge&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>1826</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$response-&gt;status&nbsp;=&nbsp;&quot;badge&nbsp;not&nbsp;found&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1827</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1828</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1829</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;$badge-&gt;get_uvs_id()&nbsp;!=&nbsp;$uvs_id&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1830</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerPemissionDeniedException('You&nbsp;are&nbsp;not&nbsp;the&nbsp;owner&nbsp;of&nbsp;this&nbsp;badge');</span></code></td></tr><tr><td class="coverageDetails"><span>1831</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1832</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete($badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1833</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::delete_from_badges_order($uvs_id,&nbsp;$badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span>1834</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1835</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;the&nbsp;keys&nbsp;related&nbsp;to&nbsp;this&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1836</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Key2::remove_by_badge($uvs_id,&nbsp;$badge_id,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span>1837</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1838</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::save_active_log($badge,&nbsp;Activelog::$EVENT_TYPE_BADGE_REMOVED,&nbsp;&quot;remove&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>1839</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1840</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1841</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1842</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1843</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1844</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;badgecode($args)&nbsp;{&nbsp;&nbsp;&nbsp;//it&nbsp;will&nbsp;always&nbsp;generate&nbsp;a&nbsp;new&nbsp;code&nbsp;for&nbsp;a&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1845</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1846</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1847</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1848</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1849</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//search&nbsp;in&nbsp;database&nbsp;by&nbsp;org&nbsp;id</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1850</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1851</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1852</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>1853</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1854</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1855</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1856</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1857</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1858</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find($badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1859</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1860</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadgeNotFoundException('Badge&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>1861</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$response-&gt;status&nbsp;=&nbsp;&quot;badge&nbsp;not&nbsp;found&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1862</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1863</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1864</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;$badge-&gt;get_uvs_id()&nbsp;!=&nbsp;$user-&gt;get_uvs_id()&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1865</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerPemissionDeniedException('You&nbsp;are&nbsp;not&nbsp;the&nbsp;owner&nbsp;of&nbsp;this&nbsp;badge');</span></code></td></tr><tr><td class="coverageDetails"><span>1866</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1867</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1868</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;UsherCode::create($user-&gt;get_uvs_id(),&nbsp;$badge_id,&nbsp;ASSET_TYPE_BADGE,&nbsp;BADGE_CODE_EXPIRATION);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1869</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1870</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1871</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1872</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1873</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;/*</span></code></td></tr><tr><td class="coverageDetails"><span>1874</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;Assumption:&nbsp;changable&nbsp;field&nbsp;--&nbsp;field&nbsp;which&nbsp;could&nbsp;be&nbsp;out&nbsp;of&nbsp;date,&nbsp;such&nbsp;as&nbsp;groupname.</span></code></td></tr><tr><td class="coverageDetails"><span>1875</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;1.&nbsp;Verify&nbsp;offline&nbsp;information(content)&nbsp;with&nbsp;public&nbsp;key,</span></code></td></tr><tr><td class="coverageDetails"><span>1876</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;1.1&nbsp;if&nbsp;offline&nbsp;content&nbsp;is&nbsp;ok,&nbsp;&nbsp;go&nbsp;to&nbsp;2</span></code></td></tr><tr><td class="coverageDetails"><span>1877</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;1.2&nbsp;otherwise,&nbsp;return&nbsp;NULL</span></code></td></tr><tr><td class="coverageDetails"><span>1878</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;2.&nbsp;Check&nbsp;content&nbsp;fields&nbsp;with&nbsp;UVS&nbsp;cached&nbsp;badge,&nbsp;and&nbsp;get&nbsp;mismatched&nbsp;fields</span></code></td></tr><tr><td class="coverageDetails"><span>1879</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;2.1&nbsp;if&nbsp;all&nbsp;the&nbsp;mismatched&nbsp;fields&nbsp;are&nbsp;changable&nbsp;fields,&nbsp;go&nbsp;step&nbsp;3,</span></code></td></tr><tr><td class="coverageDetails"><span>1880</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;2.2&nbsp;otherwise,&nbsp;return&nbsp;NULL</span></code></td></tr><tr><td class="coverageDetails"><span>1881</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;3.&nbsp;Return&nbsp;cached&nbsp;badge&nbsp;(including&nbsp;online&nbsp;information)&nbsp;and&nbsp;marked&nbsp;mismatched&nbsp;fields</span></code></td></tr><tr><td class="coverageDetails"><span>1882</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span>1883</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;verify_badge($args){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1884</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1885</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>1886</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1887</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1888</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1889</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign&nbsp;=&nbsp;$input-&gt;badgeinfo_for_sign;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1890</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($badgeinfo_for_sign)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1891</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Cannot&nbsp;extract&nbsp;Content');</span></code></td></tr><tr><td class="coverageDetails"><span>1892</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1893</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;json_decode($badgeinfo_for_sign)-&gt;id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1894</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$orgid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;json_decode($badgeinfo_for_sign)-&gt;orgid;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1895</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;is_null($badge_id)&nbsp;||&nbsp;is_null($orgid)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1896</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Cannot&nbsp;extract&nbsp;BadgeID&nbsp;or&nbsp;OrgID');</span></code></td></tr><tr><td class="coverageDetails"><span>1897</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1898</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1899</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;1</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1900</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!&nbsp;Util::check_signature($input)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>1901</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$response-&gt;warning&nbsp;=&nbsp;&quot;offline&nbsp;info&nbsp;modified&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1902</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1903</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1904</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1905</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;valid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1906</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$signed_badge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Badge::find($badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1907</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$signed_badge){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1908</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadgeNotFoundException('Badge&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>1909</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1910</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$signed_badge_detail&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$signed_badge-&gt;get_detail();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1911</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$signed_badge_true_badgeinfo&nbsp;=&nbsp;$signed_badge_detail-&gt;badgeinfo_for_sign;</span></code></td></tr><tr><td class="coverageDetails"><span>1912</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//step&nbsp;2</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1913</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($badgeinfo_for_sign&nbsp;!=&nbsp;$signed_badge_true_badgeinfo)&nbsp;{&nbsp;//check&nbsp;if&nbsp;badge&nbsp;content&nbsp;is&nbsp;the&nbsp;exactly&nbsp;the&nbsp;same</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1914</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;warning&nbsp;=&nbsp;&quot;online&nbsp;info&nbsp;changed&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>1915</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1916</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//..find&nbsp;out&nbsp;which&nbsp;field&nbsp;is&nbsp;changed</span></code></td></tr><tr><td class="coverageDetails"><span>1917</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//..</span></code></td></tr><tr><td class="coverageDetails"><span>1918</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1919</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1920</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>1921</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//send&nbsp;successfully-validated&nbsp;badge&nbsp;to&nbsp;Org&nbsp;connector&nbsp;(For&nbsp;tracking&nbsp;frequency&nbsp;of&nbsp;badge&nbsp;usage)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1922</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Org::find($orgid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1923</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;NULL;&nbsp;&nbsp;//$org_access_token&nbsp;should&nbsp;be&nbsp;obtained&nbsp;from&nbsp;user&nbsp;account&nbsp;service.</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1924</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;ORGConnector::notification($org-&gt;get_connector(),&nbsp;json_encode($signed_badge_detail),&nbsp;$org_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span>1925</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1926</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;valid_for&nbsp;=&nbsp;$signed_badge_detail;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1927</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1928</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1929</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>1930</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//verify&nbsp;a&nbsp;ushercode&nbsp;from&nbsp;badge,&nbsp;doc&nbsp;....</span></code></td></tr><tr><td class="coverageDetails"><span>1931</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;verify_ushercode($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1932</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1933</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>1934</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1935</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1936</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>1937</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1938</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1939</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1940</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>1941</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1942</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id_recipient&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>1943</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1944</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(Util::is_new_client($_GET[&quot;rev&quot;]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1945</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($usher_code,&nbsp;$checksum)&nbsp;=&nbsp;explode(&quot;_&quot;,&nbsp;$args[0]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1946</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($checksum&nbsp;!=&nbsp;md5($usher_code&nbsp;.&nbsp;User::get_public_key($uvs_id_recipient,&nbsp;false)))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1947</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1948</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1949</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1950</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1951</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$usher_code&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span>1952</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>1953</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1954</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;UsherCode::verify_code($usher_code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1955</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$result)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1956</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1957</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1958</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1959</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;valid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1960</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($result[&quot;asset_type&quot;]&nbsp;==&nbsp;ASSET_TYPE_BADGE)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1961</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find($result[&quot;asset_id&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1962</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$badge){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1963</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1964</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>1965</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1966</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;badge&nbsp;=&nbsp;$badge-&gt;get_detail();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1967</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;($result[&quot;asset_type&quot;]&nbsp;==&nbsp;ASSET_TYPE_DOC)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1968</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$doc_id&nbsp;=&nbsp;$result[&quot;asset_id&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1969</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(Doc::find_shared_by_id($doc_id,&nbsp;$uvs_id_recipient))&nbsp;{&nbsp;&nbsp;//change&nbsp;status&nbsp;to&nbsp;'accepted'</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1970</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1971</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;doc_share&nbsp;SET&nbsp;status&nbsp;=&nbsp;'accepted'&nbsp;WHERE&nbsp;doc_id&nbsp;=&nbsp;$doc_id&nbsp;AND&nbsp;uvs_id_recipient&nbsp;=&nbsp;$uvs_id_recipient&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1972</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Doc::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>1973</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1974</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Doc::add_shard_info(&nbsp;$result[&quot;asset_id&quot;],&nbsp;$result[&quot;uvs_id&quot;],&nbsp;$uvs_id_recipient,&nbsp;&quot;ushercode&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1975</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;doc&nbsp;=&nbsp;Doc::doc_by_id($result[&quot;asset_id&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1976</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($response-&gt;doc)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1977</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;doc-&gt;sent_time&nbsp;=&nbsp;time();</span></code></td></tr><tr><td class="coverageDetails"><span>1978</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1979</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;($result[&quot;asset_type&quot;]&nbsp;==&nbsp;ASSET_TYPE_KEY){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1980</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$shared_with&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1981</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_id&nbsp;=&nbsp;$result['asset_id'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1982</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$shared_by&nbsp;=&nbsp;$result['uvs_id'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1983</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($shared_with&nbsp;===&nbsp;$shared_by){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1984</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerKeyShareException('You&nbsp;can&nbsp;not&nbsp;share&nbsp;key&nbsp;to&nbsp;yourself');</span></code></td></tr><tr><td class="coverageDetails"><span>1985</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1986</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$json&nbsp;=&nbsp;$result['extra_info'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1987</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extro&nbsp;=&nbsp;json_decode($json);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1988</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid_from&nbsp;=&nbsp;$extro-&gt;valid_from;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1989</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid_until&nbsp;=&nbsp;$extro-&gt;valid_until;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1990</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resource&nbsp;=&nbsp;Key2::get_by_id($key_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1991</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resource_id&nbsp;=&nbsp;$resource-&gt;resource_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1992</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resource_name&nbsp;=&nbsp;$resource-&gt;resource_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1993</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_id&nbsp;=&nbsp;$resource-&gt;orgid;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1994</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1995</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;org_id&quot;]&nbsp;=&nbsp;$org_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1996</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;key_id&quot;]&nbsp;=&nbsp;$key_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1997</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;resource_name&quot;]&nbsp;=&nbsp;$resource_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1998</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;shared_by&quot;]&nbsp;=&nbsp;$shared_by;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">1999</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;shared_with&quot;]&nbsp;=&nbsp;$shared_with;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2000</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;valid_from&quot;]&nbsp;=&nbsp;$valid_from;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2001</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key[&quot;valid_until&quot;]&nbsp;=&nbsp;$valid_until;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2002</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$share_info&nbsp;=&nbsp;Key2::save_shared_key($key);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2003</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Key2::save_active_log($resource_id,&nbsp;$resource_name,&nbsp;$shared_by,&nbsp;$shared_with,&nbsp;&quot;ushercode&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2004</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2005</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;name&nbsp;=&nbsp;$share_info-&gt;name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2006</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;share_id&nbsp;&nbsp;=&nbsp;$share_info-&gt;share_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2007</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;shared_with&nbsp;=&nbsp;$shared_with;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2008</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;orgid&nbsp;=&nbsp;$org_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2009</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;key_id&nbsp;=&nbsp;$key_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2010</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;valid_from&nbsp;=&nbsp;$valid_from;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2011</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;valid_until&nbsp;=&nbsp;$valid_until;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2012</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;instances&nbsp;=&nbsp;$resource-&gt;instances;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2013</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;description&nbsp;=&nbsp;$resource-&gt;description;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2014</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;icon_url&nbsp;=&nbsp;$resource-&gt;icon_url;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2015</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;background_url&nbsp;=&nbsp;$resource-&gt;background_url;</span></code></td></tr><tr><td class="coverageDetails"><span>2016</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$shared_by_user&nbsp;=&nbsp;User::find_by_uvs_id($shared_by);</span></code></td></tr><tr><td class="coverageDetails"><span>2017</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$key_object-&gt;shared_by&nbsp;=&nbsp;$shared_by_user-&gt;get_basic_info();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2018</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key_object-&gt;shared_by&nbsp;=&nbsp;$resource-&gt;shared_by;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2019</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;key&nbsp;=&nbsp;$key_object;</span></code></td></tr><tr><td class="coverageDetails"><span>2020</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2021</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2022</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2023</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2024</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;verify_badgecode($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2025</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2026</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2027</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2028</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2029</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span>2030</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2031</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2032</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2033</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2034</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2035</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//search&nbsp;in&nbsp;database&nbsp;by&nbsp;org&nbsp;id</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2036</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(count($args)&nbsp;==&nbsp;1)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2037</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge_code&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2038</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find_by_code($badge_code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2039</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;(count($args)&nbsp;&gt;=&nbsp;2)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2040</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($args[0]&nbsp;==&nbsp;'qr'&nbsp;||&nbsp;$args[0]&nbsp;==&nbsp;'sonic')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2041</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Fixing&nbsp;for&nbsp;QR&nbsp;strings&nbsp;that&nbsp;contain&nbsp;slashes</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2042</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array_shift($args);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2043</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$qr_code&nbsp;=&nbsp;implode(&quot;/&quot;,$args);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2044</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeid&nbsp;=&nbsp;Util::validate_qr($qr_code,&nbsp;$user-&gt;get_uvs_id());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2045</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;is_numeric($badgeid)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2046</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find(&nbsp;intval($badgeid)&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span>2047</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2048</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2049</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2050</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2051</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2052</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2053</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2054</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2055</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//throw&nbsp;new&nbsp;ControllerFindRequestException('Invalid&nbsp;badge&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2056</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2057</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2058</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2059</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;valid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2060</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;badge&nbsp;=&nbsp;$badge-&gt;get_detail();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2061</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2062</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2063</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2064</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2065</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;process_tag($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2066</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2067</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2068</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2069</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2070</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$logentry&nbsp;=&nbsp;Logentry::getInstance();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2071</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$logentry-&gt;log_main(&quot;user&quot;,&nbsp;&quot;badges&quot;,&nbsp;&quot;all&nbsp;elapse&nbsp;time&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2072</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2073</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>2074</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2075</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2076</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2077</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2078</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2079</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$qr_code&nbsp;=&nbsp;implode(&quot;/&quot;,$args);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2080</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;Util::process_tag_qr($qr_code,&nbsp;$user-&gt;get_uvs_id());</span></code></td></tr><tr><td class="coverageDetails"><span>2081</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2082</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2083</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2084</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2085</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2086</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;process_tag_with_badgecode($args)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//support&nbsp;qr&nbsp;&amp;&nbsp;sonic&nbsp;badge&nbsp;code</span></code></td></tr><tr><td class="coverageDetails"><span>2087</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2088</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2089</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_qr_code&nbsp;=&nbsp;implode(&quot;/&quot;,$args);</span></code></td></tr><tr><td class="coverageDetails"><span>2090</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2091</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$tag_code&nbsp;=&nbsp;$_GET[&quot;tag_code&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2092</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$check_only&nbsp;=&nbsp;$_GET[&quot;check_only&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2093</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2094</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2095</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2096</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2097</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2098</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($check_only)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2099</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extra_session_data&nbsp;=&nbsp;Array&nbsp;(&quot;check_only&quot;=&gt;1);</span></code></td></tr><tr><td class="coverageDetails"><span>2100</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2101</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2102</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badgeid&nbsp;=&nbsp;Util::validate_qr($badge_qr_code,&nbsp;$user-&gt;get_uvs_id());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2103</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;is_numeric($badgeid)&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2104</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find(&nbsp;intval($badgeid)&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span>2105</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2106</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2107</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2108</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;invalid&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2109</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2110</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2111</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;Util::process_tag_qr($tag_code,&nbsp;$badge-&gt;get_uvs_id(),&nbsp;NULL,&nbsp;$extra_session_data);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2112</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2113</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2114</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2115</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2116</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2117</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;register_mac_addr($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2118</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2119</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2120</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2121</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2122</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2123</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2124</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2125</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2126</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$orgid&nbsp;=&nbsp;(int)$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2127</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$mac_addr&nbsp;=&nbsp;$input-&gt;mac_addr;</span></code></td></tr><tr><td class="coverageDetails"><span>2128</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;if&nbsp;the&nbsp;user&nbsp;has&nbsp;a&nbsp;given&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2129</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$orgid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2130</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;count($badges)&nbsp;&gt;&nbsp;0&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2131</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_token_info&nbsp;&nbsp;&nbsp;=&nbsp;Badge::fetch_user_token($conn,&nbsp;$uvs_id,&nbsp;$orgid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2132</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;$org_token_info[&quot;org_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2133</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find($orgid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2134</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;ORGConnector::register_mac_addr($org-&gt;get_connector(),&nbsp;$org_access_token,&nbsp;$mac_addr);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2135</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2136</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2137</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2138</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2139</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;deactivate_mac_addr($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2140</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2141</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2142</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2143</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2144</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2145</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2146</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2147</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2148</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$orgid&nbsp;=&nbsp;(int)$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2149</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$mac_addr&nbsp;=&nbsp;$input-&gt;mac_addr;</span></code></td></tr><tr><td class="coverageDetails"><span>2150</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;if&nbsp;the&nbsp;user&nbsp;has&nbsp;a&nbsp;given&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2151</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badges&nbsp;=&nbsp;Badge::find_by_uvs_id($uvs_id,&nbsp;$orgid);</span></code></td></tr><tr><td class="coverageDetails"><span>2152</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2153</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;count($badges)&nbsp;&gt;&nbsp;0&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2154</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_token_info&nbsp;&nbsp;&nbsp;=&nbsp;Badge::fetch_user_token($conn,&nbsp;$uvs_id,&nbsp;$orgid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2155</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org_access_token&nbsp;=&nbsp;$org_token_info[&quot;org_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2156</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$org&nbsp;=&nbsp;Org::find($orgid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2157</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;ORGConnector::deactivate_mac_addr($org-&gt;get_connector(),&nbsp;$org_access_token,&nbsp;$mac_addr);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2158</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2159</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2160</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2161</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2162</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;displayedBadge($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2163</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>2164</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2165</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2166</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;delete_email($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2167</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2168</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2169</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2170</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2171</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2172</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2173</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2174</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2175</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2176</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2177</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2178</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2179</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!User::is_emailid_belong_to_user($email_id,&nbsp;$uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2180</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidEmailIdException('Invalid&nbsp;email&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2181</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2182</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2183</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(User::is_primary_email($email_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2184</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerPrimEmailPermissionDeniedException(&quot;Primary&nbsp;email&nbsp;cannot&nbsp;be&nbsp;deleted&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2185</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2186</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2187</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2188</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$e_email_id&nbsp;=&nbsp;$conn-&gt;escape($email_id);</span></code></td></tr><tr><td class="coverageDetails"><span>2189</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2190</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;badges&nbsp;associated&nbsp;with&nbsp;this&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2191</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2192</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2193</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$del_email&nbsp;=&nbsp;$result[&quot;email&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2194</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$i_email&nbsp;=&nbsp;$conn-&gt;escape($result[&quot;email&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2195</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;select&nbsp;badgeid&nbsp;from&nbsp;badge&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;orgid&nbsp;in&nbsp;(&nbsp;SELECT&nbsp;org_id&nbsp;FROM&nbsp;org_token&nbsp;where&nbsp;email&nbsp;=&nbsp;$i_email&nbsp;AND&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;)&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2196</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$to_delete_badges&nbsp;=&nbsp;$conn-&gt;select_all($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2197</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;badge&nbsp;SET&nbsp;status&nbsp;='deleted',&nbsp;update_time&nbsp;=&nbsp;NOW()&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;orgid&nbsp;in&nbsp;(&nbsp;SELECT&nbsp;org_id&nbsp;FROM&nbsp;org_token&nbsp;where&nbsp;email&nbsp;=&nbsp;$i_email&nbsp;AND&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;)&quot;;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2198</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2199</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($to_delete_badges)&nbsp;and&nbsp;is_array($to_delete_badges)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2200</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($to_delete_badges&nbsp;as&nbsp;$id_record){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2201</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::find($id_record[&quot;badgeid&quot;],&nbsp;false);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2202</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::save_active_log($badge,&nbsp;Activelog::$EVENT_TYPE_BADGE_REMOVED,&nbsp;&quot;remove&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2203</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2204</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2205</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2206</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;facebook_token&nbsp;where&nbsp;email&nbsp;=&nbsp;$i_email&nbsp;AND&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2207</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2208</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($result)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2209</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$facebook_org_id&nbsp;=&nbsp;Glob::$facebook_badge_settings['orgid'];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2210</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;badge&nbsp;SET&nbsp;status&nbsp;='deleted',&nbsp;update_time&nbsp;=&nbsp;NOW()&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;orgid&nbsp;=&nbsp;$facebook_org_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2211</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2212</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2213</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2214</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;keys</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2215</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;user_resource&nbsp;SET&nbsp;status&nbsp;='deleted',&nbsp;update_time&nbsp;=&nbsp;NOW()&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;org_id&nbsp;in&nbsp;(&nbsp;SELECT&nbsp;org_id&nbsp;FROM&nbsp;org_token&nbsp;where&nbsp;email&nbsp;=&nbsp;$i_email&nbsp;AND&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;)&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2216</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2217</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2218</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;shared_resource</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2219</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;shared_resource&nbsp;SET&nbsp;status&nbsp;='deleted',&nbsp;update_time&nbsp;=&nbsp;NOW()&nbsp;where&nbsp;shared_by&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2220</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2221</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2222</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;from&nbsp;org&nbsp;token</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2223</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;org_token&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;email&nbsp;=&nbsp;$i_email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2224</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2225</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2226</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//delete&nbsp;FB&nbsp;info</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2227</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;facebook_token&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;email&nbsp;=&nbsp;$i_email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2228</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2229</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($result)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2230</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account&nbsp;SET&nbsp;fb_id&nbsp;=&nbsp;$conn-&gt;escape(NULL)&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2231</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2232</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2233</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;facebook_token&nbsp;where&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;email&nbsp;=&nbsp;$i_email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2234</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2235</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2236</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2237</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2238</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2239</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2240</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;email_confirmation&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2241</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2242</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2243</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2244</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2245</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2246</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//NOTE:&nbsp;remove&nbsp;email&nbsp;active&nbsp;log</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2247</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;User::save_active_log($uvs_id,&nbsp;$del_email,&nbsp;ActiveLog::$EVENT_TYPE_EMAIL_REMOVE);</span></code></td></tr><tr><td class="coverageDetails"><span>2248</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2249</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2250</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2251</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2252</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;claim_primary_email($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2253</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2254</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2255</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2256</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2257</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2258</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2259</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2260</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2261</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2262</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2263</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$email_id&nbsp;=&nbsp;$args[0];&nbsp;&nbsp;//the&nbsp;email&nbsp;which&nbsp;want&nbsp;to&nbsp;be&nbsp;set&nbsp;to&nbsp;primary</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2264</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2265</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!User::is_emailid_belong_to_user($email_id,&nbsp;$uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2266</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidEmailIdException('Invalid&nbsp;email&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2267</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2268</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!User::is_confirmed_email($email_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2269</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidEmailIdException('Invalid&nbsp;email&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2270</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2271</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2272</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;uvs_id&nbsp;=&nbsp;$uvs_id&nbsp;AND&nbsp;confirmed&nbsp;=&nbsp;1&nbsp;AND&nbsp;is_primary&nbsp;=&nbsp;1&quot;;&nbsp;&nbsp;//get&nbsp;current&nbsp;primary&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2273</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2274</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$row&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2275</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$is_success&nbsp;=&nbsp;User::send_email_code((int)$row['email_id'],&nbsp;$row['email'],&nbsp;$email_id,&nbsp;TRUE);</span></code></td></tr><tr><td class="coverageDetails"><span>2276</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2277</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2278</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($is_success)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2279</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2280</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2281</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;failed&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2282</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2283</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2284</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2285</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2286</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;confirm_primary_email($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2287</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2288</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2289</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2290</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2291</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;verify&nbsp;uvs&nbsp;token</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2292</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2293</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2294</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2295</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2296</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2297</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2298</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;parameter&nbsp;input</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2299</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$email_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2300</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($email_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2301</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;Parameter&nbsp;email&nbsp;id&nbsp;OR&nbsp;confirmation&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span>2302</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2303</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$confirmation_code&nbsp;=&nbsp;$args[1];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2304</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($confirmation_code))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2305</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;Parameter&nbsp;email&nbsp;id&nbsp;OR&nbsp;confirmation&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span>2306</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2307</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2308</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;confirmation&nbsp;code</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2309</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$confirm_user&nbsp;=&nbsp;User::find_by_email_code($confirmation_code,&nbsp;$email_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2310</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$confirm_user&nbsp;||&nbsp;$confirm_user-&gt;get_uvs_id()&nbsp;!=&nbsp;$user-&gt;get_uvs_id())&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2311</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCodeException('Invalid&nbsp;confirmation&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span>2312</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2313</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2314</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2315</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;whether&nbsp;input&nbsp;email_id&nbsp;is&nbsp;valid</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2316</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn&nbsp;=&nbsp;UVSDatabase::create_connection();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2317</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$e_email_id&nbsp;=&nbsp;$conn-&gt;escape($email_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2318</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2319</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2320</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!row)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2321</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidEmailId('Invalid&nbsp;email&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2322</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2323</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$to_email&nbsp;=&nbsp;$row['email'];</span></code></td></tr><tr><td class="coverageDetails"><span>2324</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2325</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;confirmation&nbsp;code&nbsp;receiver's&nbsp;uvs_id&nbsp;is&nbsp;equal&nbsp;to&nbsp;future&nbsp;primary&nbsp;email&nbsp;user's&nbsp;uvs_id</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2326</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2327</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$confirm_user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2328</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((int)$row['uvs_id']&nbsp;!=&nbsp;$uvs_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2329</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;failed&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2330</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2331</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2332</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;change&nbsp;primary&nbsp;email</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2333</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$current_primary_email_id&nbsp;=&nbsp;$confirm_user-&gt;get_email_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2334</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;SELECT&nbsp;*&nbsp;FROM&nbsp;account_email&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$current_primary_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2335</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row&nbsp;=&nbsp;$conn-&gt;select_first($query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2336</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($row)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2337</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$from_email&nbsp;=&nbsp;$row['email'];</span></code></td></tr><tr><td class="coverageDetails"><span>2338</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2339</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;email_confirmation&nbsp;SET&nbsp;confirmation_time&nbsp;=&nbsp;NOW()&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$current_primary_email_id&nbsp;AND&nbsp;asset_id_confirmed_for&nbsp;=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2340</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span>2341</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//other&nbsp;pending&nbsp;cofirmation&nbsp;codes&nbsp;sent&nbsp;to&nbsp;current&nbsp;primary&nbsp;email&nbsp;should&nbsp;become&nbsp;invalid</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2342</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;DELETE&nbsp;FROM&nbsp;email_confirmation&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$current_primary_email_id&nbsp;AND&nbsp;confirmation_time&nbsp;IS&nbsp;NULL&nbsp;AND&nbsp;asset_id_confirmed_for&nbsp;!=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2343</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2344</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account_email&nbsp;SET&nbsp;is_primary&nbsp;=&nbsp;0,&nbsp;login_enabled&nbsp;=&nbsp;0&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$current_primary_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2345</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2346</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query&nbsp;=&nbsp;&quot;UPDATE&nbsp;account_email&nbsp;SET&nbsp;is_primary&nbsp;=&nbsp;1,&nbsp;login_enabled&nbsp;=&nbsp;1&nbsp;WHERE&nbsp;email_id&nbsp;=&nbsp;$e_email_id&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2347</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::update($conn,&nbsp;$query);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2348</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2349</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2350</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$default_org_id&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2351</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old_signed_badge&nbsp;=&nbsp;Badge::find_by_uvs_id($user-&gt;get_uvs_id(),&nbsp;$default_org_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2352</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($old_signed_badge[0])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2353</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;build_default_user_badge($user,&nbsp;$user-&gt;get_application_id(),&nbsp;$old_signed_badge[0]-&gt;get_id());</span></code></td></tr><tr><td class="coverageDetails"><span>2354</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2355</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2356</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO:&nbsp;add&nbsp;change&nbsp;primary&nbsp;email&nbsp;activity&nbsp;log</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2357</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::save_active_log($uvs_id,&nbsp;$to_email,&nbsp;ActiveLog::$EVENT_TYPE_EMAIL_CHANGE_PRIMARY,&nbsp;$from_email);</span></code></td></tr><tr><td class="coverageDetails"><span>2358</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2359</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2360</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2361</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2362</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;/**</span></code></td></tr><tr><td class="coverageDetails"><span>2363</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;*&nbsp;get&nbsp;user's&nbsp;different&nbsp;types&nbsp;of&nbsp;image</span></code></td></tr><tr><td class="coverageDetails"><span>2364</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;String&nbsp;$args</span></code></td></tr><tr><td class="coverageDetails"><span>2365</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span>2366</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;image($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2367</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2368</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2369</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2370</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($args[0])&nbsp;||&nbsp;!in_array($args[0],&nbsp;self::$s_img_type))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2371</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2372</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2373</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$image_type&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2374</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2375</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2376</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2377</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2378</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2379</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2380</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($image_type&nbsp;==&nbsp;'profile')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2381</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;profile_photo_url&nbsp;=&nbsp;$user-&gt;get_profile_photo();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2382</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if($image_type&nbsp;==&nbsp;'initials')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2383</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;initials_url&nbsp;=&nbsp;$user-&gt;get_initials_img();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2384</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if($image_type&nbsp;==&nbsp;'signature')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2385</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;signature_url&nbsp;=&nbsp;$user-&gt;get_signature_img();</span></code></td></tr><tr><td class="coverageDetails"><span>2386</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2387</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2388</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2389</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2390</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;update_image($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2391</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2392</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>2393</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2394</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2395</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2396</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($args[0])&nbsp;||&nbsp;!in_array($args[0],&nbsp;self::$s_img_type))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2397</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2398</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2399</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$image_type&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span>2400</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2401</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;validate_image($_FILES[&quot;account_image&quot;][&quot;name&quot;],&nbsp;$_FILES[&quot;account_image&quot;][&quot;type&quot;],&nbsp;$_FILES['account_image']['tmp_name']);</span></code></td></tr><tr><td class="coverageDetails"><span>2402</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2403</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($_FILES[&quot;account_image&quot;][&quot;error&quot;]&nbsp;&gt;&nbsp;0)</span></code></td></tr><tr><td class="coverageDetails"><span>2404</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2405</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;TODO:&nbsp;Log&nbsp;the&nbsp;error&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2406</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2407</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2408</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2409</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2410</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2411</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2412</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2413</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2414</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2415</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2416</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$_FILES[&quot;account_image&quot;][&quot;name&quot;]));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2417</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;=&nbsp;self::get_file_relative_path()&nbsp;&nbsp;.&nbsp;$uvs_id&nbsp;.&nbsp;&quot;_&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2418</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($image_type&nbsp;==&nbsp;'profile')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2419</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;.=&nbsp;&quot;profile_&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2420</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;($image_type&nbsp;==&nbsp;'initials')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2421</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;.=&nbsp;&quot;initials_&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2422</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;elseif&nbsp;($image_type&nbsp;==&nbsp;'signature')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2423</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;.=&nbsp;&quot;signature_&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2424</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2425</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2426</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2427</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$photo&nbsp;=&nbsp;file_get_contents($_FILES[&quot;account_image&quot;][&quot;tmp_name&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span>2428</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2429</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($photo)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2430</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$checksum&nbsp;=&nbsp;md5($photo);</span></code></td></tr><tr><td class="coverageDetails"><span>2431</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2432</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;upload&nbsp;file');&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2433</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2434</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2435</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;=&nbsp;$dest&nbsp;.&nbsp;$checksum&nbsp;.&nbsp;'.'&nbsp;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span>2436</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2437</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;User::store_image($uvs_id,&nbsp;$image_type,&nbsp;$_FILES[&quot;account_image&quot;][&quot;tmp_name&quot;],&nbsp;$dest);</span></code></td></tr><tr><td class="coverageDetails"><span>2438</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2439</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(false&nbsp;==&nbsp;$result)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2440</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;TODO:&nbsp;Log&nbsp;the&nbsp;error&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2441</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2442</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2443</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2444</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(substr($dest,&nbsp;0,&nbsp;4)&nbsp;!=&nbsp;'http'&nbsp;&amp;&amp;&nbsp;substr($dest,&nbsp;0,&nbsp;1)&nbsp;!=&nbsp;'/')</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2445</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dest&nbsp;=&nbsp;'/'.$dest;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2446</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($image_type&nbsp;==&nbsp;'profile')&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;$response-&gt;profile_photo_url&nbsp;=&nbsp;$dest;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2447</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elseif&nbsp;($image_type&nbsp;==&nbsp;'initials')&nbsp;&nbsp;{&nbsp;$response-&gt;initials_url&nbsp;=&nbsp;$dest;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2448</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elseif&nbsp;($image_type&nbsp;==&nbsp;'signature')&nbsp;{&nbsp;$response-&gt;signature_url&nbsp;=&nbsp;$dest;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2449</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2450</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2451</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2452</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2453</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2454</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;set_badges_order($args){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2455</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2456</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>2457</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2458</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2459</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>2460</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2461</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Get&nbsp;UvsID&nbsp;by&nbsp;uvs_access_token</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2462</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2463</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2464</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2465</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2466</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>2467</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Save&nbsp;to&nbsp;badge_order</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2468</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$s_input&nbsp;=&nbsp;$this-&gt;request-&gt;get_input();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2469</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$s_input);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2470</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($input-&gt;badges_order))</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2471</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badges_order&nbsp;=&nbsp;$input-&gt;badges_order;</span></code></td></tr><tr><td class="coverageDetails"><span>2472</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Only&nbsp;to&nbsp;check&nbsp;whether&nbsp;is&nbsp;a&nbsp;int&nbsp;array</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2473</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($badges_order))</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2474</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException(&quot;Invalid&nbsp;badge&nbsp;orders&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2475</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null(is_num_string))</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2476</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException(&quot;Invalid&nbsp;badge&nbsp;orders&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2477</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2478</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;Badge::set_badges_order($uvs_id,&nbsp;$badges_order);</span></code></td></tr><tr><td class="coverageDetails"><span>2479</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2480</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2481</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2482</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2483</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2484</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2485</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;is_num_string($string){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2486</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($string))&nbsp;return&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2487</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$array&nbsp;=&nbsp;explode(&quot;,&quot;,&nbsp;$string);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2488</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($array&nbsp;as&nbsp;$item){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2489</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_numeric($item))</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2490</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span></code></td></tr><tr><td class="coverageDetails"><span>2491</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2492</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span>2493</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2494</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>2495</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2496</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2497</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;validate_image($image_name,&nbsp;$image_type,&nbsp;$image_path)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2498</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$allowed_img_exts&nbsp;=&nbsp;&quot;/^(jpg|png|gif|bmp)$/i&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2499</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$image_name));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2500</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$ext&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2501</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(($image_type&nbsp;==&nbsp;&quot;image/jpeg&quot;&nbsp;||&nbsp;$image_type&nbsp;==&nbsp;&quot;image/pjpeg&quot;&nbsp;||&nbsp;$image_type&nbsp;==&nbsp;&quot;image/jpg&quot;)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">+2502</span></td><td class="coverageDetails"><span class="codeExecuted">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;preg_match($allowed_img_exts,&nbsp;$extension))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2503</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ext&nbsp;=&nbsp;'jpeg';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2504</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(stripos($image_type,&nbsp;&quot;png&quot;)&nbsp;&amp;&amp;&nbsp;preg_match($allowed_img_exts,&nbsp;$extension)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2505</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ext&nbsp;=&nbsp;'png';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2506</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(stripos($image_type,&nbsp;&quot;gif&quot;)&nbsp;&amp;&amp;&nbsp;preg_match($allowed_img_exts,&nbsp;$extension)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2507</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ext&nbsp;=&nbsp;'gif';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2508</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if&nbsp;($image_type&nbsp;===&nbsp;&quot;image/bmp&quot;&nbsp;&amp;&amp;&nbsp;preg_match($allowed_img_exts,&nbsp;$extension)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2509</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ext&nbsp;=&nbsp;'bmp';</span></code></td></tr><tr><td class="coverageDetails"><span>2510</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span>2511</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Invalid&nbsp;image&nbsp;*/</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2512</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Image&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2513</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2514</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2515</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//check&nbsp;the&nbsp;version&nbsp;to&nbsp;guarantee&nbsp;the&nbsp;backward&nbsp;compatibility</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2516</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(Util::is_new_client($_GET[&quot;rev&quot;]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2517</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//check&nbsp;the&nbsp;file's&nbsp;file&nbsp;header</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2518</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!Util::check_file_format($image_path,&nbsp;$ext))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2519</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Image&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2520</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2521</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2522</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span>2523</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2524</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2525</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;sort_badges($uvs_id,&nbsp;$response,&nbsp;$new_added&nbsp;=&nbsp;FALSE){&nbsp;&nbsp;//$new_added&nbsp;is&nbsp;used&nbsp;for&nbsp;the&nbsp;scenario&nbsp;'add&nbsp;a&nbsp;badge'</span></code></td></tr><tr><td class="coverageDetails"><span>2526</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Get&nbsp;Badge&nbsp;Order</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2527</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badges_order&nbsp;=&nbsp;Badge::get_badges_order($uvs_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2528</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$display_index&nbsp;=&nbsp;1;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2529</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_null($badges_order))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2530</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($i&nbsp;=&nbsp;0;&nbsp;$i&nbsp;&lt;&nbsp;count($response);&nbsp;$i++)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2531</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[$i]-&gt;display_index&nbsp;=&nbsp;$display_index;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2532</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$display_index++;</span></code></td></tr><tr><td class="coverageDetails"><span>2533</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2534</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2535</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2536</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($new_added)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2537</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeids&nbsp;=&nbsp;array_map(&nbsp;'intval',&nbsp;explode(&quot;,&quot;,&nbsp;$badges_order)&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2538</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($i&nbsp;=&nbsp;0;&nbsp;$i&nbsp;&lt;&nbsp;count($response);&nbsp;$i++)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2539</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;array_search($response[$i]-&gt;id,&nbsp;$badgeids);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2540</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response[$i]-&gt;display_index&nbsp;=&nbsp;($key&nbsp;!==&nbsp;FALSE)&nbsp;?&nbsp;$key&nbsp;+&nbsp;1&nbsp;:&nbsp;1;</span></code></td></tr><tr><td class="coverageDetails"><span>2541</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2542</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2543</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2544</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badges_order&nbsp;=&nbsp;&quot;1,2,3,4,5,6,7,8,9&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2545</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badgeids&nbsp;=&nbsp;explode(&quot;,&quot;,&nbsp;$badges_order);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2546</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$map_badges&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2547</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$tgt_response&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2548</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$lost_badges&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2549</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(is_array($badgeids)&nbsp;&amp;&amp;&nbsp;is_array($response)){</span></code></td></tr><tr><td class="coverageDetails"><span>2550</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Add&nbsp;to&nbsp;a&nbsp;map</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2551</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($response&nbsp;as&nbsp;$item){</span></code></td></tr><tr><td class="coverageDetails"><span>2552</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//default&nbsp;User&nbsp;ID&nbsp;badge&nbsp;is&nbsp;always&nbsp;the&nbsp;first&nbsp;one</span></code></td></tr><tr><td class="coverageDetails"><span>2553</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span></code></td></tr><tr><td class="coverageDetails"><span>2554</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($item-&gt;id)&nbsp;&amp;&amp;&nbsp;$item-&gt;orgid&nbsp;==&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;])&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2555</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;display_index&nbsp;=&nbsp;$display_index;</span></code></td></tr><tr><td class="coverageDetails"><span>2556</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$display_index&nbsp;++;</span></code></td></tr><tr><td class="coverageDetails"><span>2557</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tgt_response[]&nbsp;=&nbsp;$item;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2558</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else*/if&nbsp;(isset($item-&gt;id)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2559</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$map_badges[$item-&gt;id]&nbsp;=&nbsp;$item;</span></code></td></tr><tr><td class="coverageDetails"><span>2560</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2561</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$lost_badges[]&nbsp;=&nbsp;$item;</span></code></td></tr><tr><td class="coverageDetails"><span>2562</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2563</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2564</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//First&nbsp;add&nbsp;those&nbsp;in&nbsp;badges_order</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2565</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($badgeids&nbsp;as&nbsp;$badgeid){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2566</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$trim_badgeid&nbsp;=&nbsp;trim($badgeid);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2567</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($map_badges[$trim_badgeid])){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2568</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$map_badges[$trim_badgeid]-&gt;display_index&nbsp;=&nbsp;$display_index;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2569</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$display_index&nbsp;++;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2570</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tgt_response[]&nbsp;=&nbsp;$map_badges[$trim_badgeid];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2571</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$map_badges[$trim_badgeid]&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span>2572</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2573</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2574</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Add&nbsp;those&nbsp;not&nbsp;list&nbsp;in&nbsp;badges_orders</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2575</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$the_badges&nbsp;=&nbsp;array_values($map_badges);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2576</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($the_badges&nbsp;as&nbsp;$item){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2577</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($item)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2578</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;display_index&nbsp;=&nbsp;$display_index;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2579</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$display_index&nbsp;++;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2580</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tgt_response[]&nbsp;=&nbsp;$item;</span></code></td></tr><tr><td class="coverageDetails"><span>2581</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2582</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2583</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Add&nbsp;lost&nbsp;badges</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2584</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($lost_badges&nbsp;as&nbsp;$item){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2585</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$item-&gt;display_index&nbsp;=&nbsp;$display_index;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2586</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$display_index&nbsp;++;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2587</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tgt_response[]&nbsp;=&nbsp;$item;</span></code></td></tr><tr><td class="coverageDetails"><span>2588</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2589</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tgt_response;</span></code></td></tr><tr><td class="coverageDetails"><span>2590</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2591</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$tgt_response;</span></code></td></tr><tr><td class="coverageDetails"><span>2592</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2593</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2594</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//this&nbsp;function&nbsp;is&nbsp;used&nbsp;for&nbsp;building&nbsp;a&nbsp;default&nbsp;usherpro&nbsp;user&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span>2595</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;build_default_user_badge($user,&nbsp;$application_id,&nbsp;$old_badge_id&nbsp;=&nbsp;NULL)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2596</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$is_new_badge&nbsp;=&nbsp;$old_badge_id&nbsp;?&nbsp;FALSE:&nbsp;TRUE;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2597</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2598</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2599</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span>2600</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//build&nbsp;up&nbsp;$badgeinfo</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2601</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_first_name()&nbsp;.&nbsp;'&nbsp;'&nbsp;.&nbsp;$user-&gt;get_last_name();</span></code></td></tr><tr><td class="coverageDetails"><span>2602</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$badgeinfo-&gt;title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2603</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;group&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2604</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;orgname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;orgname&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2605</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;expiration&nbsp;&nbsp;=&nbsp;time()&nbsp;+&nbsp;Glob::$default_badge_settings[&quot;expiration&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2606</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;cache_until&nbsp;=&nbsp;time()&nbsp;+&nbsp;Glob::$default_badge_settings[&quot;cache_time&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2607</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($profile_photo_url&nbsp;=&nbsp;$user-&gt;get_profile_photo())&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2608</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;desc&nbsp;=&nbsp;&quot;taken&nbsp;at&nbsp;Jan.&nbsp;31,&nbsp;2012&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2609</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;type&nbsp;=&nbsp;&quot;image/jpg&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2610</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_partial_url&nbsp;=&nbsp;strncasecmp($profile_photo_url,&nbsp;'http',&nbsp;strlen('http'));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2611</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$is_partial_url)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2612</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;reference&nbsp;=&nbsp;$profile_photo_url;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2613</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if(isset($_SERVER['HTTPS']))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2614</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;reference&nbsp;=&nbsp;&quot;https://&quot;.$_SERVER[&quot;HTTP_HOST&quot;].&quot;/&quot;.$profile_photo_url;</span></code></td></tr><tr><td class="coverageDetails"><span>2615</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2616</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;reference&nbsp;=&nbsp;&quot;http://&quot;.$_SERVER[&quot;HTTP_HOST&quot;].&quot;/&quot;.$profile_photo_url;</span></code></td></tr><tr><td class="coverageDetails"><span>2617</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2618</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2619</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>2620</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2621</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2622</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//build&nbsp;$badgeinfo_for_sign</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2623</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if(!$old_badge_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2624</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Badge::id_generator();&nbsp;//badge_id,&nbsp;need&nbsp;to&nbsp;be&nbsp;generated</span></code></td></tr><tr><td class="coverageDetails"><span>2625</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2626</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge_id;</span></code></td></tr><tr><td class="coverageDetails"><span>2627</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2628</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;orgid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Glob::$default_badge_settings[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2629</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;appid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$application_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2630</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;badgeinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$badgeinfo;</span></code></td></tr><tr><td class="coverageDetails"><span>2631</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2632</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&quot;Primary&nbsp;Email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2633</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;desc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&quot;&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2634</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&quot;string&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2635</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$user-&gt;get_primary_email();</span></code></td></tr><tr><td class="coverageDetails"><span>2636</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2637</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//create&nbsp;signed_badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2638</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$format&nbsp;=&nbsp;json_decode(Glob::$default_badge_settings[&quot;format&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2639</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::create($user-&gt;get_uvs_id(),&nbsp;$badgeinfo_for_sign,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL,&nbsp;$format,&nbsp;$badgeinfo_additional,&nbsp;$is_new_badge);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2640</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;if($badge&nbsp;&amp;&amp;&nbsp;$is_new_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2641</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;to&nbsp;'badge&nbsp;order'</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2642</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::add_into_badges_order($user-&gt;get_uvs_id(),&nbsp;$badgeinfo_for_sign-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>2643</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">2644</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge;</span></code></td></tr><tr><td class="coverageDetails"><span>2645</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2646</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2647</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//this&nbsp;function&nbsp;is&nbsp;used&nbsp;for&nbsp;building&nbsp;a&nbsp;facebook&nbsp;badge</span></code></td></tr><tr><td class="coverageDetails"><span>2648</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;build_facebook_user_badge($uvs_id,&nbsp;$fb_user_info,&nbsp;$application_id,&nbsp;$old_badge_id&nbsp;=&nbsp;NULL)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2649</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_new_badge&nbsp;=&nbsp;$old_badge_id&nbsp;?&nbsp;FALSE:&nbsp;TRUE;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2650</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2651</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2652</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span>2653</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//build&nbsp;up&nbsp;$badgeinfo</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2654</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$fb_user_info-&gt;first_name&nbsp;.&nbsp;'&nbsp;'&nbsp;.&nbsp;$fb_user_info-&gt;last_name;</span></code></td></tr><tr><td class="coverageDetails"><span>2655</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$badgeinfo-&gt;title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2656</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;group&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Glob::$facebook_badge_settings[&quot;group&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2657</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;orgname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Glob::$facebook_badge_settings[&quot;orgname&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2658</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;expiration&nbsp;&nbsp;=&nbsp;time()&nbsp;+&nbsp;Glob::$facebook_badge_settings[&quot;expiration&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2659</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;cache_until&nbsp;=&nbsp;time()&nbsp;+&nbsp;Glob::$facebook_badge_settings[&quot;cache_time&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2660</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($fb_user_info-&gt;facebook_photo_url)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2661</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;desc&nbsp;=&nbsp;&quot;taken&nbsp;at&nbsp;Jan.&nbsp;31,&nbsp;2012&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2662</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;type&nbsp;=&nbsp;&quot;image/jpg&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2663</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($_SERVER['HTTPS']))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2664</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;reference&nbsp;=&nbsp;&quot;https://&quot;.$_SERVER[&quot;HTTP_HOST&quot;].&quot;/&quot;.$fb_user_info-&gt;facebook_photo_url;</span></code></td></tr><tr><td class="coverageDetails"><span>2665</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2666</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo-&gt;reference&nbsp;=&nbsp;&quot;http://&quot;.$_SERVER[&quot;HTTP_HOST&quot;].&quot;/&quot;.$fb_user_info-&gt;facebook_photo_url;</span></code></td></tr><tr><td class="coverageDetails"><span>2667</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2668</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2669</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo-&gt;photo&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>2670</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2671</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2672</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//build&nbsp;$badgeinfo_for_sign</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2673</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$old_badge_id)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2674</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Badge::id_generator();&nbsp;//badge_id,&nbsp;need&nbsp;to&nbsp;be&nbsp;generated</span></code></td></tr><tr><td class="coverageDetails"><span>2675</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2676</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$old_badge_id;</span></code></td></tr><tr><td class="coverageDetails"><span>2677</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2678</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;orgid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Glob::$facebook_badge_settings[&quot;orgid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2679</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;appid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$application_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2680</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_for_sign-&gt;badgeinfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$badgeinfo;</span></code></td></tr><tr><td class="coverageDetails"><span>2681</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2682</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&quot;Primary&nbsp;Email&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2683</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;desc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&quot;&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2684</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;&quot;string&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2685</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badgeinfo_additional[0]-&gt;value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;$fb_user_info-&gt;email;</span></code></td></tr><tr><td class="coverageDetails"><span>2686</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>2687</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//create&nbsp;signed_badge</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2688</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$format&nbsp;=&nbsp;json_decode(Glob::$facebook_badge_settings[&quot;format&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2689</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$badge&nbsp;=&nbsp;Badge::create($uvs_id,&nbsp;$badgeinfo_for_sign,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL,&nbsp;$format,&nbsp;$badgeinfo_additional,&nbsp;$is_new_badge);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2690</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($badge&nbsp;&amp;&amp;&nbsp;$is_new_badge)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>2691</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//add&nbsp;to&nbsp;'badge&nbsp;order'</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2692</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Badge::add_into_badges_order($uvs_id,&nbsp;$badgeinfo_for_sign-&gt;id);</span></code></td></tr><tr><td class="coverageDetails"><span>2693</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2694</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$badge;</span></code></td></tr><tr><td class="coverageDetails"><span>2695</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2696</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2697</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;record_location($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2698</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2699</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>2700</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2701</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2702</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2703</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$longitude&nbsp;=&nbsp;$_GET[&quot;lon&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2704</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$latitude&nbsp;=&nbsp;$_GET[&quot;lat&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2705</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input());</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2706</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$points&nbsp;=&nbsp;$input-&gt;points;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2707</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($points))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2708</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Post&nbsp;parameter&nbsp;format&nbsp;is&nbsp;wrong');</span></code></td></tr><tr><td class="coverageDetails"><span>2709</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2710</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//Get&nbsp;UvsID&nbsp;by&nbsp;uvs_access_token</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2711</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token,&nbsp;false,&nbsp;false,&nbsp;NULL,&nbsp;true);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2712</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2713</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2714</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2715</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach($points&nbsp;as&nbsp;$point)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2716</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;$user-&gt;record_location($point-&gt;longitude,&nbsp;$point-&gt;latitude,&nbsp;$point-&gt;time);</span></code></td></tr><tr><td class="coverageDetails"><span>2717</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2718</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2719</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($success)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2720</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2721</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2722</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2723</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2724</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2725</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2726</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2727</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;punch_in($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2728</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2729</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2730</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2731</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2732</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2733</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($badge_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2734</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;badge&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2735</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2736</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2737</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2738</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$longitude&nbsp;=&nbsp;$_GET[&quot;lon&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2739</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$latitude&nbsp;=&nbsp;$_GET[&quot;lat&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2740</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_numeric($longitude))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2741</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Wrong&nbsp;format&nbsp;of&nbsp;longituide');</span></code></td></tr><tr><td class="coverageDetails"><span>2742</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2743</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_numeric($latitude))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2744</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Wrong&nbsp;format&nbsp;of&nbsp;latitude');</span></code></td></tr><tr><td class="coverageDetails"><span>2745</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2746</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2747</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2748</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2749</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2750</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user-&gt;hasBadge($badge_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2751</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerPemissionDeniedException(&quot;You&nbsp;are&nbsp;not&nbsp;the&nbsp;owner&nbsp;of&nbsp;this&nbsp;badge&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2752</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2753</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2754</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;$user-&gt;punch_in($badge_id,&nbsp;$longitude,&nbsp;$latitude);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2755</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2756</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($success)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2757</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2758</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2759</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2760</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2761</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2762</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2763</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2764</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2765</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;punch_out($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2766</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2767</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2768</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2769</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2770</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2771</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($badge_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2772</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;badge&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2773</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2774</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2775</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2776</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$longitude&nbsp;=&nbsp;$_GET[&quot;lon&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2777</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$latitude&nbsp;=&nbsp;$_GET[&quot;lat&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2778</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_numeric($longitude))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2779</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Wrong&nbsp;format&nbsp;of&nbsp;longituide');</span></code></td></tr><tr><td class="coverageDetails"><span>2780</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2781</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!is_numeric($latitude))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2782</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Wrong&nbsp;format&nbsp;of&nbsp;latitude');</span></code></td></tr><tr><td class="coverageDetails"><span>2783</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2784</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2785</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2786</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2787</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2788</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user-&gt;hasBadge($badge_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2789</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerPemissionDeniedException(&quot;You&nbsp;are&nbsp;not&nbsp;the&nbsp;owner&nbsp;of&nbsp;this&nbsp;badge&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2790</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2791</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$success&nbsp;=&nbsp;$user-&gt;punch_out($badge_id,&nbsp;$longitude,&nbsp;$latitude);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2792</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2793</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($success)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2794</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2795</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2796</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;error&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2797</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2798</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2799</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2800</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2801</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2802</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_punch_status($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2803</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2804</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2805</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2806</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2807</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$badge_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2808</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($badge_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2809</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Missing&nbsp;badge&nbsp;id');</span></code></td></tr><tr><td class="coverageDetails"><span>2810</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2811</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2812</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2813</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2814</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2815</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2816</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2817</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user-&gt;hasBadge($badge_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2818</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerPemissionDeniedException(&quot;You&nbsp;are&nbsp;not&nbsp;the&nbsp;owner&nbsp;of&nbsp;this&nbsp;badge&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>2819</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2820</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2821</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$status&nbsp;=&nbsp;$user-&gt;get_punch_status($badge_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2822</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2823</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;punch_status&nbsp;=&nbsp;$status;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2824</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2825</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2826</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2827</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;retrieve_events($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2828</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2829</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2830</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2831</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2832</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$rev&nbsp;=&nbsp;$_GET[&quot;rev&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2833</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$is_v12&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2834</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($rev)&nbsp;&amp;&amp;&nbsp;strlen($rev)&nbsp;&gt;=&nbsp;2&nbsp;&amp;&amp;&nbsp;substr($rev,&nbsp;0,&nbsp;2)&nbsp;==&nbsp;'12')</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2835</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_v12&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2836</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$rev&nbsp;=&nbsp;$_GET[&quot;v&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2837</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($rev)&nbsp;and&nbsp;$rev&nbsp;==&nbsp;'1.2')</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2838</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_v12&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2839</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$event_types&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2840</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($is_v12)</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2841</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event_types&nbsp;=&nbsp;Activelog::$ARRAY_EVENT_TYPE_V12;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2842</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$all_types&nbsp;=&nbsp;$_GET[&quot;all_types&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2843</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($all_types)&nbsp;and&nbsp;$all_types&nbsp;==&nbsp;'1')</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2844</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event_types&nbsp;=&nbsp;null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2845</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($all_types)&nbsp;and&nbsp;$all_types&nbsp;==&nbsp;'0')</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2846</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event_types&nbsp;=&nbsp;Activelog::$ARRAY_EVENT_TYPE_V12;</span></code></td></tr><tr><td class="coverageDetails"><span>2847</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2848</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$last_eid&nbsp;&nbsp;=&nbsp;$_GET[&quot;last_eid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2849</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$num_events&nbsp;&nbsp;=&nbsp;$_GET[&quot;num_events&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2850</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2851</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($last_eid))&nbsp;$last_eid&nbsp;=&nbsp;0;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2852</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($num_events))&nbsp;$num_events&nbsp;=&nbsp;0;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2853</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($num_events&lt;1)&nbsp;$num_events&nbsp;=&nbsp;0;</span></code></td></tr><tr><td class="coverageDetails"><span>2854</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2855</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2856</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2857</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2858</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2859</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2860</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$events&nbsp;=&nbsp;User::get_events($uvs_id,&nbsp;$last_eid,&nbsp;$num_events,&nbsp;$event_types);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2861</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($events&nbsp;as&nbsp;&amp;$event){</span></code></td></tr><tr><td class="coverageDetails"><span>2862</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_dump($event);&nbsp;exit();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2863</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$params&nbsp;=&nbsp;json_decode($event[&quot;parameters&quot;]);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2864</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($params){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2865</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$event[&quot;parameters&quot;]=$params;</span></code></td></tr><tr><td class="coverageDetails"><span>2866</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2867</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2868</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2869</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$events;</span></code></td></tr><tr><td class="coverageDetails"><span>2870</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2871</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2872</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;delete_all_events($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2873</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2874</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2875</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2876</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2877</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$last_eid&nbsp;&nbsp;=&nbsp;$_GET[&quot;last_eid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2878</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>2879</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2880</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2881</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2882</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2883</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2884</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>2885</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2886</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2887</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$rc&nbsp;=&nbsp;User::delete_events($uvs_id,&nbsp;$last_eid,&nbsp;$num_events);</span></code></td></tr><tr><td class="coverageDetails"><span>2888</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2889</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(1&nbsp;==&nbsp;$rc)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2890</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;SUCCESS&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2891</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2892</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ERROR&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2893</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2894</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2895</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2896</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2897</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2898</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;mark_all_events_read($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2899</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2900</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>2901</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2902</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2903</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$last_eid&nbsp;&nbsp;=&nbsp;$_GET[&quot;last_eid&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2904</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>2905</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2906</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2907</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2908</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2909</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2910</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>2911</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2912</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2913</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$rc&nbsp;=&nbsp;User::mark_all_events_read($uvs_id,&nbsp;$last_eid);</span></code></td></tr><tr><td class="coverageDetails"><span>2914</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2915</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(1&nbsp;==&nbsp;$rc)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2916</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;SUCCESS&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2917</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2918</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ERROR&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2919</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2920</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2921</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2922</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2923</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2924</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;mark_events_read($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2925</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'POST')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2926</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;POST');</span></code></td></tr><tr><td class="coverageDetails"><span>2927</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2928</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2929</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$input&nbsp;=&nbsp;json_decode(&nbsp;$this-&gt;request-&gt;get_input()&nbsp;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2930</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2931</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$eids&nbsp;=&nbsp;$input-&gt;eids;</span></code></td></tr><tr><td class="coverageDetails"><span>2932</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2933</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2934</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2935</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2936</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2937</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>2938</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2939</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdclass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2940</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$rc&nbsp;=&nbsp;User::mark_events_read($uvs_id,&nbsp;$eids);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2941</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(1&nbsp;==&nbsp;$rc)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2942</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;SUCCESS&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2943</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2944</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ERROR&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2945</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2946</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2947</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2948</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2949</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2950</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;save_device_token($args){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2951</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2952</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2953</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2954</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2955</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2956</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2957</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$post_data&nbsp;=&nbsp;$this-&gt;request-&gt;get_input();</span></code></td></tr><tr><td class="coverageDetails"><span>2958</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$post_data&nbsp;=&nbsp;'{&quot;device_id&quot;:&quot;asdf&quot;,&quot;device_type&quot;:&quot;2&quot;,&quot;device_token&quot;:{&quot;registry_id&quot;:&quot;APA91bFkZIGEY4jdk3xGzkPbDhpDHBFVltjwSZaEfz6SaOoKzFtgdBCGs6P87blybS-TsEI2rlln_UwNp_Laj06fhXE9Zg6ymgP5k2hrhyyHIrzEi4LOZJqNGQlOpnYDNS58PHT4fp6H&quot;}}';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2959</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2960</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$object&nbsp;=&nbsp;json_decode($post_data);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2961</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_id&nbsp;=&nbsp;$object-&gt;device_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2962</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_type&nbsp;=&nbsp;$object-&gt;device_type;&nbsp;//1&nbsp;ios,&nbsp;2&nbsp;android,&nbsp;3&nbsp;blackberry</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2963</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($device_type&nbsp;==&nbsp;&quot;1&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span>2964</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Note:&nbsp;change&nbsp;to&nbsp;Hex</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2965</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device_token&nbsp;=&nbsp;isset($object-&gt;device_token-&gt;apns_token)?bin2hex(base64_decode($object-&gt;device_token-&gt;apns_token)):null;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2966</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}elseif($device_type&nbsp;==&nbsp;&quot;2&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2967</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device_token&nbsp;=&nbsp;$object-&gt;device_token-&gt;registry_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2968</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}elseif($device_type&nbsp;==&nbsp;&quot;3&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2969</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$device_token&nbsp;=&nbsp;&quot;&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2970</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;NOT&nbsp;support&nbsp;blackberry&nbsp;for&nbsp;now.&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2971</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2972</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2973</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerWrongDeviceTypeException('Please&nbsp;post&nbsp;a&nbsp;valid&nbsp;device&nbsp;type.');</span></code></td></tr><tr><td class="coverageDetails"><span>2974</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2975</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($device_token)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2976</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerUnmathchDeviceTypeAndTokenException('The&nbsp;device&nbsp;type&nbsp;and&nbsp;token&nbsp;you&nbsp;post&nbsp;do&nbsp;NOT&nbsp;match.');</span></code></td></tr><tr><td class="coverageDetails"><span>2977</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2978</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;User::save_device_token($uvs_id,&nbsp;$device_id,&nbsp;$device_type,&nbsp;$device_token);</span></code></td></tr><tr><td class="coverageDetails"><span>2979</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2980</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($result){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2981</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2982</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2983</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;insert&nbsp;fail&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>2984</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2985</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>2986</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>2987</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>2988</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;remove_device_token($args){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2989</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2990</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2991</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2992</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>2993</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2994</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>2995</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2996</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$post_data&nbsp;=&nbsp;$this-&gt;request-&gt;get_input();</span></code></td></tr><tr><td class="coverageDetails"><span>2997</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$post_data&nbsp;=&nbsp;'{&quot;device_id&quot;:&quot;asdf&quot;,&quot;device_type&quot;:&quot;2&quot;}';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2998</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$object&nbsp;=&nbsp;json_decode($post_data);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">2999</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_id&nbsp;=&nbsp;$object-&gt;device_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3000</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$device_type&nbsp;=&nbsp;$object-&gt;device_type;&nbsp;//1&nbsp;ios,&nbsp;2&nbsp;android,&nbsp;3&nbsp;blackberry</span></code></td></tr><tr><td class="coverageDetails"><span>3001</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3002</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!in_array($device_type,&nbsp;array(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;))){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3003</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerWrongDeviceTypeException('Please&nbsp;post&nbsp;a&nbsp;valid&nbsp;device&nbsp;type.');</span></code></td></tr><tr><td class="coverageDetails"><span>3004</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3005</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3006</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;User::remove_device_token($uvs_id,&nbsp;$device_id,&nbsp;$device_type);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3007</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3008</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($result){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3009</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3010</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3011</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;not&nbsp;exist&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3012</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3013</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>3014</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3015</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//&nbsp;used&nbsp;by&nbsp;Apns&nbsp;feedback&nbsp;service&nbsp;only</span></code></td></tr><tr><td class="coverageDetails"><span>3016</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;remove_apn_tokens()&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>3017</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//TODO&nbsp;check&nbsp;caller</span></code></td></tr><tr><td class="coverageDetails"><span>3018</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3019</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$post_data&nbsp;=&nbsp;file_get_contents('php://input');</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3020</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$post_data&nbsp;=&nbsp;$_POST[&quot;payload&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3021</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$post_data&nbsp;=&nbsp;json_decode($post_data);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3022</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($post_data))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3023</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerWrongDeviceTypeException('Please&nbsp;post&nbsp;a&nbsp;valid&nbsp;device&nbsp;type.');</span></code></td></tr><tr><td class="coverageDetails"><span>3024</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3025</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3026</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($post_data&nbsp;as&nbsp;$data)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3027</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$token&nbsp;=&nbsp;$data-&gt;token;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3028</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$timestamp&nbsp;=&nbsp;$data-&gt;lastRegister;</span></code></td></tr><tr><td class="coverageDetails"><span>3029</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3030</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User::remove_apns_tokens($token,&nbsp;$timestamp);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3031</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch(Exception&nbsp;$e)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>3032</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3033</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3034</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3035</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;'sucess';</span></code></td></tr><tr><td class="coverageDetails"><span>3036</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3037</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3038</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;admin_login($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3039</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;login($args);</span></code></td></tr><tr><td class="coverageDetails"><span>3040</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3041</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3042</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_image($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3043</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$allowed_types&nbsp;=&nbsp;array(&quot;profile&quot;,&nbsp;&quot;initial&quot;,&nbsp;&quot;signed&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3044</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3045</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3046</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3047</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>3048</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3049</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException(&quot;Sorry,&nbsp;you&nbsp;token&nbsp;is&nbsp;invalid&nbsp;or&nbsp;expired,&nbsp;please&nbsp;login&nbsp;again.&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3050</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3051</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$type&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3052</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!in_array($type,&nbsp;$allowed_types)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3053</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Sorry,&nbsp;only&nbsp;three&nbsp;types(&quot;profile&quot;,&nbsp;&quot;initial&quot;&nbsp;and&nbsp;&quot;signed&quot;)&nbsp;of&nbsp;images&nbsp;can&nbsp;be&nbsp;accepted.');</span></code></td></tr><tr><td class="coverageDetails"><span>3054</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3055</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($type&nbsp;==&nbsp;&quot;profile&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3056</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;$user-&gt;get_profile_photo();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3057</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}elseif($type&nbsp;==&nbsp;&quot;initial&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3058</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;$user-&gt;get_initials_img();</span></code></td></tr><tr><td class="coverageDetails"><span>3059</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3060</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;$user-&gt;get_signature_img();</span></code></td></tr><tr><td class="coverageDetails"><span>3061</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3062</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!empty($file_name)){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3063</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;end(explode(&quot;/&quot;,&nbsp;$file_name));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3064</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strncmp($file_name,&nbsp;&quot;photo_&quot;,&nbsp;strlen(&quot;photo_&quot;))&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;//badge&nbsp;photo</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3065</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$image_root&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_badge_photo&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3066</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3067</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$image_root&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_file_path&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3068</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3069</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_path&nbsp;=&nbsp;$image_root&nbsp;.&nbsp;$file_name;</span></code></td></tr><tr><td class="coverageDetails"><span>3070</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3071</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_path&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>3072</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3073</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3074</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!file_exists($file_path))</span></code></td></tr><tr><td class="coverageDetails"><span>3075</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3076</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;FileNotExistException('Sorry,&nbsp;the&nbsp;file&nbsp;you&nbsp;require&nbsp;does&nbsp;NOT&nbsp;exist!');</span></code></td></tr><tr><td class="coverageDetails"><span>3077</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3078</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//$file_size&nbsp;=&nbsp;filesize($file_path);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3079</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$file_name));</span></code></td></tr><tr><td class="coverageDetails"><span>3080</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3081</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;//decrypte&nbsp;the&nbsp;image</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3082</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($type&nbsp;==&nbsp;&quot;initial&quot;&nbsp;||&nbsp;$type&nbsp;==&nbsp;&quot;signed&quot;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>3083</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//decrypte&nbsp;the&nbsp;image</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3084</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$encrypted_data&nbsp;=&nbsp;file_get_contents($file_path);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3085</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body&nbsp;=&nbsp;Util::decrypt_data($encrypted_data);&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3086</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//$file_size&nbsp;=&nbsp;strlen($body);</span></code></td></tr><tr><td class="coverageDetails"><span>3087</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3088</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$body&nbsp;=&nbsp;file_get_contents($file_path);</span></code></td></tr><tr><td class="coverageDetails"><span>3089</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3090</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3091</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($extension&nbsp;==&nbsp;&quot;jpg&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3092</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content_type&nbsp;=&nbsp;&quot;image/jpeg&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3093</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3094</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content_type&nbsp;=&nbsp;&quot;image/&quot;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span>3095</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3096</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3097</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3098</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;content_type&nbsp;=&nbsp;$content_type;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3099</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;body&nbsp;=$body;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3100</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>3101</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3102</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3103</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3104</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_badge_photo($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3105</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3106</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>3107</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3108</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3109</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3110</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($file_name))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3111</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException(&quot;Missing&nbsp;file&nbsp;name&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3112</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3113</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3114</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;/*$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>3115</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span>3116</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span>3117</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>3118</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}*/</span></code></td></tr><tr><td class="coverageDetails"><span>3119</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3120</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$file_path&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_badge_photo&quot;)&nbsp;.&nbsp;$file_name;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3121</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!file_exists($file_path))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3122</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;FileNotExistException(&quot;Image&nbsp;photo&nbsp;does&nbsp;not&nbsp;exist!&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3123</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3124</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3125</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$file_name));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3126</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($extension&nbsp;==&nbsp;&quot;jpg&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3127</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content_type&nbsp;=&nbsp;&quot;image/jpeg&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3128</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3129</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content_type&nbsp;=&nbsp;&quot;image/&quot;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span>3130</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3131</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3132</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;content_type&nbsp;=&nbsp;$content_type;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3133</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;body&nbsp;=&nbsp;file_get_contents($file_path);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3134</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>3135</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3136</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3137</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_public_image($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3138</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3139</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>3140</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3141</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;$_GET[&quot;file_name&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>3142</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Cannot&nbsp;get&nbsp;initials,&nbsp;signature&nbsp;files&nbsp;from&nbsp;the&nbsp;API</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3143</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_initials&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3144</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_signature&nbsp;=&nbsp;false;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3145</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!(strpos($file_name,&nbsp;&quot;signature&quot;)===false))</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3146</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_signature&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3147</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!(strpos($file_name,&nbsp;&quot;initials&quot;)===false))</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3148</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$is_initials&nbsp;=&nbsp;true;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3149</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($is_signature&nbsp;||&nbsp;$is_initials){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3150</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerDocPemissionDeniedException(&quot;You&nbsp;don't&nbsp;have&nbsp;permission&nbsp;to&nbsp;access&nbsp;the&nbsp;file.&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3151</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3152</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3153</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($file_name))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3154</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException(&quot;Missing&nbsp;file&nbsp;name&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3155</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3156</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3157</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3158</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3159</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3160</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>3161</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3162</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3163</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!empty($file_name)){</span></code></td></tr><tr><td class="coverageDetails"><span>3164</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_name&nbsp;=&nbsp;end(explode(&quot;/&quot;,&nbsp;$file_name));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3165</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$image_root&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_file_path&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3166</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_path&nbsp;=&nbsp;$image_root&nbsp;.&nbsp;&quot;../&quot;&nbsp;.&nbsp;$file_name;</span></code></td></tr><tr><td class="coverageDetails"><span>3167</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3168</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_path&nbsp;=&nbsp;NULL;</span></code></td></tr><tr><td class="coverageDetails"><span>3169</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3170</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3171</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!file_exists($file_path))</span></code></td></tr><tr><td class="coverageDetails"><span>3172</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3173</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;FileNotExistException('Sorry,&nbsp;the&nbsp;file&nbsp;you&nbsp;require&nbsp;does&nbsp;NOT&nbsp;exist!');</span></code></td></tr><tr><td class="coverageDetails"><span>3174</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3175</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3176</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extension&nbsp;=&nbsp;end(explode(&quot;.&quot;,&nbsp;$file_name));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3177</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($extension&nbsp;==&nbsp;&quot;jpg&quot;){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3178</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content_type&nbsp;=&nbsp;&quot;image/jpeg&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3179</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3180</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content_type&nbsp;=&nbsp;&quot;image/&quot;.&nbsp;$extension;</span></code></td></tr><tr><td class="coverageDetails"><span>3181</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3182</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3183</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3184</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;content_type&nbsp;=&nbsp;$content_type;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3185</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;body&nbsp;=&nbsp;file_get_contents($file_path);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3186</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>3187</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3188</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3189</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;//Note:&nbsp;This&nbsp;is&nbsp;only&nbsp;for&nbsp;compatible&nbsp;with&nbsp;the&nbsp;user_image</span></code></td></tr><tr><td class="coverageDetails"><span>3190</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;private&nbsp;function&nbsp;get_file_relative_path(){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">3191</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$root_path&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_file_path&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">3192</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_path&nbsp;=&nbsp;substr($root_path,&nbsp;0,&nbsp;strlen($root_path)-1);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeExecuted">3193</span></td><td class="coverageDetails"><span class="codeExecuted">1</span></td><td class="coverageDetailsCode"><code><span class="codeExecuted">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;end(explode(&quot;/&quot;,&nbsp;$_path))&nbsp;.&nbsp;&quot;/&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3194</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3195</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3196</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;logger(){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3197</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3198</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;&quot;ok&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3199</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>3200</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3201</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3202</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;disable_ushercode($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3203</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;request-&gt;get_method()&nbsp;!=&nbsp;'GET')&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3204</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Must&nbsp;use&nbsp;GET');</span></code></td></tr><tr><td class="coverageDetails"><span>3205</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3206</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($args)&nbsp;||&nbsp;!isset($args[0])&nbsp;||&nbsp;!is_numeric($args[0]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3207</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Wrong&nbsp;Parameters');</span></code></td></tr><tr><td class="coverageDetails"><span>3208</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3209</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3210</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);//performance&nbsp;is&nbsp;poor</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3211</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3212</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>3213</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3214</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3215</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$code&nbsp;=&nbsp;(int)$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3216</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$ushercode&nbsp;=&nbsp;UsherCode::verify_code($code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3217</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($ushercode)&nbsp;||&nbsp;!$ushercode)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3218</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidCodeException(&quot;Invalid&nbsp;or&nbsp;Expired&nbsp;Usher&nbsp;Code.&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span>3219</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3220</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(!($uvs_id&nbsp;==&nbsp;$ushercode['uvs_id']))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3221</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerNoPermissionException('You&nbsp;are&nbsp;not&nbsp;the&nbsp;owner&nbsp;of&nbsp;this&nbsp;code');</span></code></td></tr><tr><td class="coverageDetails"><span>3222</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3223</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;=&nbsp;UsherCode::disable($code);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3224</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3225</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;if(isset($result)&nbsp;&amp;&amp;&nbsp;$result&nbsp;==&nbsp;TRUE)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3226</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;status&nbsp;=&nbsp;'ok';</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3227</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;throw&nbsp;new&nbsp;ControllerDatabaseUpdateException('Failed&nbsp;to&nbsp;disable&nbsp;this&nbsp;code,&nbsp;please&nbsp;try&nbsp;again.');</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3228</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span>3229</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3230</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3231</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;qr($args){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3232</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span>3233</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//verify&nbsp;user</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3234</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3235</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3236</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>3237</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3238</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;count($args)&nbsp;&lt;2){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3239</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;URL');</span></code></td></tr><tr><td class="coverageDetails"><span>3240</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3241</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$type&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3242</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$object_id&nbsp;=&nbsp;$args[1];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3243</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!is_numeric($object_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3244</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;Doc&nbsp;Id');</span></code></td></tr><tr><td class="coverageDetails"><span>3245</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3246</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3247</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$code_type&nbsp;=&nbsp;&quot;&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3248</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strcmp($type,'doc')&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3249</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!Doc::is_doc_owner($object_id,&nbsp;$uvs_id))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3250</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerOwnerDocPemissionDeniedException('you&nbsp;are&nbsp;not&nbsp;the&nbsp;doc&nbsp;owner');</span></code></td></tr><tr><td class="coverageDetails"><span>3251</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3252</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$code_type&nbsp;=&nbsp;&quot;D&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3253</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if(strcmp($type,&nbsp;&nbsp;&quot;key&quot;)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span>3254</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO:&nbsp;check&nbsp;whether&nbsp;it's&nbsp;the&nbsp;owner</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3255</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$code_type&nbsp;=&nbsp;&quot;K&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span>3256</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3257</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;Resource&nbsp;Type');</span></code></td></tr><tr><td class="coverageDetails"><span>3258</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3259</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$qr_str&nbsp;=&nbsp;$code_type&nbsp;.&nbsp;Util::id_encode($object_id);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3260</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;$_GET[&quot;return_string&quot;]&nbsp;)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3261</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Array(&quot;qr_string&quot;=&gt;$qr_str);</span></code></td></tr><tr><td class="coverageDetails"><span>3262</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3263</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mydir&nbsp;=&nbsp;dirname(__FILE__);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3264</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$qr_dir&nbsp;=&nbsp;realpath($mydir&nbsp;.&nbsp;'/../lib/usher_vendor/phpqrcode');</span></code></td></tr><tr><td class="coverageDetails"><span>3265</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;&quot;$qr_dir/phpqrcode.php&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3266</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QRcode::png($qr_str,false,&nbsp;QR_ECLEVEL_L,&nbsp;&nbsp;4,&nbsp;&nbsp;1,&nbsp;false);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3267</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();</span></code></td></tr><tr><td class="coverageDetails"><span>3268</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3269</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;</span></code></td></tr><tr><td class="coverageDetails"><span>3270</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;public&nbsp;function&nbsp;get_object($args)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3271</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;count($args)&nbsp;&lt;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3272</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;URL');</span></code></td></tr><tr><td class="coverageDetails"><span>3273</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3274</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$encoded_id&nbsp;=&nbsp;$args[0];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3275</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_access_token&nbsp;=&nbsp;$_GET[&quot;uvs_access_token&quot;];</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3276</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user&nbsp;=&nbsp;User::find_by_uvs_token($uvs_access_token);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3277</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$user)&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3278</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerInvalidTokenException('Invalid&nbsp;uvs&nbsp;access&nbsp;token');</span></code></td></tr><tr><td class="coverageDetails"><span>3279</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3280</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uvs_id&nbsp;=&nbsp;$user-&gt;get_uvs_id();</span></code></td></tr><tr><td class="coverageDetails"><span>3281</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Decode</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3282</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;$type&nbsp;=&nbsp;substr($encoded_id,&nbsp;0,&nbsp;1);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3283</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strcmp($type,&quot;D&quot;)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3284</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$doc_id&nbsp;=&nbsp;substr($encoded_id,&nbsp;1,&nbsp;strlen($encoded_id));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3285</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tags&nbsp;=&nbsp;array();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3286</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tags[0]&nbsp;=&nbsp;$doc_id;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3287</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tags[1]&nbsp;=&nbsp;&quot;encoded&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3288</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resp&nbsp;=&nbsp;Doc::get_doc($uvs_id,&nbsp;$tags);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3289</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!isset($resp[0]))&nbsp;{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3290</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerDocNotExistException('The&nbsp;file&nbsp;does&nbsp;not&nbsp;exist');</span></code></td></tr><tr><td class="coverageDetails"><span>3291</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3292</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signed_file_url&nbsp;=&nbsp;$resp[0]-&gt;signed_file_url;</span></code></td></tr><tr><td class="coverageDetails"><span>3293</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//for&nbsp;legacy&nbsp;docs&nbsp;record&nbsp;in&nbsp;db</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3294</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signed_file_url&nbsp;=&nbsp;end(explode(&quot;/&quot;,&nbsp;$signed_file_url));</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3295</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file_dir&nbsp;=&nbsp;Util::get_general_config(&quot;uvs_doc_path&quot;);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3296</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response&nbsp;=&nbsp;new&nbsp;stdClass();</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3297</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;body&nbsp;=&nbsp;$this-&gt;fetch_file($file_dir,&nbsp;$signed_file_url);</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3298</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;content_type&nbsp;=&nbsp;&quot;application/pdf&quot;;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3299</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$response;</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3300</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if(strcmp($type,&quot;K&quot;)&nbsp;==&nbsp;0){</span></code></td></tr><tr><td class="coverageDetails"><span>3301</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//TODO:&nbsp;Add&nbsp;Key&nbsp;Logic</span></code></td></tr><tr><td class="coverageDetails"><span>3302</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}else{</span></code></td></tr><tr><td class="coverageDetails"><span class="codeMissed">3303</span></td><td class="coverageDetails"><span class="codeMissed">&nbsp;</span></td><td class="coverageDetailsCode"><code><span class="codeMissed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;ControllerBadRequestException('Invalid&nbsp;Object');</span></code></td></tr><tr><td class="coverageDetails"><span>3304</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3305</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>&nbsp;&nbsp;}</span></code></td></tr><tr><td class="coverageDetails"><span>3306</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3307</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>}</span></code></td></tr><tr><td class="coverageDetails"><span>3308</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span></span></code></td></tr><tr><td class="coverageDetails"><span>3309</span></td><td class="coverageDetails"><span>&nbsp;</span></td><td class="coverageDetailsCode"><code><span>?&gt;</span></code></td></tr></table></td></tr>
  </table>

    </div>
  </body>
</html>
